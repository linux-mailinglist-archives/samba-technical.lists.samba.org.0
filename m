Return-Path: <samba-technical-bounces@lists.samba.org>
X-Original-To: lists+samba-technical@lfdr.de
Delivered-To: lists+samba-technical@lfdr.de
Received: from hr1.samba.org (hr1.samba.org [IPv6:2a01:4f8:192:486::1:0])
	by mail.lfdr.de (Postfix) with ESMTPS id 5FAB2A226F
	for <lists+samba-technical@lfdr.de>; Thu, 29 Aug 2019 19:37:47 +0200 (CEST)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
	d=lists.samba.org; s=2954282; h=From:List-Id:To:Subject:Date:cc;
	bh=IDdaI+GP+RQw0T5D9S2BJu6E6bF9HN7/ijcI15NRuzA=; b=IhWYGZ7Jjq9rdWoAZtc17K8W6Q
	txaQVDy+scjOpCVYeaDjZ9haA1RmpmpWpsvrgb/n0xA40rMm/vb1PFz2CRUI5WuozdeOCb3OO8CD5
	VGk1ec0+cpKKEgUpPTXGeOcyKK16fxmkCldpNXU0iPfXBZO1PWk6TqKXPGw6/OuOQURyC2pw+Wt0u
	LK635uxFhrI/U65eO5SGXPrqPiW6gDZhXp5be1HozbRyXUdMuCZzmABLDRjAKC+Nslmg4FF1vXntW
	7HHZy10qQJirusPU/tKZ1In6AUAkhvfH4pY7LLeJ/YKXvWEhkG10h+Q8OJYlDkn0N9NEAX2MAzCyd
	wPM7vd6w==;
Received: from localhost ([::1]:24932 helo=hr1.samba.org) 
	by hr1.samba.org with esmtp (Exim)
	id 1i3OMK-000Na1-37; Thu, 29 Aug 2019 17:37:20 +0000
Received: from mail-yb1-xb31.google.com ([2607:f8b0:4864:20::b31]:35987) 
 by hr1.samba.org with esmtps (TLS1.3:ECDHE_RSA_CHACHA20_POLY1305:256)
 (Exim) id 1i3OMD-000NZu-B3
 for samba-technical@lists.samba.org; Thu, 29 Aug 2019 17:37:17 +0000
Received: by mail-yb1-xb31.google.com with SMTP id m9so1480197ybm.3
 for <samba-technical@lists.samba.org>; Thu, 29 Aug 2019 10:37:12 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=ixsystems.com; s=google;
 h=mime-version:references:in-reply-to:from:date:message-id:subject:to;
 bh=MIATpxcbRbYgWueetBfd9wGkVE/m9LupkWEcOmlJMpw=;
 b=W7NGoKm31tKzH1UQfV26D8Rn6nW6Zweeg3rRtaGzqeHbOfAl0R/dVjTnIylD6YYh0o
 kyRF3TwN0v0U8BOuN2qqRsBLapx4m7mPf1rMG6BSjKUtbF8X6f/idUgYWkUIlIavjHdY
 q17dtr8j4Z4ki9g3Xodt36Cz+I60TYg+/286YhAy1D86mvnibxv6wfWQdgkpjNGiGFbD
 EnQG5KMhckuSb7Al7C3jmepNGVfHUWQUP1WN3wpU19uxkbsdUMx9MMGBhxo7z4F+DlGF
 ykg5BQNsAMWrUzE/LN94e+5XS8++zLUE8eUgyzOrW3cd6TK5ltpvOIsA7+ZU+nTgHJU0
 L2/A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:mime-version:references:in-reply-to:from:date
 :message-id:subject:to;
 bh=MIATpxcbRbYgWueetBfd9wGkVE/m9LupkWEcOmlJMpw=;
 b=K3dFQhdjb+ScadODVnGLEnKddoFPMPv/TQLAHx4s41HgSQz7J44Xx+dNoZX22wz6HD
 pyYlw5FCcfQ0RvE68gbdtKAA8ImHQ/VRMzhiHe8/DfkwoUnTMegaoacNp8735r6apHBX
 VvYMYe1iK8Q5kEQC/uAxEi1mveezcLCtPsMUXBh0wJIwWxyt/dGhNRu85gEscK4KZaKK
 VRiHAipDAc3b4TF3edZUNI8DqdmPoMhbHIUSiAFTuKSLGKxmi+l8hkE7Qq8TjI7hpwvm
 Z+P9+v2XqzyXunwRMYtNb7ZakYwGFGDZj0q5vW20AZch9H3DSZSmTePi5pReo1lZKu0M
 WNXw==
X-Gm-Message-State: APjAAAW2vUCrh7YDIeJInZixsbBF1fEDriuu4iYqLSyRQvQ2e+FOytqd
 QGFu0kWzJ4Klr1D6ko7ZUFMC6hyJMFddr0l/3NFArr1Q
X-Google-Smtp-Source: APXvYqwZyr9fyRpzgZ/J4xpP3/v1mxslCOejT5QcO8mIiCuVZP+P0zeHO9zN1oL+FYlbcLMqKSEX2vNEE6ifBcmM8cM=
X-Received: by 2002:a25:2cc8:: with SMTP id s191mr8142216ybs.269.1567100231221; 
 Thu, 29 Aug 2019 10:37:11 -0700 (PDT)
MIME-Version: 1.0
References: <CAB5c7xrHU396GnZb_P4adbGFSZA4wvdRFx526n2OXHBCk+FooQ@mail.gmail.com>
 <e14c5e22-5ee7-310d-9f21-77257d53468b@samba.org>
In-Reply-To: <e14c5e22-5ee7-310d-9f21-77257d53468b@samba.org>
Date: Thu, 29 Aug 2019 13:36:59 -0400
Message-ID: <CAB5c7xqz-S_yHahSp5onY0N=FqufeDkxhGo=+cHpu-BGyduqRw@mail.gmail.com>
Subject: Re: smbstatus json/xml output with libxo
To: samba-technical <samba-technical@lists.samba.org>
Content-Type: multipart/mixed; boundary="0000000000009c2e8a059144f4e1"
X-Content-Filtered-By: Mailman/MimeDel 2.1.29
X-BeenThere: samba-technical@lists.samba.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: "Discussions on Samba internals. For general questions please
 subscribe to the list samba@lists.samba.org"
 <samba-technical.lists.samba.org>
List-Unsubscribe: <https://lists.samba.org/mailman/options/samba-technical>,
 <mailto:samba-technical-request@lists.samba.org?subject=unsubscribe>
List-Archive: <http://lists.samba.org/pipermail/samba-technical/>
List-Post: <mailto:samba-technical@lists.samba.org>
List-Help: <mailto:samba-technical-request@lists.samba.org?subject=help>
List-Subscribe: <https://lists.samba.org/mailman/listinfo/samba-technical>,
 <mailto:samba-technical-request@lists.samba.org?subject=subscribe>
From: Andrew Walker via samba-technical <samba-technical@lists.samba.org>
Reply-To: Andrew Walker <awalker@ixsystems.com>
Errors-To: samba-technical-bounces@lists.samba.org
Sender: "samba-technical" <samba-technical-bounces@lists.samba.org>

--0000000000009c2e8a059144f4e1
Content-Type: text/plain; charset="UTF-8"

On Wed, Apr 17, 2019 at 10:55 AM Stefan Metzmacher <metze@samba.org> wrote:

>
> I think using another library should be avoided, do you really need xml
> or would you be able to work based on libjansson and only json?
>
> metze
>
>
Sorry, it took a while to get around to this. I re-worked it to use
libjansson per your suggestion.

--0000000000009c2e8a059144f4e1
Content-Type: text/x-patch; charset="US-ASCII"; name="smbstatus_json.patch"
Content-Disposition: attachment; filename="smbstatus_json.patch"
Content-Transfer-Encoding: base64
Content-ID: <f_jzwyx9wi0>
X-Attachment-Id: f_jzwyx9wi0

ZGlmZiAtLWdpdCBhL3NvdXJjZTMvdXRpbHMvc3RhdHVzLmMgYi9zb3VyY2UzL3V0aWxzL3N0YXR1
cy5jCmluZGV4IGI1ZDBiNWUuLjg0NjQ2Y2UgMTAwNjQ0Ci0tLSBhL3NvdXJjZTMvdXRpbHMvc3Rh
dHVzLmMKKysrIGIvc291cmNlMy91dGlscy9zdGF0dXMuYwpAQCAtNTEsNiArNTEsMTIgQEAKICNp
bmNsdWRlICJjbWRsaW5lX2NvbnRleHRzLmgiCiAjaW5jbHVkZSAibG9ja2luZy9sZWFzZXNfZGIu
aCIKIAorI2lmZGVmIEhBVkVfSkFOU1NPTgorI2luY2x1ZGUgPGphbnNzb24uaD4KKyNpbmNsdWRl
ICJhdWRpdF9sb2dnaW5nLmgiIC8qIHZhcmlvdXMgSlNPTiBoZWxwZXJzICovCisjaW5jbHVkZSAi
YXV0aC9jb21tb25fYXV0aC5oIgorI2VuZGlmIC8qIFtIQVZFX0pBTlNTT05dICovCisKICNkZWZp
bmUgU01CX01BWFBJRFMJCTIwNDgKIHN0YXRpYyB1aWRfdCAJCVVjcml0X3VpZCA9IDA7ICAgICAg
ICAgICAgICAgLyogYWRkZWQgYnkgT0ggKi8KIHN0YXRpYyBzdHJ1Y3Qgc2VydmVyX2lkCVVjcml0
X3BpZFtTTUJfTUFYUElEU107ICAvKiBVZ2x5ICEhISAqLyAgIC8qIGFkZGVkIGJ5IE9IICovCkBA
IC02NCw5ICs3MCwxMyBAQCBzdGF0aWMgYm9vbCBwcm9jZXNzZXNfb25seTsKIHN0YXRpYyBib29s
IHNob3dfYnJsOwogc3RhdGljIGJvb2wgbnVtZXJpY19vbmx5Owogc3RhdGljIGJvb2wgZG9fY2hl
Y2tzID0gdHJ1ZTsKK3N0YXRpYyBib29sIGpzb25fb3V0cHV0ID0gZmFsc2U7CitzdGF0aWMgYm9v
bCByZXNvbHZlX3VpZHMgPSBmYWxzZTsKIAogY29uc3QgY2hhciAqdXNlcm5hbWUgPSBOVUxMOwog
CitzdGF0aWMgY29uc3QgY2hhciAqc2Vzc2lvbl9kaWFsZWN0X3N0cih1aW50MTZfdCBkaWFsZWN0
KTsKKwogLyogYWRkZWQgYnkgT0ggKi8KIHN0YXRpYyB2b2lkIFVjcml0X2FkZFVpZCh1aWRfdCB1
aWQpCiB7CkBAIC0xMTgsMTIgKzEyOCw2NDYgQEAgc3RhdGljIGJvb2wgVWNyaXRfYWRkUGlkKCBz
dHJ1Y3Qgc2VydmVyX2lkIHBpZCApCiAJcmV0dXJuIFRydWU7CiB9CiAKKyNpZmRlZiBIQVZFX0pB
TlNTT04KK3N0YXRpYyBpbnQgcHJpbnRfc2hhcmVfbW9kZV9qc29uKHN0cnVjdCBmaWxlX2lkIGZp
ZCwKKwkJCQkgY29uc3Qgc3RydWN0IHNoYXJlX21vZGVfZGF0YSAqZCwKKwkJCQkgY29uc3Qgc3Ry
dWN0IHNoYXJlX21vZGVfZW50cnkgKmUsCisJCQkJIHZvaWQgKnByaXZhdGVfZGF0YSkKK3sKKwlz
dHJ1Y3QganNvbl9vYmplY3QganNvYmogPSAqKHN0cnVjdCBqc29uX29iamVjdCAqKXByaXZhdGVf
ZGF0YTsKKwlzdHJ1Y3QganNvbl9vYmplY3QganNvYmppbnQgPSBqc29uX25ld19vYmplY3QoKTsK
KwlzdGF0aWMgaW50IGNvdW50OworCXN0YXRpYyBpbnQgcmV0ID0gMDsKKwljaGFyICpkZW55bW9k
ZSA9IE5VTEw7CisKKwlpZiAoZG9fY2hlY2tzICYmICFpc192YWxpZF9zaGFyZV9tb2RlX2VudHJ5
KGUpKSB7CisJCXJldHVybiAwOworCX0KKworCWNvdW50Kys7CisKKwlpZiAoZG9fY2hlY2tzICYm
ICFzZXJ2ZXJpZF9leGlzdHMoJmUtPnBpZCkpIHsKKwkJLyogdGhlIHByb2Nlc3MgZm9yIHRoaXMg
ZW50cnkgZG9lcyBub3QgZXhpc3QgYW55IG1vcmUgKi8KKwkJcmV0dXJuIDA7CisJfQorCWlmIChV
Y3JpdF9jaGVja1BpZChlLT5waWQpKSB7CisJCXN0cnVjdCBzZXJ2ZXJfaWRfYnVmIHRtcDsKKwkJ
aWYgKGpzb25faXNfaW52YWxpZCgmanNvYmppbnQpKSB7CisJCQlyZXR1cm4gLTE7CisJCX0KKwkJ
aWYgKGpzb25fYWRkX3N0cmluZygmanNvYmppbnQsICJwaWQiLAorCQkJCSAgICBzZXJ2ZXJfaWRf
c3RyX2J1ZihlLT5waWQsICZ0bXApKSA8IDApIHsKKwkJCWdvdG8gZmFpbHVyZTsJCisJCX0KKwkJ
aWYgKHJlc29sdmVfdWlkcyAmJiAoanNvbl9hZGRfc3RyaW5nKCZqc29iamludCwgInVzZXJuYW1l
IiwKKwkJCQkJICAgIHVpZHRvbmFtZShlLT51aWQpKSA8IDApKSB7CisJCQlnb3RvIGZhaWx1cmU7
CQorCQl9CisJCWlmIChqc29uX2FkZF9pbnQoJmpzb2JqaW50LCAidWlkIiwgKHVuc2lnbmVkIGlu
dCllLT51aWQpIDwgMCkgeworCQkJZ290byBmYWlsdXJlOwkKKwkJfQorCQlzd2l0Y2ggKG1hcF9z
aGFyZV9tb2RlX3RvX2RlbnlfbW9kZShlLT5zaGFyZV9hY2Nlc3MsCisJCQkJCQkgICAgZS0+cHJp
dmF0ZV9vcHRpb25zKSkgeworCQkJY2FzZSBERU5ZX05PTkU6IGRlbnltb2RlID0gIkRFTllfTk9O
RSI7IGJyZWFrOworCQkJY2FzZSBERU5ZX0FMTDogIGRlbnltb2RlID0gIkRFTllfQUxMIjsgYnJl
YWs7CisJCQljYXNlIERFTllfRE9TOiAgZGVueW1vZGUgPSAiREVOWV9ET1MiOyBicmVhazsKKwkJ
CWNhc2UgREVOWV9SRUFEOiBkZW55bW9kZSA9ICJERU5ZX1JFQUQiOyBicmVhazsKKwkJCWNhc2Ug
REVOWV9XUklURTpkZW55bW9kZSA9ICJERU5ZX1dSSVRFIjsgYnJlYWs7CisJCQljYXNlIERFTllf
RkNCOiAgZGVueW1vZGUgPSAiREVOWV9GQ0IiOyBicmVhazsKKwkJCWRlZmF1bHQ6IHsKKwkJCQlk
ZW55bW9kZSA9ICJVTktOT1dOIjsgCisJCQkJYnJlYWs7CisJCQl9CisJCX0KKwkgICAgICAgIHN0
cnVjdCBqc29uX29iamVjdCBhbWFzayA9IGpzb25fbmV3X29iamVjdCgpOworCQlpZiAoanNvbl9p
c19pbnZhbGlkKCZhbWFzaykpIHsKKwkJCWdvdG8gZmFpbHVyZTsJCisJCX0KKwkJY2hhciAqYWNj
ZXNzX21hc2sgPSBOVUxMOworCQlhY2Nlc3NfbWFzayA9IHRhbGxvY19hc3ByaW50ZihOVUxMLCAi
MHglMDh4IiwgKHVuc2lnbmVkIGludCllLT5hY2Nlc3NfbWFzayk7CisJCWlmIChqc29uX2FkZF9z
dHJpbmcoJmFtYXNrLCAiaGV4IiwgYWNjZXNzX21hc2spIDwgMCkgeworCQkJVEFMTE9DX0ZSRUUo
YWNjZXNzX21hc2spOworCQkJcmV0ID0gLTE7CisJCQlnb3RvIGZhaWx1cmU7CQorCQl9CisJCVRB
TExPQ19GUkVFKGFjY2Vzc19tYXNrKTsKKwkJaWYgKHZlcmJvc2UpIHsKKwkJCWlmIChqc29uX2Fk
ZF9ib29sKCZhbWFzaywgIlJFQURfREFUQSIsCisJCQkJIChlLT5hY2Nlc3NfbWFzayAmIEZJTEVf
UkVBRF9EQVRBKT90cnVlOmZhbHNlKSA8IDApIHsKKwkJCQlqc29uX2ZyZWUoJmFtYXNrKTsKKwkJ
CQlnb3RvIGZhaWx1cmU7CQorCQkJfQorCQkJaWYgKGpzb25fYWRkX2Jvb2woJmFtYXNrLCAiV1JJ
VEVfREFUQSIsCisJCQkJIChlLT5hY2Nlc3NfbWFzayAmIEZJTEVfV1JJVEVfREFUQSk/dHJ1ZTpm
YWxzZSkgPCAwKSB7CisJCQkJanNvbl9mcmVlKCZhbWFzayk7CisJCQkJZ290byBmYWlsdXJlOwkK
KwkJCX0KKwkJCWlmIChqc29uX2FkZF9ib29sKCZhbWFzaywgIkFQUEVORF9EQVRBIiwKKwkJCQkg
KGUtPmFjY2Vzc19tYXNrICYgRklMRV9BUFBFTkRfREFUQSk/dHJ1ZTpmYWxzZSkgPCAwKSB7CisJ
CQkJanNvbl9mcmVlKCZhbWFzayk7CisJCQkJZ290byBmYWlsdXJlOwkKKwkJCX0KKwkJCWlmIChq
c29uX2FkZF9ib29sKCZhbWFzaywgIlJFQURfRUEiLAorCQkJCSAoZS0+YWNjZXNzX21hc2sgJiBG
SUxFX1JFQURfRUEpP3RydWU6ZmFsc2UpIDwgMCkgeworCQkJCWpzb25fZnJlZSgmYW1hc2spOwor
CQkJCWdvdG8gZmFpbHVyZTsJCisJCQl9CisJCQlpZiAoanNvbl9hZGRfYm9vbCgmYW1hc2ssICJX
UklURV9FQSIsCisJCQkJIChlLT5hY2Nlc3NfbWFzayAmIEZJTEVfV1JJVEVfRUEpP3RydWU6ZmFs
c2UpIDwgMCkgeworCQkJCWpzb25fZnJlZSgmYW1hc2spOworCQkJCWdvdG8gZmFpbHVyZTsJCisJ
CQl9CisJCQlpZiAoanNvbl9hZGRfYm9vbCgmYW1hc2ssICJFWEVDVVRFIiwKKwkJCQkgKGUtPmFj
Y2Vzc19tYXNrICYgRklMRV9FWEVDVVRFKT90cnVlOmZhbHNlKSA8IDApIHsKKwkJCQlqc29uX2Zy
ZWUoJmFtYXNrKTsKKwkJCQlnb3RvIGZhaWx1cmU7CQorCQkJfQorCQkJaWYgKGpzb25fYWRkX2Jv
b2woJmFtYXNrLCAiUkVBRF9BVFRSSUJVVEVTIiwKKwkJCQkgKGUtPmFjY2Vzc19tYXNrICYgRklM
RV9SRUFEX0FUVFJJQlVURVMpP3RydWU6ZmFsc2UpIDwgMCkgeworCQkJCWpzb25fZnJlZSgmYW1h
c2spOworCQkJCWdvdG8gZmFpbHVyZTsJCisJCQl9CisJCQlpZiAoanNvbl9hZGRfYm9vbCgmYW1h
c2ssICJXUklURV9BVFRSSUJVVEVTIiwKKwkJCQkgKGUtPmFjY2Vzc19tYXNrICYgRklMRV9XUklU
RV9BVFRSSUJVVEVTKT90cnVlOmZhbHNlKSA8IDApIHsKKwkJCQlqc29uX2ZyZWUoJmFtYXNrKTsK
KwkJCQlnb3RvIGZhaWx1cmU7CQorCQkJfQorCQkJaWYgKGpzb25fYWRkX2Jvb2woJmFtYXNrLCAi
REVMRVRFX0NISUxEIiwKKwkJCQkgKGUtPmFjY2Vzc19tYXNrICYgRklMRV9ERUxFVEVfQ0hJTEQp
P3RydWU6ZmFsc2UpIDwgMCkgeworCQkJCWpzb25fZnJlZSgmYW1hc2spOworCQkJCWdvdG8gZmFp
bHVyZTsJCisJCQl9CisJCQlpZiAoanNvbl9hZGRfYm9vbCgmYW1hc2ssICJERUxFVEUiLAorCQkJ
CSAoZS0+YWNjZXNzX21hc2sgJiBTRUNfU1REX0RFTEVURSk/dHJ1ZTpmYWxzZSkgPCAwKSB7CisJ
CQkJanNvbl9mcmVlKCZhbWFzayk7CisJCQkJZ290byBmYWlsdXJlOwkKKwkJCX0KKwkJCWlmIChq
c29uX2FkZF9ib29sKCZhbWFzaywgIlJFQURfQ09OVFJPTCIsCisJCQkJIChlLT5hY2Nlc3NfbWFz
ayAmIFNFQ19TVERfUkVBRF9DT05UUk9MKT90cnVlOmZhbHNlKSA8IDApIHsKKwkJCQlqc29uX2Zy
ZWUoJmFtYXNrKTsKKwkJCQlnb3RvIGZhaWx1cmU7CQorCQkJfQorCQkJaWYgKGpzb25fYWRkX2Jv
b2woJmFtYXNrLCAiV1JJVEVfREFDIiwKKwkJCQkgKGUtPmFjY2Vzc19tYXNrICYgU0VDX1NURF9X
UklURV9EQUMpP3RydWU6ZmFsc2UpIDwgMCkgeworCQkJCWpzb25fZnJlZSgmYW1hc2spOworCQkJ
CWdvdG8gZmFpbHVyZTsJCisJCQl9CisJCQlpZiAoanNvbl9hZGRfYm9vbCgmYW1hc2ssICJXUklU
RV9PV05FUiIsCisJCQkJIChlLT5hY2Nlc3NfbWFzayAmIFNFQ19TVERfV1JJVEVfT1dORVIpP3Ry
dWU6ZmFsc2UpIDwgMCkgeworCQkJCWpzb25fZnJlZSgmYW1hc2spOworCQkJCWdvdG8gZmFpbHVy
ZTsJCisJCQl9CisJCQlpZiAoanNvbl9hZGRfYm9vbCgmYW1hc2ssICJTWU5DSFJPTklaRSIsCisJ
CQkJIChlLT5hY2Nlc3NfbWFzayAmIFNFQ19TVERfU1lOQ0hST05JWkUpP3RydWU6ZmFsc2UpIDwg
MCkgeworCQkJCWpzb25fZnJlZSgmYW1hc2spOworCQkJCWdvdG8gZmFpbHVyZTsJCisJCQl9CisJ
CX0KKwkJaWYgKGpzb25fYWRkX29iamVjdCgmanNvYmppbnQsICJhY2Nlc3NfbWFzayIsICZhbWFz
aykgPCAwKSB7CisJCQlqc29uX2ZyZWUoJmFtYXNrKTsKKwkJCWdvdG8gZmFpbHVyZTsKKwkJfQor
CQlzdHJ1Y3QganNvbl9vYmplY3Qgb3Bsb2NrID0ganNvbl9uZXdfb2JqZWN0KCk7CisJCWlmIChq
c29uX2lzX2ludmFsaWQoJm9wbG9jaykpIHsKKwkJCWdvdG8gZmFpbHVyZTsKKwkJfQorCQkJCisJ
CWlmIChqc29uX2FkZF9ib29sKCZvcGxvY2ssICJFWENMVVNJVkUiLAorCQkJCSAoZS0+b3BfdHlw
ZSAmIEVYQ0xVU0lWRV9PUExPQ0spP3RydWU6ZmFsc2UpIDwgMCkgeworCQkJanNvbl9mcmVlKCZv
cGxvY2spOworCQkJZ290byBmYWlsdXJlOworCQl9CisJCWlmIChqc29uX2FkZF9ib29sKCZvcGxv
Y2ssICJCQVRDSCIsCisJCQkJIChlLT5vcF90eXBlICYgQkFUQ0hfT1BMT0NLKT90cnVlOmZhbHNl
KSA8IDApIHsKKwkJCWpzb25fZnJlZSgmb3Bsb2NrKTsKKwkJCWdvdG8gZmFpbHVyZTsKKwkJfQor
CQlpZiAoanNvbl9hZGRfYm9vbCgmb3Bsb2NrLCAiTEVWRUxfSUkiLAorCQkJCSAoZS0+b3BfdHlw
ZSAmIExFVkVMX0lJX09QTE9DSyk/dHJ1ZTpmYWxzZSkgPCAwKSB7CisJCQlqc29uX2ZyZWUoJm9w
bG9jayk7CisJCQlnb3RvIGZhaWx1cmU7CisJCX0KKwkJaWYgKGpzb25fYWRkX2Jvb2woJm9wbG9j
aywgIkxFQVNFIiwKKwkJCQkgKGUtPm9wX3R5cGUgJiBMRUFTRV9PUExPQ0spP3RydWU6ZmFsc2Up
IDwgMCkgeworCQkJanNvbl9mcmVlKCZvcGxvY2spOworCQkJZ290byBmYWlsdXJlOworCQl9CisJ
CWlmIChqc29uX2FkZF9vYmplY3QoJmpzb2JqaW50LCAib3Bsb2NrIiwgJm9wbG9jaykgPCAwKSB7
CisJCQlqc29uX2ZyZWUoJm9wbG9jayk7CisJCQlnb3RvIGZhaWx1cmU7CisJCX0KKwkJc3RydWN0
IGpzb25fb2JqZWN0IGxlYXNlID0ganNvbl9uZXdfb2JqZWN0KCk7CisJCWlmIChqc29uX291dHB1
dCAmJiAoZS0+b3BfdHlwZSAmIExFQVNFX09QTE9DSykpIHsKKwkJCXN0cnVjdCBqc29uX29iamVj
dCBsZWFzZSA9IGpzb25fbmV3X29iamVjdCgpOworCQkJaWYgKGpzb25faXNfaW52YWxpZCgmbGVh
c2UpKSB7CisJCQkJZ290byBmYWlsdXJlOworCQkJfQorCQkJTlRTVEFUVVMgc3RhdHVzOworCQkJ
dWludDMyX3QgbHN0YXRlOworCisJCQlzdGF0dXMgPSBsZWFzZXNfZGJfZ2V0KAorCQkJCSZlLT5j
bGllbnRfZ3VpZCwKKwkJCQkmZS0+bGVhc2Vfa2V5LAorCQkJCSZkLT5pZCwKKwkJCQkmbHN0YXRl
LCAvKiBjdXJyZW50X3N0YXRlICovCisJCQkJTlVMTCwgLyogYnJlYWtpbmcgKi8KKwkJCQlOVUxM
LCAvKiBicmVha2luZ190b19yZXF1ZXN0ZWQgKi8KKwkJCQlOVUxMLCAvKiBicmVha2luZ190b19y
ZXF1aXJlZCAqLworCQkJCU5VTEwsIC8qIGxlYXNlX3ZlcnNpb24gKi8KKwkJCQlOVUxMKTsgLyog
ZXBvY2ggKi8KKworCQkJaWYgKE5UX1NUQVRVU19JU19PSyhzdGF0dXMpKSB7CisJCQkJaWYgKGpz
b25fYWRkX2Jvb2woJmxlYXNlLCAiUkVBRCIsCisJCQkJCQkgKGxzdGF0ZSAmIFNNQjJfTEVBU0Vf
UkVBRCk/dHJ1ZTpmYWxzZSkgPCAwKSB7CisJCQkJCWpzb25fZnJlZSgmbGVhc2UpOworCQkJCQln
b3RvIGZhaWx1cmU7CisJCQkJfQorCQkJCWlmIChqc29uX2FkZF9ib29sKCZsZWFzZSwgIldSSVRF
IiwKKwkJCQkJCSAobHN0YXRlICYgU01CMl9MRUFTRV9XUklURSk/dHJ1ZTpmYWxzZSkgPCAwKSB7
CisJCQkJCWpzb25fZnJlZSgmbGVhc2UpOworCQkJCQlnb3RvIGZhaWx1cmU7CisJCQkJfQorCQkJ
CWlmIChqc29uX2FkZF9ib29sKCZsZWFzZSwgIkhBTkRMRSIsCisJCQkJCQkgKGxzdGF0ZSAmIFNN
QjJfTEVBU0VfSEFORExFKT90cnVlOmZhbHNlKSA8IDApIHsKKwkJCQkJanNvbl9mcmVlKCZsZWFz
ZSk7CisJCQkJCWdvdG8gZmFpbHVyZTsKKwkJCQl9CisJCQl9CisJCQlpZiAoanNvbl9hZGRfb2Jq
ZWN0KCZqc29iamludCwgImxlYXNlIiwgJmxlYXNlKSA8IDApIHsKKwkJCQlqc29uX2ZyZWUoJmxl
YXNlKTsKKwkJCQlnb3RvIGZhaWx1cmU7CisJCQl9CisJCX0KKwkJZWxzZSB7CisJCQlpZiAoanNv
bl9hZGRfYm9vbCgmbGVhc2UsICJSRUFEIiwgZmFsc2UpIDwgMCkgeworCQkJCWpzb25fZnJlZSgm
bGVhc2UpOworCQkJCWdvdG8gZmFpbHVyZTsKKwkJCX0KKwkJCWlmIChqc29uX2FkZF9ib29sKCZs
ZWFzZSwgIldSSVRFIiwgZmFsc2UpIDwgMCkgeworCQkJCWpzb25fZnJlZSgmbGVhc2UpOworCQkJ
CWdvdG8gZmFpbHVyZTsKKwkJCX0KKwkJCWlmIChqc29uX2FkZF9ib29sKCZsZWFzZSwgIkhBTkRM
RSIsIGZhbHNlKSA8IDApIHsKKwkJCQlqc29uX2ZyZWUoJmxlYXNlKTsKKwkJCQlnb3RvIGZhaWx1
cmU7CisJCQl9CisJCQlpZiAoanNvbl9hZGRfb2JqZWN0KCZqc29iamludCwgImxlYXNlIiwgJmxl
YXNlKSA8IDApIHsKKwkJCQlqc29uX2ZyZWUoJmxlYXNlKTsKKwkJCQlnb3RvIGZhaWx1cmU7CisJ
CQl9CisJCX0KKwkJaWYgKGpzb25fYWRkX3N0cmluZygmanNvYmppbnQsICJzZXJ2aWNlX3BhdGgi
LCBkLT5zZXJ2aWNlcGF0aCkgPCAwKSB7CisJCQlnb3RvIGZhaWx1cmU7CisJCX0KKwkJY2hhciAq
ZmlsZW5hbWUgPSBOVUxMOworCQlmaWxlbmFtZSA9IHRhbGxvY19hc3ByaW50ZihOVUxMLCAiJXMl
cyIsIGQtPmJhc2VfbmFtZSwKKwkJCShkLT5zdHJlYW1fbmFtZSAhPSBOVUxMKSA/IGQtPnN0cmVh
bV9uYW1lIDogIiIpOworCQlpZiAoanNvbl9hZGRfc3RyaW5nKCZqc29iamludCwgImZpbGVuYW1l
IiwgZmlsZW5hbWUpIDwgMCkgeworCQkJVEFMTE9DX0ZSRUUoZmlsZW5hbWUpOworCQkJZ290byBm
YWlsdXJlOworCQl9CisJCVRBTExPQ19GUkVFKGZpbGVuYW1lKTsKKwkJaWYgKGpzb25fYWRkX29i
amVjdCgmanNvYmosIE5VTEwsICZqc29iamludCkgPCAwKSB7CisJCQlnb3RvIGZhaWx1cmU7CisJ
CX0KKwl9CisKKwlyZXR1cm4gMDsKKworZmFpbHVyZToKKwlqc29uX2ZyZWUoJmpzb2JqaW50KTsK
KwlyZXR1cm4gLTE7Cit9CisKK3N0YXRpYyB2b2lkIHByaW50X2JybF9qc29uKHN0cnVjdCBmaWxl
X2lkIGlkLAorCQkJc3RydWN0IHNlcnZlcl9pZCBwaWQsIAorCQkJZW51bSBicmxfdHlwZSBsb2Nr
X3R5cGUsCisJCQllbnVtIGJybF9mbGF2b3VyIGxvY2tfZmxhdiwKKwkJCWJyX29mZiBzdGFydCwK
KwkJCWJyX29mZiBzaXplLAorCQkJdm9pZCAqcHJpdmF0ZV9kYXRhKQoreworICAgICAgICBzdHJ1
Y3QganNvbl9vYmplY3QganNvYmogPSAqKHN0cnVjdCBqc29uX29iamVjdCAqKXByaXZhdGVfZGF0
YTsKKyAgICAgICAgc3RydWN0IGpzb25fb2JqZWN0IGpzb2JqaW50ID0ganNvbl9uZXdfb2JqZWN0
KCk7CisJc3RhdGljIGludCBjb3VudDsKKwl1bnNpZ25lZCBpbnQgaTsKKwlzdGF0aWMgY29uc3Qg
c3RydWN0IHsKKwkJZW51bSBicmxfdHlwZSBsb2NrX3R5cGU7CisJCWNvbnN0IGNoYXIgKmRlc2M7
CisJfSBsb2NrX3R5cGVzW10gPSB7CisJCXsgUkVBRF9MT0NLLCAiUiIgfSwKKwkJeyBXUklURV9M
T0NLLCAiVyIgfSwKKwkJeyBVTkxPQ0tfTE9DSywgIlUiIH0KKwl9OworCWNvbnN0IGNoYXIgKmRl
c2M9IlgiOworCWNvbnN0IGNoYXIgKnNoYXJlcGF0aCA9ICIiOworCWNoYXIgKmZuYW1lID0gTlVM
TDsKKwlzdHJ1Y3Qgc2hhcmVfbW9kZV9sb2NrICpzaGFyZV9tb2RlOworCXN0cnVjdCBzZXJ2ZXJf
aWRfYnVmIHRtcDsKKworCWNvdW50Kys7CisKKwlzaGFyZV9tb2RlID0gZmV0Y2hfc2hhcmVfbW9k
ZV91bmxvY2tlZChOVUxMLCBpZCk7CisJaWYgKHNoYXJlX21vZGUpIHsKKwkJYm9vbCBoYXNfc3Ry
ZWFtID0gc2hhcmVfbW9kZS0+ZGF0YS0+c3RyZWFtX25hbWUgIT0gTlVMTDsKKworCQlmbmFtZSA9
IHRhbGxvY19hc3ByaW50ZihOVUxMLCAiJXMlcyVzIiwKKwkJCQkJc2hhcmVfbW9kZS0+ZGF0YS0+
YmFzZV9uYW1lLAorCQkJCQloYXNfc3RyZWFtID8gIjoiIDogIiIsCisJCQkJCWhhc19zdHJlYW0g
PworCQkJCQlzaGFyZV9tb2RlLT5kYXRhLT5zdHJlYW1fbmFtZSA6CisJCQkJCSIiKTsKKwl9IGVs
c2UgeworCQlmbmFtZSA9IHRhbGxvY19zdHJkdXAoTlVMTCwgIiIpOworCQlpZiAoZm5hbWUgPT0g
TlVMTCkgeworCQkJcmV0dXJuOworCQl9CisJfQorCisJZm9yIChpPTA7aTxBUlJBWV9TSVpFKGxv
Y2tfdHlwZXMpO2krKykgeworCQlpZiAobG9ja190eXBlID09IGxvY2tfdHlwZXNbaV0ubG9ja190
eXBlKSB7CisJCQlkZXNjID0gbG9ja190eXBlc1tpXS5kZXNjOworCQl9CisJfQorCWlmIChqc29u
X2lzX2ludmFsaWQoJmpzb2JqaW50KSkgeworCQlnb3RvIGZhaWx1cmU7CQorCX0KKwlpZiAoanNv
bl9hZGRfc3RyaW5nKCZqc29iamludCwgInBpZCIsCisJCQkgICAgc2VydmVyX2lkX3N0cl9idWYo
cGlkLCAmdG1wKSkgPCAwKSB7CisJCWdvdG8gZmFpbHVyZTsJCisJfQorCWlmIChqc29uX2FkZF9z
dHJpbmcoJmpzb2JqaW50LCAiZGV2X2lub2RlIiwKKwkJCSAgICBmaWxlX2lkX3N0cmluZ190b3Mo
JmlkKSkgPCAwKSB7CisJCWdvdG8gZmFpbHVyZTsJCisJfQorCWlmIChqc29uX2FkZF9zdHJpbmco
Jmpzb2JqaW50LCAicmVhZF93cml0ZSIsIGRlc2MpIDwgMCkgeworCQlnb3RvIGZhaWx1cmU7CQor
CX0KKwlpZiAoanNvbl9hZGRfaW50KCZqc29iamludCwgInN0YXJ0IiwgKGludG1heF90KXN0YXJ0
KSA8IDApIHsKKwkJZ290byBmYWlsdXJlOwkKKwl9CisJaWYgKGpzb25fYWRkX2ludCgmanNvYmpp
bnQsICJzaXplIiwgKGludG1heF90KXNpemUpIDwgMCkgeworCQlnb3RvIGZhaWx1cmU7CQorCX0K
KwlpZiAoanNvbl9hZGRfc3RyaW5nKCZqc29iamludCwgInNoYXJlX3BhdGgiLCBzaGFyZXBhdGgp
IDwgMCkgeworCQlnb3RvIGZhaWx1cmU7CQorCX0KKwlpZiAoanNvbl9hZGRfc3RyaW5nKCZqc29i
amludCwgImZpbGVfbmFtZSIsIGZuYW1lKSA8IDApIHsKKwkJZ290byBmYWlsdXJlOwkKKwl9CisJ
aWYgKGpzb25fYWRkX29iamVjdCgmanNvYmosIE5VTEwsICZqc29iamludCkgPCAwKSB7CisJCWdv
dG8gZmFpbHVyZTsKKwl9CisKKwlUQUxMT0NfRlJFRShmbmFtZSk7CisJVEFMTE9DX0ZSRUUoc2hh
cmVfbW9kZSk7CisKK2ZhaWx1cmU6CisJVEFMTE9DX0ZSRUUoZm5hbWUpOworCVRBTExPQ19GUkVF
KHNoYXJlX21vZGUpOworCWpzb25fZnJlZSgmanNvYmppbnQpOworfQorCitzdGF0aWMgaW50IHRy
YXZlcnNlX2Nvbm5lY3Rpb25zX2pzb24oY29uc3Qgc3RydWN0IGNvbm5lY3Rpb25zX2tleSAqa2V5
LAorCQkJCWNvbnN0IHN0cnVjdCBjb25uZWN0aW9uc19kYXRhICpjcmVjLAorCQkJCXZvaWQgKnBy
aXZhdGVfZGF0YSkKK3sKKyAgICAgICAgc3RydWN0IGpzb25fb2JqZWN0IGpzb2JqID0gKihzdHJ1
Y3QganNvbl9vYmplY3QgKilwcml2YXRlX2RhdGE7CisgICAgICAgIHN0cnVjdCBqc29uX29iamVj
dCBqc29iamludCA9IGpzb25fbmV3X29iamVjdCgpOworCXN0cnVjdCBzZXJ2ZXJfaWRfYnVmIHRt
cDsKKwljaGFyICp0aW1lc3RyID0gTlVMTDsKKwlpbnQgcmVzdWx0ID0gMDsKKwljb25zdCBjaGFy
ICplbmNyeXB0aW9uID0gIi0iOworCWNvbnN0IGNoYXIgKnNpZ25pbmcgPSAiLSI7CisKKwlpZiAo
Y3JlYy0+Y251bSA9PSBUSURfRklFTERfSU5WQUxJRCkKKwkJcmV0dXJuIDA7CisKKwlpZiAoZG9f
Y2hlY2tzICYmCisJICAgICghcHJvY2Vzc19leGlzdHMoY3JlYy0+cGlkKSB8fCAhVWNyaXRfY2hl
Y2tVaWQoY3JlYy0+dWlkKSkpIHsKKwkJcmV0dXJuIDA7CisJfQorCisJdGltZXN0ciA9IHRpbWVz
dHJpbmcoTlVMTCwgY3JlYy0+c3RhcnQpOworCWlmICh0aW1lc3RyID09IE5VTEwpIHsKKwkJcmV0
dXJuIC0xOworCX0KKworCWlmIChzbWJYc3J2X2lzX2VuY3J5cHRlZChjcmVjLT5lbmNyeXB0aW9u
X2ZsYWdzKSkgeworCQlzd2l0Y2ggKGNyZWMtPmNpcGhlcikgeworCQljYXNlIFNNQl9FTkNSWVBU
SU9OX0dTU0FQSToKKwkJCWVuY3J5cHRpb24gPSAiR1NTQVBJIjsKKwkJCWJyZWFrOworCQljYXNl
IFNNQjJfRU5DUllQVElPTl9BRVMxMjhfQ0NNOgorCQkJZW5jcnlwdGlvbiA9ICJBRVMtMTI4LUND
TSI7CisJCQlicmVhazsKKwkJY2FzZSBTTUIyX0VOQ1JZUFRJT05fQUVTMTI4X0dDTToKKwkJCWVu
Y3J5cHRpb24gPSAiQUVTLTEyOC1HQ00iOworCQkJYnJlYWs7CisJCWRlZmF1bHQ6CisJCQllbmNy
eXB0aW9uID0gIj8/PyI7CisJCQlyZXN1bHQgPSAtMTsKKwkJCWJyZWFrOworCQl9CisJfQorCisJ
aWYgKHNtYlhzcnZfaXNfc2lnbmVkKGNyZWMtPnNpZ25pbmdfZmxhZ3MpKSB7CisJCWlmIChjcmVj
LT5kaWFsZWN0ID49IFNNQjNfRElBTEVDVF9SRVZJU0lPTl8zMDIpIHsKKwkJCXNpZ25pbmcgPSAi
QUVTLTEyOC1DTUFDIjsKKwkJfSBlbHNlIGlmIChjcmVjLT5kaWFsZWN0ID49IFNNQjJfRElBTEVD
VF9SRVZJU0lPTl8yMDIpIHsKKwkJCXNpZ25pbmcgPSAiSE1BQy1TSEEyNTYiOworCQl9IGVsc2Ug
eworCQkJc2lnbmluZyA9ICJITUFDLU1ENSI7CisJCX0KKwl9CisKKwlpZiAoanNvbl9pc19pbnZh
bGlkKCZqc29iamludCkpIHsKKwkJVEFMTE9DX0ZSRUUodGltZXN0cik7CisJCXJldHVybiAtMTsJ
CisJfQorCWlmIChqc29uX2FkZF9zdHJpbmcoJmpzb2JqaW50LCAic2VydmljZSIsIGNyZWMtPnNl
cnZpY2VuYW1lKSA8IDApIHsKKwkJZ290byBmYWlsdXJlOworCX0KKwlpZiAoanNvbl9hZGRfc3Ry
aW5nKCZqc29iamludCwgInBpZCIsCisJCQkgICAgc2VydmVyX2lkX3N0cl9idWYoY3JlYy0+cGlk
LCAmdG1wKSkgPCAwKSB7CisJCWdvdG8gZmFpbHVyZTsKKwl9CisJaWYgKGpzb25fYWRkX3N0cmlu
ZygmanNvYmppbnQsICJtYWNoaW5lIiwgY3JlYy0+bWFjaGluZSkgPCAwKSB7CisJCWdvdG8gZmFp
bHVyZTsKKwl9CisJaWYgKGpzb25fYWRkX3N0cmluZygmanNvYmppbnQsICJjb25uZWN0ZWRfYXQi
LCB0aW1lc3RyKSA8IDApIHsKKwkJZ290byBmYWlsdXJlOworCX0KKwlpZiAoanNvbl9hZGRfc3Ry
aW5nKCZqc29iamludCwgImVuY3J5cHRpb24iLCBlbmNyeXB0aW9uKSA8IDApIHsKKwkJZ290byBm
YWlsdXJlOworCX0KKwlpZiAoanNvbl9hZGRfc3RyaW5nKCZqc29iamludCwgInNpZ25pbmciLCBz
aWduaW5nKSA8IDApIHsKKwkJZ290byBmYWlsdXJlOworCX0KKwlpZiAoanNvbl9hZGRfb2JqZWN0
KCZqc29iaiwgTlVMTCwgJmpzb2JqaW50KSA8IDApIHsKKwkJZ290byBmYWlsdXJlOworCX0KKwor
CVRBTExPQ19GUkVFKHRpbWVzdHIpOworCXJldHVybiByZXN1bHQ7CisKK2ZhaWx1cmU6CisJVEFM
TE9DX0ZSRUUodGltZXN0cik7CisJanNvbl9mcmVlKCZqc29iamludCk7CisJcmV0dXJuIC0xOwor
fQorCitzdGF0aWMgaW50IHRyYXZlcnNlX3Nlc3Npb25pZF9qc29uKGNvbnN0IGNoYXIgKmtleSwg
c3RydWN0IHNlc3Npb25pZCAqc2Vzc2lvbiwKKwkJCQkgICAgdm9pZCAqcHJpdmF0ZV9kYXRhKQor
eworCXN0cnVjdCBqc29uX29iamVjdCBqc29iaiA9ICooc3RydWN0IGpzb25fb2JqZWN0ICopcHJp
dmF0ZV9kYXRhOworCXN0cnVjdCBqc29uX29iamVjdCBqc29iamludCA9IGpzb25fbmV3X29iamVj
dCgpOworCXN0cnVjdCBzZXJ2ZXJfaWRfYnVmIHRtcDsKKwlpbnQgcmVzdWx0ID0gMDsKKwljb25z
dCBjaGFyICplbmNyeXB0aW9uID0gIi0iOworCWNvbnN0IGNoYXIgKnNpZ25pbmcgPSAiLSI7CisK
KwlpZiAoZG9fY2hlY2tzICYmCisJICAgICghcHJvY2Vzc19leGlzdHMoc2Vzc2lvbi0+cGlkKSB8
fAorCSAgICAgIVVjcml0X2NoZWNrVWlkKHNlc3Npb24tPnVpZCkpKSB7CisJCXJldHVybiAwOwor
CX0KKworCVVjcml0X2FkZFBpZChzZXNzaW9uLT5waWQpOworCisJaWYgKGpzb25fb3V0cHV0ICYm
IGpzb25faXNfaW52YWxpZCgmanNvYmppbnQpKSB7CisJCXJldHVybiAtMTsKKwl9CisKKwlpZiAo
bnVtZXJpY19vbmx5KSB7CisJCWlmIChqc29uX291dHB1dCkgeworCQkJaWYgKGpzb25fYWRkX2lu
dCgmanNvYmppbnQsICJ1aWQiLAorCQkJCQkgKHVuc2lnbmVkIGludClzZXNzaW9uLT51aWQpIDwg
MCkgeworCQkJCWdvdG8gZmFpbHVyZTsKKwkJCX0KKwkJCWlmIChqc29uX2FkZF9pbnQoJmpzb2Jq
aW50LCAiZ2lkIiwKKwkJCQkJICh1bnNpZ25lZCBpbnQpc2Vzc2lvbi0+Z2lkKSA8IDApIHsKKwkJ
CQlnb3RvIGZhaWx1cmU7CisJCQl9CisJCX0KKwl9IGVsc2UgeworCQlpZiAoanNvbl9vdXRwdXQp
IHsKKwkJCWlmIChqc29uX2FkZF9pbnQoJmpzb2JqaW50LCAidWlkIiwKKwkJCQkJICh1bnNpZ25l
ZCBpbnQpc2Vzc2lvbi0+dWlkKSA8IDApIHsKKwkJCQlnb3RvIGZhaWx1cmU7CisJCQl9CisJCQlp
ZiAoanNvbl9hZGRfaW50KCZqc29iamludCwgImdpZCIsCisJCQkJCSAodW5zaWduZWQgaW50KXNl
c3Npb24tPmdpZCkgPCAwKSB7CisJCQkJZ290byBmYWlsdXJlOworCQkJfQorCQl9CisJCWlmIChz
ZXNzaW9uLT51aWQgPT0gLTEgJiYgc2Vzc2lvbi0+Z2lkID09IC0xKSB7CisJCQkvKgorCQkJICog
VGhlIHNlc3Npb24gaXMgbm90IGZ1bGx5IGF1dGhlbnRpY2F0ZWQgeWV0LgorCQkJICovCisJCQlp
ZiAoanNvbl9hZGRfc3RyaW5nKCZqc29iamludCwgInVzZXJuYW1lIiwKKwkJCQkJICAgICIoYXV0
aCBpbiBwcm9ncmVzcykiKSA8IDApIHsgCisJCQkJZ290byBmYWlsdXJlOworCQkJfQorCQkJaWYg
KGpzb25fYWRkX3N0cmluZygmanNvYmppbnQsICJncm91cG5hbWUiLAorCQkJCQkgICAgIihhdXRo
IGluIHByb2dyZXNzKSIpIDwgMCkgeworCQkJCWdvdG8gZmFpbHVyZTsKKwkJCX0KKwkJfSBlbHNl
IHsKKwkJCS8qCisJCQkgKiBJbiB0aGVvcnkgaXQgc2hvdWxkIG5vdCBoYXBwZW4gdGhhdCBvbmUg
b2YKKwkJCSAqIHNlc3Npb24tPnVpZCBhbmQgc2Vzc2lvbi0+Z2lkIGlzIHZhbGlkIChpZSAhPSAt
MSkKKwkJCSAqIHdoaWxlIHRoZSBvdGhlciBpcyBub3QgKGllID0gLTEpLCBzbyB3ZSBhIGNoZWNr
IGZvcgorCQkJICogdGhhdCBjYXNlIHRoYXQgYmFpbHMgb3V0IHdvdWxkIGJlIHJlYXNvbmFibGUu
CisJCQkgKi8KKwkJCWNvbnN0IGNoYXIgKnVpZF9uYW1lID0gIi0xIjsKKwkJCWNvbnN0IGNoYXIg
KmdpZF9uYW1lID0gIi0xIjsKKworCQkJaWYgKHNlc3Npb24tPnVpZCAhPSAtMSkgeworCQkJCXVp
ZF9uYW1lID0gdWlkdG9uYW1lKHNlc3Npb24tPnVpZCk7CisJCQkJaWYgKHVpZF9uYW1lID09IE5V
TEwpIHsKKwkJCQkJcmV0dXJuIC0xOworCQkJCX0KKwkJCX0KKwkJCWlmIChzZXNzaW9uLT5naWQg
IT0gLTEpIHsKKwkJCQlnaWRfbmFtZSA9IGdpZHRvbmFtZShzZXNzaW9uLT5naWQpOworCQkJCWlm
IChnaWRfbmFtZSA9PSBOVUxMKSB7CisJCQkJCXJldHVybiAtMTsKKwkJCQl9CisJCQl9CisJCQlp
ZiAoanNvbl9vdXRwdXQpIHsKKwkJCQlpZiAoanNvbl9hZGRfc3RyaW5nKCZqc29iamludCwgInVz
ZXJuYW1lIiwKKwkJCQkJCSAgICB1aWRfbmFtZSkgPCAwKSB7CisJCQkJCWdvdG8gZmFpbHVyZTsK
KwkJCQl9CisJCQkJaWYgKGpzb25fYWRkX3N0cmluZygmanNvYmppbnQsICJncm91cG5hbWUiLAor
CQkJCQkgCSAgICBnaWRfbmFtZSkgPCAwKSB7CisJCQkJCWdvdG8gZmFpbHVyZTsKKwkJCQl9CisJ
CQl9CisJCX0KKwl9CisKKwlpZiAoc21iWHNydl9pc19lbmNyeXB0ZWQoc2Vzc2lvbi0+ZW5jcnlw
dGlvbl9mbGFncykpIHsKKwkJc3dpdGNoIChzZXNzaW9uLT5jaXBoZXIpIHsKKwkJY2FzZSBTTUIy
X0VOQ1JZUFRJT05fQUVTMTI4X0NDTToKKwkJCWVuY3J5cHRpb24gPSAiQUVTLTEyOC1DQ00iOwor
CQkJYnJlYWs7CisJCWNhc2UgU01CMl9FTkNSWVBUSU9OX0FFUzEyOF9HQ006CisJCQllbmNyeXB0
aW9uID0gIkFFUy0xMjgtR0NNIjsKKwkJCWJyZWFrOworCQlkZWZhdWx0OgorCQkJZW5jcnlwdGlv
biA9ICI/Pz8iOworCQkJcmVzdWx0ID0gLTE7CisJCQlicmVhazsKKwkJfQorCX0gZWxzZSBpZiAo
c21iWHNydl9pc19wYXJ0aWFsbHlfZW5jcnlwdGVkKHNlc3Npb24tPmVuY3J5cHRpb25fZmxhZ3Mp
KSB7CisJCXN3aXRjaCAoc2Vzc2lvbi0+Y2lwaGVyKSB7CisJCWNhc2UgU01CX0VOQ1JZUFRJT05f
R1NTQVBJOgorCQkJZW5jcnlwdGlvbiA9ICJwYXJ0aWFsKEdTU0FQSSkiOworCQkJYnJlYWs7CisJ
CWNhc2UgU01CMl9FTkNSWVBUSU9OX0FFUzEyOF9DQ006CisJCQllbmNyeXB0aW9uID0gInBhcnRp
YWwoQUVTLTEyOC1DQ00pIjsKKwkJCWJyZWFrOworCQljYXNlIFNNQjJfRU5DUllQVElPTl9BRVMx
MjhfR0NNOgorCQkJZW5jcnlwdGlvbiA9ICJwYXJ0aWFsKEFFUy0xMjgtR0NNKSI7CisJCQlicmVh
azsKKwkJZGVmYXVsdDoKKwkJCWVuY3J5cHRpb24gPSAiPz8/IjsKKwkJCXJlc3VsdCA9IC0xOwor
CQkJYnJlYWs7CisJCX0KKwl9CisKKwlpZiAoc21iWHNydl9pc19zaWduZWQoc2Vzc2lvbi0+c2ln
bmluZ19mbGFncykpIHsKKwkJaWYgKHNlc3Npb24tPmNvbm5lY3Rpb25fZGlhbGVjdCA+PSBTTUIz
X0RJQUxFQ1RfUkVWSVNJT05fMzAyKSB7CisJCQlzaWduaW5nID0gIkFFUy0xMjgtQ01BQyI7CisJ
CX0gZWxzZSBpZiAoc2Vzc2lvbi0+Y29ubmVjdGlvbl9kaWFsZWN0ID49IFNNQjJfRElBTEVDVF9S
RVZJU0lPTl8yMDIpIHsKKwkJCXNpZ25pbmcgPSAiSE1BQy1TSEEyNTYiOworCQl9IGVsc2Ugewor
CQkJc2lnbmluZyA9ICJITUFDLU1ENSI7CisJCX0KKwl9IGVsc2UgaWYgKHNtYlhzcnZfaXNfcGFy
dGlhbGx5X3NpZ25lZChzZXNzaW9uLT5zaWduaW5nX2ZsYWdzKSkgeworCQlpZiAoc2Vzc2lvbi0+
Y29ubmVjdGlvbl9kaWFsZWN0ID49IFNNQjNfRElBTEVDVF9SRVZJU0lPTl8zMDIpIHsKKwkJCXNp
Z25pbmcgPSAicGFydGlhbChBRVMtMTI4LUNNQUMpIjsKKwkJfSBlbHNlIGlmIChzZXNzaW9uLT5j
b25uZWN0aW9uX2RpYWxlY3QgPj0gU01CMl9ESUFMRUNUX1JFVklTSU9OXzIwMikgeworCQkJc2ln
bmluZyA9ICJwYXJ0aWFsKEhNQUMtU0hBMjU2KSI7CisJCX0gZWxzZSB7CisJCQlzaWduaW5nID0g
InBhcnRpYWwoSE1BQy1NRDUpIjsKKwkJfQorCX0KKworCisJaWYgKGpzb25fb3V0cHV0KSB7CisJ
CWlmIChqc29uX2FkZF9zdHJpbmcoJmpzb2JqaW50LCAicmVtb3RlX21hY2hpbmUiLAorCQkJCSAg
ICBzZXNzaW9uLT5yZW1vdGVfbWFjaGluZSkgPCAwKSB7CisJCQlnb3RvIGZhaWx1cmU7CisJCX0K
KwkJaWYgKGpzb25fYWRkX3N0cmluZygmanNvYmppbnQsICJob3N0bmFtZSIsIHNlc3Npb24tPmhv
c3RuYW1lKSA8IDApIHsKKwkJCWdvdG8gZmFpbHVyZTsKKwkJfQorCQlpZiAoanNvbl9hZGRfc3Ry
aW5nKCZqc29iamludCwgInNlc3Npb25fZGlhbGVjdCIsCisJCQkJICAgIHNlc3Npb25fZGlhbGVj
dF9zdHIoc2Vzc2lvbi0+Y29ubmVjdGlvbl9kaWFsZWN0KSkgPCAwKSB7CisJCQlnb3RvIGZhaWx1
cmU7CisJCX0KKwkJaWYgKGpzb25fYWRkX3N0cmluZygmanNvYmppbnQsICJlbmNyeXB0aW9uIiwg
ZW5jcnlwdGlvbikgPCAwKSB7CisJCQlnb3RvIGZhaWx1cmU7CisJCX0KKwkJaWYgKGpzb25fYWRk
X3N0cmluZygmanNvYmppbnQsICJzaWduaW5nIiwgc2lnbmluZykgPCAwKSB7CisJCQlnb3RvIGZh
aWx1cmU7CisJCX0KKwkJaWYgKGpzb25fYWRkX29iamVjdCgmanNvYmosIHNlcnZlcl9pZF9zdHJf
YnVmKHNlc3Npb24tPnBpZCwgJnRtcCksICZqc29iamludCkgPCAwKSB7CisJCQlnb3RvIGZhaWx1
cmU7CisJCX0KKwl9CisKKwlyZXR1cm4gcmVzdWx0OworCitmYWlsdXJlOgorCWpzb25fZnJlZSgm
anNvYmppbnQpOworCXJldHVybiAtMTsKK30KKworc3RhdGljIGJvb2wgcHJpbnRfbm90aWZ5X3Jl
Y19qc29uKGNvbnN0IGNoYXIgKnBhdGgsIHN0cnVjdCBzZXJ2ZXJfaWQgc2VydmVyLAorCQkJICAg
ICBjb25zdCBzdHJ1Y3Qgbm90aWZ5X2luc3RhbmNlICppbnN0YW5jZSwKKwkJCSAgICAgdm9pZCAq
cHJpdmF0ZV9kYXRhKQoreworCXN0cnVjdCBzZXJ2ZXJfaWRfYnVmIGlkYnVmOworCXN0cnVjdCBq
c29uX29iamVjdCBqc29iaiA9ICooc3RydWN0IGpzb25fb2JqZWN0ICopcHJpdmF0ZV9kYXRhOwor
CXN0cnVjdCBqc29uX29iamVjdCBqc29iamludCA9IGpzb25fbmV3X29iamVjdCgpOworCisJaWYg
KGpzb25faXNfaW52YWxpZCgmanNvYmppbnQpKSB7CisJCXJldHVybiBmYWxzZTsKKwl9CisJaWYg
KGpzb25fYWRkX3N0cmluZygmanNvYmppbnQsICJwaWQiLCBzZXJ2ZXJfaWRfc3RyX2J1ZihzZXJ2
ZXIsICZpZGJ1ZikpIDwgMCkgeworCQlnb3RvIGZhaWx1cmU7CisJfQorCWlmIChqc29uX2FkZF9z
dHJpbmcoJmpzb2JqaW50LCAicGF0aCIsIHBhdGgpIDwgMCkgeworCQlnb3RvIGZhaWx1cmU7CisJ
fQorCWlmIChqc29uX2FkZF9pbnQoJmpzb2JqaW50LCAiZmlsdGVyIiwgKHVuc2lnbmVkKWluc3Rh
bmNlLT5maWx0ZXIpIDwgMCkgeworCQlnb3RvIGZhaWx1cmU7CisJfQorCWlmIChqc29uX2FkZF9p
bnQoJmpzb2JqaW50LCAic3ViZGlyX2ZpbHRlciIsICh1bnNpZ25lZClpbnN0YW5jZS0+c3ViZGly
X2ZpbHRlcikgPCAwKSB7CisJCWdvdG8gZmFpbHVyZTsKKwl9CisJaWYgKGpzb25fYWRkX29iamVj
dCgmanNvYmosIE5VTEwsICZqc29iamludCkgPCAwKSB7CisJCWdvdG8gZmFpbHVyZTsKKwl9CisK
KwlyZXR1cm4gdHJ1ZTsKKworZmFpbHVyZToKKwlqc29uX2ZyZWUoJmpzb2JqaW50KTsKKwlyZXR1
cm4gZmFsc2U7Cit9CisjZW5kaWYgLyogW0hBVkVfSkFOU1NPTl0gKi8KKwogc3RhdGljIGludCBw
cmludF9zaGFyZV9tb2RlKHN0cnVjdCBmaWxlX2lkIGZpZCwKIAkJCSAgICBjb25zdCBzdHJ1Y3Qg
c2hhcmVfbW9kZV9kYXRhICpkLAogCQkJICAgIGNvbnN0IHN0cnVjdCBzaGFyZV9tb2RlX2VudHJ5
ICplLAogCQkJICAgIHZvaWQgKnByaXZhdGVfZGF0YSkKIHsKLQlib29sIHJlc29sdmVfdWlkcyA9
ICooKGJvb2wgKilwcml2YXRlX2RhdGEpOwogCXN0YXRpYyBpbnQgY291bnQ7CiAKIAlpZiAoZG9f
Y2hlY2tzICYmICFpc192YWxpZF9zaGFyZV9tb2RlX2VudHJ5KGUpKSB7CkBAIC0xNDQsNiArNzg4
LDcgQEAgc3RhdGljIGludCBwcmludF9zaGFyZV9tb2RlKHN0cnVjdCBmaWxlX2lkIGZpZCwKIAog
CWlmIChVY3JpdF9jaGVja1BpZChlLT5waWQpKSB7CiAJCXN0cnVjdCBzZXJ2ZXJfaWRfYnVmIHRt
cDsKKwkJY2hhciAqZGVueW1vZGUgPSBOVUxMOwogCQlkX3ByaW50ZigiJS0xMXMgICIsIHNlcnZl
cl9pZF9zdHJfYnVmKGUtPnBpZCwgJnRtcCkpOwogCQlpZiAocmVzb2x2ZV91aWRzKSB7CiAJCQlk
X3ByaW50ZigiJS0xNHMgICIsIHVpZHRvbmFtZShlLT51aWQpKTsKQEAgLTE1Niw3ICs4MDEsNyBA
QCBzdGF0aWMgaW50IHByaW50X3NoYXJlX21vZGUoc3RydWN0IGZpbGVfaWQgZmlkLAogCQkJY2Fz
ZSBERU5ZX0FMTDogIGRfcHJpbnRmKCJERU5ZX0FMTCAgICIpOyBicmVhazsKIAkJCWNhc2UgREVO
WV9ET1M6ICBkX3ByaW50ZigiREVOWV9ET1MgICAiKTsgYnJlYWs7CiAJCQljYXNlIERFTllfUkVB
RDogZF9wcmludGYoIkRFTllfUkVBRCAgIik7IGJyZWFrOwotCQkJY2FzZSBERU5ZX1dSSVRFOnBy
aW50ZigiREVOWV9XUklURSAiKTsgYnJlYWs7CisJCQljYXNlIERFTllfV1JJVEU6ZF9wcmludGYo
IkRFTllfV1JJVEUgIik7IGJyZWFrOwogCQkJY2FzZSBERU5ZX0ZDQjogIGRfcHJpbnRmKCJERU5Z
X0ZDQiAiKTsgYnJlYWs7CiAJCQlkZWZhdWx0OiB7CiAJCQkJZF9wcmludGYoInVua25vd24tcGxl
YXNlIHJlcG9ydCAhICIKQEAgLTUwOCw3ICsxMTUzLDYgQEAgc3RhdGljIGludCB0cmF2ZXJzZV9z
ZXNzaW9uaWQoY29uc3QgY2hhciAqa2V5LCBzdHJ1Y3Qgc2Vzc2lvbmlkICpzZXNzaW9uLAogCXJl
dHVybiByZXN1bHQ7CiB9CiAKLQogc3RhdGljIGJvb2wgcHJpbnRfbm90aWZ5X3JlYyhjb25zdCBj
aGFyICpwYXRoLCBzdHJ1Y3Qgc2VydmVyX2lkIHNlcnZlciwKIAkJCSAgICAgY29uc3Qgc3RydWN0
IG5vdGlmeV9pbnN0YW5jZSAqaW5zdGFuY2UsCiAJCQkgICAgIHZvaWQgKnByaXZhdGVfZGF0YSkK
QEAgLTUzMCwxMCArMTE3NCwxMyBAQCBpbnQgbWFpbihpbnQgYXJnYywgY29uc3QgY2hhciAqYXJn
dltdKQogewogCWludCBjOwogCWludCBwcm9maWxlX29ubHkgPSAwOworCSNpZmRlZiBIQVZFX0pB
TlNTT04KKwljaGFyICpqc29uX3N0ciA9IE5VTEw7CisJc3RydWN0IGpzb25fb2JqZWN0IGpzb2Jq
ID0ganNvbl9uZXdfb2JqZWN0KCk7CisJI2VuZGlmIC8qIFtIQVZFX0pBTlNTT05dICovCiAJYm9v
bCBzaG93X3Byb2Nlc3Nlcywgc2hvd19sb2Nrcywgc2hvd19zaGFyZXM7CiAJYm9vbCBzaG93X25v
dGlmeSA9IGZhbHNlOwotCWJvb2wgcmVzb2x2ZV91aWRzID0gZmFsc2U7Ci0JcG9wdENvbnRleHQg
cGMgPSBOVUxMOworCXBvcHRDb250ZXh0IHBjOwogCXN0cnVjdCBwb3B0T3B0aW9uIGxvbmdfb3B0
aW9uc1tdID0gewogCQlQT1BUX0FVVE9IRUxQCiAJCXsKQEAgLTYyNSw2ICsxMjcyLDE0IEBAIGlu
dCBtYWluKGludCBhcmdjLCBjb25zdCBjaGFyICphcmd2W10pCiAJCQkuZGVzY3JpcCAgICA9ICJO
dW1lcmljIHVpZC9naWQiCiAJCX0sCiAJCXsKKwkJCS5sb25nTmFtZSAgID0gImpzb24iLAorCQkJ
LnNob3J0TmFtZSAgPSAnaicsCisJCQkuYXJnSW5mbyAgICA9IFBPUFRfQVJHX05PTkUsCisJCQku
YXJnICAgICAgICA9IE5VTEwsCisJCQkudmFsICAgICAgICA9ICdqJywKKwkJCS5kZXNjcmlwICAg
ID0gIkpTT04gb3V0cHV0IgorCQl9LAorCQl7CiAJCQkubG9uZ05hbWUgICA9ICJmYXN0IiwKIAkJ
CS5zaG9ydE5hbWUgID0gJ2YnLAogCQkJLmFyZ0luZm8gICAgPSBQT1BUX0FSR19OT05FLApAQCAt
NzA0LDYgKzEzNTksOSBAQCBpbnQgbWFpbihpbnQgYXJnYywgY29uc3QgY2hhciAqYXJndltdKQog
CQljYXNlICduJzoKIAkJCW51bWVyaWNfb25seSA9IHRydWU7CiAJCQlicmVhazsKKwkJY2FzZSAn
aic6CisJCQlqc29uX291dHB1dCA9IHRydWU7CisJCQlicmVhazsKIAkJY2FzZSAnZic6CiAJCQlk
b19jaGVja3MgPSBmYWxzZTsKIAkJCWJyZWFrOwpAQCAtNzIyLDcgKzEzODAsNyBAQCBpbnQgbWFp
bihpbnQgYXJnYywgY29uc3QgY2hhciAqYXJndltdKQogCWlmICggdXNlcm5hbWUgKQogCQlVY3Jp
dF9hZGRVaWQoIG5hbWV0b3VpZCh1c2VybmFtZSkgKTsKIAotCWlmICh2ZXJib3NlKSB7CisJaWYg
KHZlcmJvc2UgJiYgIWpzb25fb3V0cHV0KSB7CiAJCWRfcHJpbnRmKCJ1c2luZyBjb25maWdmaWxl
ID0gJXNcbiIsIGdldF9keW5fQ09ORklHRklMRSgpKTsKIAl9CiAKQEAgLTc1NiwxMSArMTQxNCwz
MCBAQCBpbnQgbWFpbihpbnQgYXJnYywgY29uc3QgY2hhciAqYXJndltdKQogCX0KIAogCWlmICgg
c2hvd19wcm9jZXNzZXMgKSB7Ci0JCWRfcHJpbnRmKCJcblNhbWJhIHZlcnNpb24gJXNcbiIsc2Ft
YmFfdmVyc2lvbl9zdHJpbmcoKSk7Ci0JCWRfcHJpbnRmKCIlLTdzICUtMTJzICUtMTJzICUtNDFz
ICUtMTdzICUtMjBzICUtMjFzXG4iLCAiUElEIiwgIlVzZXJuYW1lIiwgIkdyb3VwIiwgIk1hY2hp
bmUiLCAiUHJvdG9jb2wgVmVyc2lvbiIsICJFbmNyeXB0aW9uIiwgIlNpZ25pbmciKTsKLQkJZF9w
cmludGYoIi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiIpOworCQlpZiAoIWpzb25fb3V0cHV0KSB7
CisJCQlkX3ByaW50ZigiXG5TYW1iYSB2ZXJzaW9uICVzXG4iLHNhbWJhX3ZlcnNpb25fc3RyaW5n
KCkpOworCQkJZF9wcmludGYoIiUtN3MgJS0xMnMgJS0xMnMgJS00MXMgJS0xN3MgJS0yMHMgJS0y
MXNcbiIsICJQSUQiLCAiVXNlcm5hbWUiLCAiR3JvdXAiLCAiTWFjaGluZSIsICJQcm90b2NvbCBW
ZXJzaW9uIiwgIkVuY3J5cHRpb24iLCAiU2lnbmluZyIpOworCQkJZF9wcmludGYoIi0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS1cbiIpOworCQkJc2Vzc2lvbmlkX3RyYXZlcnNlX3JlYWQodHJhdmVyc2Vf
c2Vzc2lvbmlkLCBmcmFtZSk7CisJCX0KKwkJI2lmZGVmIEhBVkVfSkFOU1NPTgorCQllbHNlIHsK
KwkJCXN0cnVjdCBqc29uX29iamVjdCBzZXNzaW9ucyA9IGpzb25fbmV3X29iamVjdCgpOworCQkJ
aWYgKGpzb25faXNfaW52YWxpZCgmc2Vzc2lvbnMpKSB7CisJCQkJZF9wcmludGYoIkZhaWxlZCB0
byBjcmVhdGUgSlNPTiBvYmplY3QgW3Nlc3Npb25zXVxuIik7CisJCQkJcmV0ID0gLTE7CisJCQkJ
Z290byBkb25lOworCQkJfQogCi0JCXNlc3Npb25pZF90cmF2ZXJzZV9yZWFkKHRyYXZlcnNlX3Nl
c3Npb25pZCwgZnJhbWUpOworCQkJc2Vzc2lvbmlkX3RyYXZlcnNlX3JlYWQodHJhdmVyc2Vfc2Vz
c2lvbmlkX2pzb24sICZzZXNzaW9ucyk7CisJCQlpZiAoanNvbl9hZGRfb2JqZWN0KCZqc29iaiwg
InNlc3Npb25zIiwgJnNlc3Npb25zKSA8IDApIHsKKwkJCQlkX3ByaW50ZigiRmFpbGVkIHRvIGFk
ZCBKU09OIG9iamVjdCBbc2Vzc2lvbnNdXG4iKTsKKwkJCQlqc29uX2ZyZWUoJnNlc3Npb25zKTsK
KwkJCQlyZXQgPSAtMTsKKwkJCQlnb3RvIGRvbmU7CisJCQl9CisJCX0KKwkJI2VuZGlmIC8qIFtI
QVZFX0pBTlNTT05dICovCiAKIAkJaWYgKHByb2Nlc3Nlc19vbmx5KSB7CiAJCQlnb3RvIGRvbmU7
CkBAIC03NzEsMTMgKzE0NDgsMzMgQEAgaW50IG1haW4oaW50IGFyZ2MsIGNvbnN0IGNoYXIgKmFy
Z3ZbXSkKIAkJaWYgKGJyaWVmKSB7CiAJCQlnb3RvIGRvbmU7CiAJCX0KKyAKKwkJaWYgKCFqc29u
X291dHB1dCkgeworCQkJZF9wcmludGYoIlxuJS0xMnMgJS03cyAlLTEzcyAlLTMycyAlLTEycyAl
LTEyc1xuIiwgIlNlcnZpY2UiLCAicGlkIiwgIk1hY2hpbmUiLCAiQ29ubmVjdGVkIGF0IiwgIkVu
Y3J5cHRpb24iLCAiU2lnbmluZyIpOworCQkJZF9wcmludGYoIi0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLVxuIik7CisJCQljb25uZWN0aW9uc19mb3JhbGxfcmVhZCh0cmF2ZXJz
ZV9jb25uZWN0aW9ucywgZnJhbWUpOworCQl9CisJCSNpZmRlZiBIQVZFX0pBTlNTT04KKwkJZWxz
ZSB7CisJCQlzdHJ1Y3QganNvbl9vYmplY3Qgc2hhcmVzX2FycmF5ID0ganNvbl9uZXdfYXJyYXko
KTsKKwkJCWlmIChqc29uX2lzX2ludmFsaWQoJnNoYXJlc19hcnJheSkpIHsKKwkJCQlkX3ByaW50
ZigiRmFpbGVkIHRvIGNyZWF0ZSBKU09OIGFycmF5IFtzaGFyZXNfYXJyYXldXG4iKTsKKwkJCQly
ZXQgPSAxOworCQkJCWdvdG8gZG9uZTsKKwkJCX0KKwkJCWNvbm5lY3Rpb25zX2ZvcmFsbF9yZWFk
KHRyYXZlcnNlX2Nvbm5lY3Rpb25zX2pzb24sICZzaGFyZXNfYXJyYXkpOworCQkJaWYgKGpzb25f
YWRkX29iamVjdCgmanNvYmosICJzaGFyZXMiLCAmc2hhcmVzX2FycmF5KSA8IDApIHsKKwkJCQlk
X3ByaW50ZigiRmFpbGVkIHRvIGFkZCBKU09OIGFycmF5IFtzaGFyZXNfYXJyYXldXG4iKTsKKwkJ
CQlqc29uX2ZyZWUoJnNoYXJlc19hcnJheSk7CisJCQkJcmV0ID0gLTE7CisJCQkJZ290byBkb25l
OworCQkJfQogCi0JCWRfcHJpbnRmKCJcbiUtMTJzICUtN3MgJS0xM3MgJS0zMnMgJS0xMnMgJS0x
MnNcbiIsICJTZXJ2aWNlIiwgInBpZCIsICJNYWNoaW5lIiwgIkNvbm5lY3RlZCBhdCIsICJFbmNy
eXB0aW9uIiwgIlNpZ25pbmciKTsKLQkJZF9wcmludGYoIi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0t
LS0tLS0tLS0tLS0tLVxuIik7Ci0KLQkJY29ubmVjdGlvbnNfZm9yYWxsX3JlYWQodHJhdmVyc2Vf
Y29ubmVjdGlvbnMsIGZyYW1lKTsKLQotCQlkX3ByaW50ZigiXG4iKTsKKwkJCWlmICghanNvbl9v
dXRwdXQpIHsKKwkJCQlkX3ByaW50ZigiXG4iKTsKKwkJCX0KKwkJfQorCQkjZW5kaWYgLyogW0hB
VkVfSkFOU1NPTl0gKi8KIAogCQlpZiAoIHNoYXJlc19vbmx5ICkgewogCQkJZ290byBkb25lOwpA
QCAtODE1LDggKzE1MTIsMjcgQEAgaW50IG1haW4oaW50IGFyZ2MsIGNvbnN0IGNoYXIgKmFyZ3Zb
XSkKIAkJCXJldCA9IDE7CiAJCQlnb3RvIGRvbmU7CiAJCX0KLQotCQlyZXN1bHQgPSBzaGFyZV9l
bnRyeV9mb3JhbGwocHJpbnRfc2hhcmVfbW9kZSwgJnJlc29sdmVfdWlkcyk7CisJCWlmICghanNv
bl9vdXRwdXQpIHsKKwkJCXJlc3VsdCA9IHNoYXJlX2VudHJ5X2ZvcmFsbChwcmludF9zaGFyZV9t
b2RlLCBOVUxMKTsKKwkJfQorCQkjaWYgSEFWRV9KQU5TU09OCisJCWVsc2UgeworCQkJc3RydWN0
IGpzb25fb2JqZWN0IGxvY2tzX2FycmF5ID0ganNvbl9uZXdfYXJyYXkoKTsKKwkJCWlmIChqc29u
X2lzX2ludmFsaWQoJmxvY2tzX2FycmF5KSkgeworCQkJCWxvY2tpbmdfZW5kKCk7CisJCQkJZF9w
cmludGYoIkZhaWxlZCB0byBjcmVhdGUgSlNPTiBhcnJheSBbbG9ja3NfYXJyYXldXG4iKTsKKwkJ
CQlyZXQgPSAxOworCQkJCWdvdG8gZG9uZTsKKwkJCX0KKwkJCXJlc3VsdCA9IHNoYXJlX2VudHJ5
X2ZvcmFsbChwcmludF9zaGFyZV9tb2RlX2pzb24sICZsb2Nrc19hcnJheSk7CisJCQlpZiAoanNv
bl9hZGRfb2JqZWN0KCZqc29iaiwgImxvY2tlZF9maWxlcyIsICZsb2Nrc19hcnJheSkgPCAwKSB7
CisJCQkJbG9ja2luZ19lbmQoKTsKKwkJCQlkX3ByaW50ZigiRmFpbGVkIHRvIGFkZCBKU09OIGFy
cmF5IFtsb2Nrc19hcnJheV1cbiIpOworCQkJCXJldCA9IDE7CisJCQkJZ290byBkb25lOworCQkJ
fQorCQl9CisJCSNlbmRpZiAvKiBbSEFWRV9KQU5TU09OXSAqLwogCiAJCWlmIChyZXN1bHQgPT0g
MCkgewogCQkJZF9wcmludGYoIk5vIGxvY2tlZCBmaWxlc1xuIik7CkBAIC04MjQsMTEgKzE1NDAs
MzEgQEAgaW50IG1haW4oaW50IGFyZ2MsIGNvbnN0IGNoYXIgKmFyZ3ZbXSkKIAkJCWRfcHJpbnRm
KCJsb2NrZWQgZmlsZSBsaXN0IHRydW5jYXRlZFxuIik7CiAJCX0KIAotCQlkX3ByaW50ZigiXG4i
KTsKKwkJaWYgKCFqc29uX291dHB1dCkgeworCQkJZF9wcmludGYoIlxuIik7CisJCX0KIAotCQlp
ZiAoc2hvd19icmwpIHsKKwkJaWYgKHNob3dfYnJsICYmICFqc29uX291dHB1dCkgewogCQkJYnJs
X2ZvcmFsbChwcmludF9icmwsIE5VTEwpOwogCQl9CisJCSNpZiBIQVZFX0pBTlNTT04KKwkJZWxz
ZSBpZiAoc2hvd19icmwpIHsKKwkJCXN0cnVjdCBqc29uX29iamVjdCBicmxfYXJyYXkgPSBqc29u
X25ld19hcnJheSgpOworCQkJaWYgKGpzb25faXNfaW52YWxpZCgmYnJsX2FycmF5KSkgeworCQkJ
CWxvY2tpbmdfZW5kKCk7CisJCQkJZF9wcmludGYoIkZhaWxlZCB0byBjcmVhdGUgSlNPTiBhcnJh
eSBbYnJsX2FycmF5XVxuIik7CisJCQkJcmV0ID0gMTsKKwkJCQlnb3RvIGRvbmU7CisJCQl9CisJ
CQlicmxfZm9yYWxsKHByaW50X2JybF9qc29uLCAmYnJsX2FycmF5KTsKKwkJCWlmIChqc29uX2Fk
ZF9vYmplY3QoJmpzb2JqLCAiYnJsIiwgJmJybF9hcnJheSkgPCAwKSB7CisJCQkJbG9ja2luZ19l
bmQoKTsKKwkJCQlkX3ByaW50ZigiRmFpbGVkIHRvIGFkZCBKU09OIGFycmF5IFticmxfYXJyYXld
XG4iKTsKKwkJCQlyZXQgPSAxOworCQkJCWdvdG8gZG9uZTsKKwkJCX0KKwkJfQorCQkjZW5kaWYg
LyogW0hBVkVfSkFOU1NPTl0gKi8KIAogCQlsb2NraW5nX2VuZCgpOwogCX0KQEAgLTg0MSwxMiAr
MTU3NywzNyBAQCBpbnQgbWFpbihpbnQgYXJnYywgY29uc3QgY2hhciAqYXJndltdKQogCQlpZiAo
biA9PSBOVUxMKSB7CiAJCQlnb3RvIGRvbmU7CiAJCX0KLQkJbm90aWZ5X3dhbGsobiwgcHJpbnRf
bm90aWZ5X3JlYywgTlVMTCk7CisJCWlmICghanNvbl9vdXRwdXQpIHsKKwkJCW5vdGlmeV93YWxr
KG4sIHByaW50X25vdGlmeV9yZWMsIE5VTEwpOworCQl9CisJCSNpZiBIQVZFX0pBTlNTT04KKwkJ
ZWxzZSB7CisJCQlzdHJ1Y3QganNvbl9vYmplY3Qgbm90aWZ5X2FycmF5ID0ganNvbl9uZXdfYXJy
YXkoKTsKKwkJCWlmIChqc29uX2lzX2ludmFsaWQoJm5vdGlmeV9hcnJheSkpIHsKKwkJCQlsb2Nr
aW5nX2VuZCgpOworCQkJCWRfcHJpbnRmKCJGYWlsZWQgdG8gY3JlYXRlIEpTT04gYXJyYXkgW25v
dGlmeV9hcnJheV1cbiIpOworCQkJCXJldCA9IDE7CisJCQkJZ290byBkb25lOworCQkJfQorCQkJ
bm90aWZ5X3dhbGsobiwgcHJpbnRfbm90aWZ5X3JlY19qc29uLCAmbm90aWZ5X2FycmF5KTsKKwkJ
CWlmIChqc29uX2FkZF9vYmplY3QoJmpzb2JqLCAibm90aWZ5IiwgJm5vdGlmeV9hcnJheSkgPCAw
KSB7CisJCQkJbG9ja2luZ19lbmQoKTsKKwkJCQlkX3ByaW50ZigiRmFpbGVkIHRvIGFkZCBKU09O
IGFycmF5IFtub3RpZnlfYXJyYXldXG4iKTsKKwkJCQlyZXQgPSAxOworCQkJCWdvdG8gZG9uZTsK
KwkJCX0KKwkJfQorCQkjZW5kaWYgLyogW0hBVkVfSkFOU1NPTl0gKi8KIAkJVEFMTE9DX0ZSRUUo
bik7CiAJfQogCiBkb25lOgotCXBvcHRGcmVlQ29udGV4dChwYyk7CisJI2lmZGVmIEhBVkVfSkFO
U1NPTgorCWlmIChqc29uX291dHB1dCkgeworCQlkX3ByaW50ZigiJXNcbiIsIGpzb25fdG9fc3Ry
aW5nKGZyYW1lLCAmanNvYmopKTsKKwl9CisJanNvbl9mcmVlKCZqc29iaik7CisJI2VuZGlmIEhB
VkVfSkFOU1NPTgogCVRBTExPQ19GUkVFKGZyYW1lKTsKIAlyZXR1cm4gcmV0OwogfQo=
--0000000000009c2e8a059144f4e1--

