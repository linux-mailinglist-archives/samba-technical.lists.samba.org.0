Return-Path: <samba-technical-bounces@lists.samba.org>
X-Original-To: lists+samba-technical@lfdr.de
Delivered-To: lists+samba-technical@lfdr.de
Received: from hr1.samba.org (hr1.samba.org [IPv6:2a01:4f8:192:486::1:0])
	by mail.lfdr.de (Postfix) with ESMTPS id C339430B6B0
	for <lists+samba-technical@lfdr.de>; Tue,  2 Feb 2021 05:49:27 +0100 (CET)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
	d=lists.samba.org; s=2954282; h=Cc:From:List-Id:To:Subject:Date;
	bh=5qo3Y6a156Muu9ZuNI0M6zIN06kI/WyI3S1KWgKiOfc=; b=gEHmikSHwyLBUtezUheiH7WXtS
	xogN13WJwWgeMU0Zan453v0Ef941Z7PtfolV2/jhI0Fr6EA7Z+AqXnUnDsIs/hhXZafAA8TfHxZFj
	OIpmBeWgdYEbXrYygT0kVbR+/8XSv7gyAsHxSD5StZ6D7I0WKgmxoDOhc7n0X1AdR+C6GgDT/OVcb
	mkuR/pQCOecP5ThF/UEvtODvMxAbegnLHAxiW7YDsJe+tEKzVsb5wcvYRDk/8SbIr4InnufcC7S0T
	p2SKq/bolaBJjmxdAJV2K/Pux4hLDUpagqK6IV84cCgppkYEqJnfsmEz54ZclxeGfFu52s95Qi1yA
	Bu2K/uag==;
Received: from ip6-localhost ([::1]:21370 helo=hr1.samba.org) 
	by hr1.samba.org with esmtp (Exim)
	id 1l6ncD-00A7no-Ft; Tue, 02 Feb 2021 04:48:37 +0000
Received: from mail-lj1-x22c.google.com ([2a00:1450:4864:20::22c]:40617) 
 by hr1.samba.org with esmtps (TLS1.3:ECDHE_RSA_CHACHA20_POLY1305:256)
 (Exim) id 1l6nc5-00A7nh-JK
 for samba-technical@lists.samba.org; Tue, 02 Feb 2021 04:48:33 +0000
Received: by mail-lj1-x22c.google.com with SMTP id s18so22441851ljg.7
 for <samba-technical@lists.samba.org>; Mon, 01 Feb 2021 20:48:27 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
 h=mime-version:references:in-reply-to:from:date:message-id:subject:to
 :cc:content-transfer-encoding;
 bh=5qo3Y6a156Muu9ZuNI0M6zIN06kI/WyI3S1KWgKiOfc=;
 b=EimTH8opxE4otirrlt/TSvxUhZRa9z9/aUtylCHNFHzGsi4ZAowvODdzP2F2LMdtir
 jDD70fiSqWj/+614G3Yn5VIG42mEoS7NYpdZ5ArGJrHQTsQFBGJ4n4ntIrcX0J8EHJ8g
 DAecWboHmOgsxLx7zBYQI1hovNOKCvQ7Z8y4ll1oQyZWP5Jk68BSWRPMQ/RTbarV0Usr
 ItU5DhNJsY+S4MVkk19Mb0/Q7RkegjrP5VGciyVnaFuGprXCiVgeMF0/Zw2ORet7jglm
 7mgl0HaJO6JsEqBO5US8WFlm+Q686TgonfLuR11WNWOglV2F1FD9YZ1vhABuGCUXo3xR
 9HGA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:mime-version:references:in-reply-to:from:date
 :message-id:subject:to:cc:content-transfer-encoding;
 bh=5qo3Y6a156Muu9ZuNI0M6zIN06kI/WyI3S1KWgKiOfc=;
 b=fUzMkLQJyTuuRqcf6wJx6CMi/Zy259GckIdPVOTIwbM0m2F3bIXSAWoId3Wz3n5FT7
 otdBpVpy1HjOSIBKmsXKuBwmbTHFbieFPPAx+GeOPvbSDPoP6xF22QPixI4e+CurahGg
 Vlmkmi0E9YrG2syVza9ViTBflSYjUDgKmS8ByKPM4Y+EiWQns7kYkkEHMDFSGAA4TttZ
 vtUgtYps+tT9a5eXNR3gPoVo2xqa7RZ0qC4IEyhrdrRVkYpCrp35l6pK/l95UiTUjgkq
 JPU2HUsMSuvPJX6UlXip7OWa6kvUq+ZxUzbZrJyMk7BeYRlM4a8GZSky+sZiym+T1qnq
 VzMQ==
X-Gm-Message-State: AOAM533csMOU2SAAr5JoSd6GE6+w+xxWvohLBS24dloVwfdH3nS5sDgj
 o0eTnOAyLoa2YvGznZ1wUAtjOER4Ek/ERxDH9j8=
X-Google-Smtp-Source: ABdhPJyEI9a1hvqxYDAV9f3YF2bnd3NL5TOuX7qvSr9dcZDJgJ5nrN43iJXiZf9+wcfNLe9C15MWAJCrkCBZS5nIams=
X-Received: by 2002:a2e:9d8c:: with SMTP id c12mr11881596ljj.6.1612241307146; 
 Mon, 01 Feb 2021 20:48:27 -0800 (PST)
MIME-Version: 1.0
References: <20210202023654.GA265921@embeddedor>
In-Reply-To: <20210202023654.GA265921@embeddedor>
Date: Mon, 1 Feb 2021 22:48:16 -0600
Message-ID: <CAH2r5msYsp4JxCcCRR1HY3y-Czh2UKJfV=DoKccG=Fcunc8hNQ@mail.gmail.com>
Subject: Re: [PATCH] smb3: Fix out-of-bounds bug in SMB2_negotiate()
To: "Gustavo A. R. Silva" <gustavoars@kernel.org>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable
X-BeenThere: samba-technical@lists.samba.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: "Discussions on Samba internals. For general questions please
 subscribe to the list samba@lists.samba.org"
 <samba-technical.lists.samba.org>
List-Unsubscribe: <https://lists.samba.org/mailman/options/samba-technical>,
 <mailto:samba-technical-request@lists.samba.org?subject=unsubscribe>
List-Archive: <http://lists.samba.org/pipermail/samba-technical/>
List-Post: <mailto:samba-technical@lists.samba.org>
List-Help: <mailto:samba-technical-request@lists.samba.org?subject=help>
List-Subscribe: <https://lists.samba.org/mailman/listinfo/samba-technical>,
 <mailto:samba-technical-request@lists.samba.org?subject=subscribe>
From: Steve French via samba-technical <samba-technical@lists.samba.org>
Reply-To: Steve French <smfrench@gmail.com>
Cc: CIFS <linux-cifs@vger.kernel.org>,
 samba-technical <samba-technical@lists.samba.org>,
 LKML <linux-kernel@vger.kernel.org>, Ronnie Sahlberg <lsahlber@redhat.com>,
 Steve French <sfrench@samba.org>, linux-hardening@vger.kernel.org,
 Pavel Shilovsky <pshilov@microsoft.com>
Errors-To: samba-technical-bounces@lists.samba.org
Sender: "samba-technical" <samba-technical-bounces@lists.samba.org>

merged into cifs-2.6.git for-next

On Mon, Feb 1, 2021 at 8:38 PM Gustavo A. R. Silva
<gustavoars@kernel.org> wrote:
>
> While addressing some warnings generated by -Warray-bounds, I found this
> bug that was introduced back in 2017:
>
>   CC [M]  fs/cifs/smb2pdu.o
> fs/cifs/smb2pdu.c: In function =E2=80=98SMB2_negotiate=E2=80=99:
> fs/cifs/smb2pdu.c:822:16: warning: array subscript 1 is above array bound=
s
> of =E2=80=98__le16[1]=E2=80=99 {aka =E2=80=98short unsigned int[1]=E2=80=
=99} [-Warray-bounds]
>   822 |   req->Dialects[1] =3D cpu_to_le16(SMB30_PROT_ID);
>       |   ~~~~~~~~~~~~~^~~
> fs/cifs/smb2pdu.c:823:16: warning: array subscript 2 is above array bound=
s
> of =E2=80=98__le16[1]=E2=80=99 {aka =E2=80=98short unsigned int[1]=E2=80=
=99} [-Warray-bounds]
>   823 |   req->Dialects[2] =3D cpu_to_le16(SMB302_PROT_ID);
>       |   ~~~~~~~~~~~~~^~~
> fs/cifs/smb2pdu.c:824:16: warning: array subscript 3 is above array bound=
s
> of =E2=80=98__le16[1]=E2=80=99 {aka =E2=80=98short unsigned int[1]=E2=80=
=99} [-Warray-bounds]
>   824 |   req->Dialects[3] =3D cpu_to_le16(SMB311_PROT_ID);
>       |   ~~~~~~~~~~~~~^~~
> fs/cifs/smb2pdu.c:816:16: warning: array subscript 1 is above array bound=
s
> of =E2=80=98__le16[1]=E2=80=99 {aka =E2=80=98short unsigned int[1]=E2=80=
=99} [-Warray-bounds]
>   816 |   req->Dialects[1] =3D cpu_to_le16(SMB302_PROT_ID);
>       |   ~~~~~~~~~~~~~^~~
>
> At the time, the size of array _Dialects_ was changed from 1 to 3 in stru=
ct
> validate_negotiate_info_req, and then in 2019 it was changed from 3 to 4,
> but those changes were never made in struct smb2_negotiate_req, which has
> led to a 3 and a half years old out-of-bounds bug in function
> SMB2_negotiate() (fs/cifs/smb2pdu.c).
>
> Fix this by increasing the size of array _Dialects_ in struct
> smb2_negotiate_req to 4.
>
> Fixes: 9764c02fcbad ("SMB3: Add support for multidialect negotiate (SMB2.=
1 and later)")
> Fixes: d5c7076b772a ("smb3: add smb3.1.1 to default dialect list")
> Cc: stable@vger.kernel.org
> Signed-off-by: Gustavo A. R. Silva <gustavoars@kernel.org>
> ---
>  fs/cifs/smb2pdu.h | 2 +-
>  1 file changed, 1 insertion(+), 1 deletion(-)
>
> diff --git a/fs/cifs/smb2pdu.h b/fs/cifs/smb2pdu.h
> index d85edf5d1429..a5a9e33c0d73 100644
> --- a/fs/cifs/smb2pdu.h
> +++ b/fs/cifs/smb2pdu.h
> @@ -286,7 +286,7 @@ struct smb2_negotiate_req {
>         __le32 NegotiateContextOffset; /* SMB3.1.1 only. MBZ earlier */
>         __le16 NegotiateContextCount;  /* SMB3.1.1 only. MBZ earlier */
>         __le16 Reserved2;
> -       __le16 Dialects[1]; /* One dialect (vers=3D) at a time for now */
> +       __le16 Dialects[4]; /* BB expand this if autonegotiate > 4 dialec=
ts */
>  } __packed;
>
>  /* Dialects */
> --
> 2.27.0
>


--=20
Thanks,

Steve

