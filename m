Return-Path: <samba-technical-bounces@lists.samba.org>
X-Original-To: lists+samba-technical@lfdr.de
Delivered-To: lists+samba-technical@lfdr.de
Received: from hr1.samba.org (hr1.samba.org [IPv6:2a01:4f8:192:486::443:1])
	by mail.lfdr.de (Postfix) with ESMTPS id 60732142C8
	for <lists+samba-technical@lfdr.de>; Mon,  6 May 2019 00:24:09 +0200 (CEST)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
	d=lists.samba.org; s=2954282; h=From:List-Id:Date:Subject:To:cc;
	bh=tO6vCZlN05nha+hPZYK+W2wTiv1TvgwC5TPnnP1b9uI=; b=fIy/cnTx/fujbj9J3HSbQPmk/Q
	6hozzn8QEb0a7CeHLqWAbwEXLxsTi9lYTk4sXpXQUlJyQzBxRwK5aQRtqI8pqvj4qfit5uCT+Kt+S
	l7Elf/kPfI6j+IbMKZEp1ZMYEGVoPGUVg83yStVzh2zAd1YK7V+/4DSmBXyVZb0ot794CbyHeU324
	mcwQqGep2cfjkv2ZdRc+ryrwXtX5itvQ8Cf3ojzQK2+tO7NY19pJCyIqmy9N4u124/c5Gncl+HXq5
	HsFBrjf9Vf3LqlgefpL/u6w5ISGDGiSxOXPnq4Wnp34S8NV8S7WhZ5+F86nuqr5BRP7casFqou5lN
	OPw9yhPA==;
Received: from localhost ([::1]:47092 helo=hr1.samba.org) 
	by hr1.samba.org with esmtp (Exim)
	id 1hNPXF-002UUy-Nm; Sun, 05 May 2019 22:23:05 +0000
Received: from cat-porwal-prod-mail1.catalyst.net.nz
 ([2404:130:4080::4]:47128) 
 by hr1.samba.org with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
 (Exim) id 1hNPX8-002UUr-La
 for samba-technical@lists.samba.org; Sun, 05 May 2019 22:23:03 +0000
Received: from [IPv6:2404:130:0:1000:cd33:6df5:c1f3:8bac] (unknown
 [IPv6:2404:130:0:1000:cd33:6df5:c1f3:8bac])
 (Authenticated sender: gary@catalyst.net.nz)
 by cat-porwal-prod-mail1.catalyst.net.nz (Postfix) with ESMTPSA id 2D25F8110D
 for <samba-technical@lists.samba.org>; Mon,  6 May 2019 10:22:48 +1200 (NZST)
To: Samba Technical <samba-technical@lists.samba.org>
Subject: [PATCH] s4 dns_server Bind9: Log opertion durations
Openpgp: preference=signencrypt
Message-ID: <ebac6abb-b29b-eda5-9e74-2e652e1f67a0@catalyst.net.nz>
Date: Mon, 6 May 2019 10:22:42 +1200
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.6.1
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha512;
 protocol="application/pgp-signature";
 boundary="CgKshLslqwmZ8mna9BATFSygSXvZfq4OE"
X-BeenThere: samba-technical@lists.samba.org
X-Mailman-Version: 2.1.23
Precedence: list
List-Id: "Discussions on Samba internals. For general questions please
 subscribe to the list samba@lists.samba.org"
 <samba-technical.lists.samba.org>
List-Unsubscribe: <https://lists.samba.org/mailman/options/samba-technical>,
 <mailto:samba-technical-request@lists.samba.org?subject=unsubscribe>
List-Archive: <http://lists.samba.org/pipermail/samba-technical/>
List-Post: <mailto:samba-technical@lists.samba.org>
List-Help: <mailto:samba-technical-request@lists.samba.org?subject=help>
List-Subscribe: <https://lists.samba.org/mailman/listinfo/samba-technical>,
 <mailto:samba-technical-request@lists.samba.org?subject=subscribe>
From: Gary Lockyer via samba-technical <samba-technical@lists.samba.org>
Reply-To: Gary Lockyer <gary@catalyst.net.nz>
Errors-To: samba-technical-bounces@lists.samba.org
Sender: "samba-technical" <samba-technical-bounces@lists.samba.org>

This is an OpenPGP/MIME signed message (RFC 4880 and 3156)
--CgKshLslqwmZ8mna9BATFSygSXvZfq4OE
Content-Type: multipart/mixed; boundary="VtRtCG7mmJCtIJNUTcQo40d1y7qlfWZIU";
 protected-headers="v1"
From: Gary Lockyer <gary@catalyst.net.nz>
To: Samba Technical <samba-technical@lists.samba.org>
Message-ID: <ebac6abb-b29b-eda5-9e74-2e652e1f67a0@catalyst.net.nz>
Subject: [PATCH] s4 dns_server Bind9: Log opertion durations

--VtRtCG7mmJCtIJNUTcQo40d1y7qlfWZIU
Content-Type: multipart/mixed;
 boundary="------------14DA0F0A1246DDD1E50C0013"
Content-Language: en-NZ

This is a multi-part message in MIME format.
--------------14DA0F0A1246DDD1E50C0013
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: quoted-printable

Add duration debug logging to the samba bind9 dlz driver and the
dnsserver_common routines.  This should aid future diagnosis of
performance issues, and could be used to monitor DNS performance.

The logs are currently Human readable text only, i.e. no JSON formatted
output.

Log lines are of the form:

dns_common_log_operation: [<op>] result: [<result>] \
duration: (<duration>) zone: [<zone>] name: [<name>] \
data: [<data>]

e.g.

dns_common_log_operation: [wildcard_lookup] result: [WERR_OK] \
duration: (111) zone: [(null)] \
name: [DC=3D_ldap._tcp.Default-First-Site-Name._sites.ForestDnsZones,\
DC=3Dchgdcpassword.samba.example.com,CN=3DMicrosoftDNS,DC=3DDomainDnsZone=
s,\
DC=3Dchgdcpassword,DC=3Dsamba,DC=3Dexample,DC=3Dcom] data: [(null)]

Enabled by setting log level to "dns:10"

durations are in microseconds.

Merge Request: https://gitlab.com/samba-team/samba/merge_requests/414

Review appreciated

Ng=C4=81 mihi
Gary

--------------14DA0F0A1246DDD1E50C0013
Content-Type: text/plain; charset=UTF-8;
 name="414.patch.txt"
Content-Transfer-Encoding: base64
Content-Disposition: attachment;
 filename="414.patch.txt"

RnJvbSA5NTFlY2NmZjNkMzljYjFmM2NjOTI1M2YzYzkzZjFlYzhiNzk3Yjk1IE1vbiBTZXAg
MTcgMDA6MDA6MDAgMjAwMQpGcm9tOiBHYXJ5IExvY2t5ZXIgPGdhcnlAY2F0YWx5c3QubmV0
Lm56PgpEYXRlOiBGcmksIDUgQXByIDIwMTkgMTE6MTM6MTUgKzEzMDAKU3ViamVjdDogW1BB
VENIXSBzNCBkbnNfc2VydmVyIEJpbmQ5OiBMb2cgb3BlcnRpb24gZHVyYXRpb25zCgpBZGQg
ZHVyYXRpb24gZGVidWcgbG9nZ2luZyB0byB0aGUgc2FtYmEgYmluZDkgZGx6IGRyaXZlciBh
bmQgdGhlCmRuc3NlcnZlcl9jb21tb24gcm91dGluZXMuICBUaGlzIHNob3VsZCBhaWQgZnV0
dXJlIGRpYWdub3NpcyBvZgpwZXJmb3JtYW5jZSBpc3N1ZXMsIGFuZCBjb3VsZCBiZSB1c2Vk
IHRvIG1vbml0b3IgRE5TIHBlcmZvcm1hbmNlLgoKVGhlIGxvZ3MgYXJlIGN1cnJlbnRseSBI
dW1hbiByZWFkYWJsZSB0ZXh0IG9ubHksIGkuZS4gbm8gSlNPTiBmb3JtYXR0ZWQKb3V0cHV0
LgoKTG9nIGxpbmVzIGFyZSBvZiB0aGUgZm9ybToKCmRuc19jb21tb25fbG9nX29wZXJhdGlv
bjogWzxvcD5dIHJlc3VsdDogWzxyZXN1bHQ+XSBcCmR1cmF0aW9uOiAoPGR1cmF0aW9uPikg
em9uZTogWzx6b25lPl0gbmFtZTogWzxuYW1lPl0gXApkYXRhOiBbPGRhdGE+XQoKZS5nLgoK
ZG5zX2NvbW1vbl9sb2dfb3BlcmF0aW9uOiBbd2lsZGNhcmRfbG9va3VwXSByZXN1bHQ6IFtX
RVJSX09LXSBcCmR1cmF0aW9uOiAoMTExKSB6b25lOiBbKG51bGwpXSBcCm5hbWU6IFtEQz1f
bGRhcC5fdGNwLkRlZmF1bHQtRmlyc3QtU2l0ZS1OYW1lLl9zaXRlcy5Gb3Jlc3REbnNab25l
cyxcCkRDPWNoZ2RjcGFzc3dvcmQuc2FtYmEuZXhhbXBsZS5jb20sQ049TWljcm9zb2Z0RE5T
LERDPURvbWFpbkRuc1pvbmVzLFwKREM9Y2hnZGNwYXNzd29yZCxEQz1zYW1iYSxEQz1leGFt
cGxlLERDPWNvbV0gZGF0YTogWyhudWxsKV0KCkVuYWJsZWQgYnkgc2V0dGluZyBsb2cgbGV2
ZWwgdG8gImRuczoxMCIKCmR1cmF0aW9ucyBhcmUgaW4gbWljcm9zZWNvbmRzLgoKU2lnbmVk
LW9mZi1ieTogR2FyeSBMb2NreWVyIDxnYXJ5QGNhdGFseXN0Lm5ldC5uej4KLS0tCiBzb3Vy
Y2U0L2Ruc19zZXJ2ZXIvZGx6X2JpbmQ5LmMgICAgICAgIHwgMzE1ICsrKysrKysrKysrKysr
KysrKysrLS0tLS0tCiBzb3VyY2U0L2Ruc19zZXJ2ZXIvZG5zc2VydmVyX2NvbW1vbi5jIHwg
MTcwICsrKysrKysrKysrLS0tCiBzb3VyY2U0L2Ruc19zZXJ2ZXIvZG5zc2VydmVyX2NvbW1v
bi5oIHwgICA2ICsKIDMgZmlsZXMgY2hhbmdlZCwgMzgzIGluc2VydGlvbnMoKyksIDEwOCBk
ZWxldGlvbnMoLSkKCmRpZmYgLS1naXQgYS9zb3VyY2U0L2Ruc19zZXJ2ZXIvZGx6X2JpbmQ5
LmMgYi9zb3VyY2U0L2Ruc19zZXJ2ZXIvZGx6X2JpbmQ5LmMKaW5kZXggMGU3ZmNmYzJjMjUu
LmY0Mzc5Y2Y2MjJmIDEwMDY0NAotLS0gYS9zb3VyY2U0L2Ruc19zZXJ2ZXIvZGx6X2JpbmQ5
LmMKKysrIGIvc291cmNlNC9kbnNfc2VydmVyL2Rsel9iaW5kOS5jCkBAIC04Miw2ICs4Miwz
OCBAQCBzdGF0aWMgY29uc3QgY2hhciAqem9uZV9wcmVmaXhlc1tdID0gewogCU5VTEwKIH07
CiAKKy8qCisgKiBHZXQgYSBwcmludGFibGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uIG9mIGFu
IGlzY19yZXN1bHRfdAorICovCitzdGF0aWMgY29uc3QgY2hhciAqaXNjX3Jlc3VsdF9zdHIo
IGNvbnN0IGlzY19yZXN1bHRfdCByZXN1bHQpIHsKKwlzd2l0Y2ggKHJlc3VsdCkgeworCWNh
c2UgSVNDX1JfU1VDQ0VTUzoKKwkJcmV0dXJuICJJU0NfUl9TVUNDRVNTIjsKKwljYXNlIElT
Q19SX05PTUVNT1JZOgorCQlyZXR1cm4gIklTQ19SX05PTUVNT1JZIjsKKwljYXNlIElTQ19S
X05PUEVSTToKKwkJcmV0dXJuICJJU0NfUl9OT1BFUk0iOworCWNhc2UgSVNDX1JfTk9TUEFD
RToKKwkJcmV0dXJuICJJU0NfUl9OT1NQQUNFIjsKKwljYXNlIElTQ19SX05PVEZPVU5EOgor
CQlyZXR1cm4gIklTQ19SX05PVEZPVU5EIjsKKwljYXNlIElTQ19SX0ZBSUxVUkU6CisJCXJl
dHVybiAiSVNDX1JfRkFJTFVSRSI7CisJY2FzZSBJU0NfUl9OT1RJTVBMRU1FTlRFRDoKKwkJ
cmV0dXJuICJJU0NfUl9OT1RJTVBMRU1FTlRFRCI7CisJY2FzZSBJU0NfUl9OT01PUkU6CisJ
CXJldHVybiAiSVNDX1JfTk9NT1JFIjsKKwljYXNlIElTQ19SX0lOVkFMSURGSUxFOgorCQly
ZXR1cm4gIklTQ19SX0lOVkFMSURGSUxFIjsKKwljYXNlIElTQ19SX1VORVhQRUNURUQ6CisJ
CXJldHVybiAiSVNDX1JfVU5FWFBFQ1RFRCI7CisJY2FzZSBJU0NfUl9GSUxFTk9URk9VTkQ6
CisJCXJldHVybiAiSVNDX1JfRklMRU5PVEZPVU5EIjsKKwlkZWZhdWx0OgorCQlyZXR1cm4g
IlVOS05PV04iOworCX0KK30KKwogLyoKICAgcmV0dXJuIHRoZSB2ZXJzaW9uIG9mIHRoZSBB
UEkKICAqLwpAQCAtOTI2LDggKzk1OCwxOSBAQCBfUFVCTElDXyBpc2NfcmVzdWx0X3QgZGx6
X2ZpbmR6b25lZGIodm9pZCAqZGJkYXRhLCBjb25zdCBjaGFyICpuYW1lLAogCQkJCSAgICAg
ZG5zX2NsaWVudGluZm9fdCAqY2xpZW50aW5mbykKICNlbmRpZgogeworCXN0cnVjdCB0aW1l
dmFsIHN0YXJ0ID0gdGltZXZhbF9jdXJyZW50KCk7CiAJc3RydWN0IGRsel9iaW5kOV9kYXRh
ICpzdGF0ZSA9IHRhbGxvY19nZXRfdHlwZV9hYm9ydChkYmRhdGEsIHN0cnVjdCBkbHpfYmlu
ZDlfZGF0YSk7Ci0JcmV0dXJuIGI5X2ZpbmRfem9uZV9kbihzdGF0ZSwgbmFtZSwgTlVMTCwg
TlVMTCk7CisJaXNjX3Jlc3VsdF90IHJlc3VsdCA9IElTQ19SX1NVQ0NFU1M7CisKKwlyZXN1
bHQgPSBiOV9maW5kX3pvbmVfZG4oc3RhdGUsIG5hbWUsIE5VTEwsIE5VTEwpOworCWRuc19j
b21tb25fbG9nX29wZXJhdGlvbigKKwkJImRsel9maW5kem9uZWRiIiwKKwkJaXNjX3Jlc3Vs
dF9zdHIocmVzdWx0KSwKKwkJJnN0YXJ0LAorCQlOVUxMLAorCQluYW1lLAorCQlOVUxMKTsK
KwlyZXR1cm4gcmVzdWx0OwogfQogCiAKQEAgLTEwNDAsNyArMTA4MywxOSBAQCBfUFVCTElD
XyBpc2NfcmVzdWx0X3QgZGx6X2xvb2t1cChjb25zdCBjaGFyICp6b25lLCBjb25zdCBjaGFy
ICpuYW1lLAogI2VuZGlmCiB7CiAJc3RydWN0IGRsel9iaW5kOV9kYXRhICpzdGF0ZSA9IHRh
bGxvY19nZXRfdHlwZV9hYm9ydChkYmRhdGEsIHN0cnVjdCBkbHpfYmluZDlfZGF0YSk7Ci0J
cmV0dXJuIGRsel9sb29rdXBfdHlwZXMoc3RhdGUsIHpvbmUsIG5hbWUsIGxvb2t1cCwgTlVM
TCk7CisJaXNjX3Jlc3VsdF90IHJlc3VsdCA9IElTQ19SX1NVQ0NFU1M7CisJc3RydWN0IHRp
bWV2YWwgc3RhcnQgPSB0aW1ldmFsX2N1cnJlbnQoKTsKKworCXJlc3VsdCA9IGRsel9sb29r
dXBfdHlwZXMoc3RhdGUsIHpvbmUsIG5hbWUsIGxvb2t1cCwgTlVMTCk7CisJZG5zX2NvbW1v
bl9sb2dfb3BlcmF0aW9uKAorCQkiZGx6X2xvb2t1cCIsCisJCWlzY19yZXN1bHRfc3RyKHJl
c3VsdCksCisJCSZzdGFydCwKKwkJem9uZSwKKwkJbmFtZSwKKwkJTlVMTCk7CisKKwlyZXR1
cm4gcmVzdWx0OwogfQogCiAKQEAgLTEwNjEsNiArMTExNiw3IEBAIF9QVUJMSUNfIGlzY19y
ZXN1bHRfdCBkbHpfYWxsb3d6b25leGZyKHZvaWQgKmRiZGF0YSwgY29uc3QgY2hhciAqbmFt
ZSwgY29uc3QgY2hhCiBfUFVCTElDXyBpc2NfcmVzdWx0X3QgZGx6X2FsbG5vZGVzKGNvbnN0
IGNoYXIgKnpvbmUsIHZvaWQgKmRiZGF0YSwKIAkJCQkgICBkbnNfc2RsemFsbG5vZGVzX3Qg
KmFsbG5vZGVzKQogeworCXN0cnVjdCB0aW1ldmFsIHN0YXJ0ID0gdGltZXZhbF9jdXJyZW50
KCk7CiAJc3RydWN0IGRsel9iaW5kOV9kYXRhICpzdGF0ZSA9IHRhbGxvY19nZXRfdHlwZV9h
Ym9ydChkYmRhdGEsIHN0cnVjdCBkbHpfYmluZDlfZGF0YSk7CiAJY29uc3QgY2hhciAqYXR0
cnNbXSA9IHsgImRuc1JlY29yZCIsIE5VTEwgfTsKIAlpbnQgcmV0ID0gTERCX0VSUl9OT19T
VUNIX09CSkVDVDsKQEAgLTEwNjksNiArMTEyNSw3IEBAIF9QVUJMSUNfIGlzY19yZXN1bHRf
dCBkbHpfYWxsbm9kZXMoY29uc3QgY2hhciAqem9uZSwgdm9pZCAqZGJkYXRhLAogCXN0cnVj
dCBsZGJfcmVzdWx0ICpyZXM7CiAJVEFMTE9DX0NUWCAqdG1wX2N0eCA9IHRhbGxvY19uZXco
c3RhdGUpOwogCXN0cnVjdCBsZGJfdmFsIHpvbmVfbmFtZV92YWwgPSBkYXRhX2Jsb2Jfc3Ry
aW5nX2NvbnN0KHpvbmUpOworCWlzY19yZXN1bHRfdCByZXN1bHQgPSBJU0NfUl9TVUNDRVNT
OwogCiAJZm9yIChpPTA7IHpvbmVfcHJlZml4ZXNbaV07IGkrKykgewogCQljb25zdCBjaGFy
ICpjYXNlZm9sZDsKQEAgLTEwNzYsNyArMTEzMyw4IEBAIF9QVUJMSUNfIGlzY19yZXN1bHRf
dCBkbHpfYWxsbm9kZXMoY29uc3QgY2hhciAqem9uZSwgdm9pZCAqZGJkYXRhLAogCQlkbiA9
IGxkYl9kbl9jb3B5KHRtcF9jdHgsIGxkYl9nZXRfZGVmYXVsdF9iYXNlZG4oc3RhdGUtPnNh
bWRiKSk7CiAJCWlmIChkbiA9PSBOVUxMKSB7CiAJCQl0YWxsb2NfZnJlZSh0bXBfY3R4KTsK
LQkJCXJldHVybiBJU0NfUl9OT01FTU9SWTsKKwkJCXJlc3VsdCA9IElTQ19SX05PTUVNT1JZ
OworCQkJZ290byBleGl0OwogCQl9CiAKIAkJLyoKQEAgLTEwODksNyArMTE0Nyw4IEBAIF9Q
VUJMSUNfIGlzY19yZXN1bHRfdCBkbHpfYWxsbm9kZXMoY29uc3QgY2hhciAqem9uZSwgdm9p
ZCAqZGJkYXRhLAogCQkJCQkgICJEQz1YLCVzIiwKIAkJCQkJICB6b25lX3ByZWZpeGVzW2ld
KSkgewogCQkJdGFsbG9jX2ZyZWUodG1wX2N0eCk7Ci0JCQlyZXR1cm4gSVNDX1JfTk9NRU1P
Ulk7CisJCQlyZXN1bHQgPSBJU0NfUl9OT01FTU9SWTsKKwkJCWdvdG8gZXhpdDsKIAkJfQog
CiAJCXJldCA9IGxkYl9kbl9zZXRfY29tcG9uZW50KGRuLApAQCAtMTA5OCw3ICsxMTU3LDgg
QEAgX1BVQkxJQ18gaXNjX3Jlc3VsdF90IGRsel9hbGxub2Rlcyhjb25zdCBjaGFyICp6b25l
LCB2b2lkICpkYmRhdGEsCiAJCQkJCSAgIHpvbmVfbmFtZV92YWwpOwogCQlpZiAocmV0ICE9
IExEQl9TVUNDRVNTKSB7CiAJCQl0YWxsb2NfZnJlZSh0bXBfY3R4KTsKLQkJCXJldHVybiBJ
U0NfUl9OT01FTU9SWTsKKwkJCXJlc3VsdCA9IElTQ19SX05PTUVNT1JZOworCQkJZ290byBl
eGl0OwogCQl9CiAKIAkJLyoKQEAgLTExMDksNyArMTE2OSw4IEBAIF9QVUJMSUNfIGlzY19y
ZXN1bHRfdCBkbHpfYWxsbm9kZXMoY29uc3QgY2hhciAqem9uZSwgdm9pZCAqZGJkYXRhLAog
CQljYXNlZm9sZCA9IGxkYl9kbl9nZXRfY2FzZWZvbGQoZG4pOwogCiAJCWlmIChjYXNlZm9s
ZCA9PSBOVUxMKSB7Ci0JCQlyZXR1cm4gSVNDX1JfTk9URk9VTkQ7CisJCQlyZXN1bHQgPSBJ
U0NfUl9OT1RGT1VORDsKKwkJCWdvdG8gZXhpdDsKIAkJfQogCiAJCXJldCA9IGxkYl9zZWFy
Y2goc3RhdGUtPnNhbWRiLCB0bXBfY3R4LCAmcmVzLCBkbiwgTERCX1NDT1BFX1NVQlRSRUUs
CkBAIC0xMTIwLDcgKzExODEsOCBAQCBfUFVCTElDXyBpc2NfcmVzdWx0X3QgZGx6X2FsbG5v
ZGVzKGNvbnN0IGNoYXIgKnpvbmUsIHZvaWQgKmRiZGF0YSwKIAl9CiAJaWYgKHJldCAhPSBM
REJfU1VDQ0VTUyB8fCBkbiA9PSBOVUxMKSB7CiAJCXRhbGxvY19mcmVlKHRtcF9jdHgpOwot
CQlyZXR1cm4gSVNDX1JfTk9URk9VTkQ7CisJCXJlc3VsdCA9IElTQ19SX05PVEZPVU5EOwor
CQlnb3RvIGV4aXQ7CiAJfQogCiAJZm9yIChpPTA7IGk8cmVzLT5jb3VudDsgaSsrKSB7CkBA
IC0xMTUxLDcgKzEyMTMsOCBAQCBfUFVCTElDXyBpc2NfcmVzdWx0X3QgZGx6X2FsbG5vZGVz
KGNvbnN0IGNoYXIgKnpvbmUsIHZvaWQgKmRiZGF0YSwKIAkJcmRuID0gdGFsbG9jX3N0cm5k
dXAoZWxfY3R4LCAoY2hhciAqKXYtPmRhdGEsIHYtPmxlbmd0aCk7CiAJCWlmIChyZG4gPT0g
TlVMTCkgewogCQkJdGFsbG9jX2ZyZWUodG1wX2N0eCk7Ci0JCQlyZXR1cm4gSVNDX1JfTk9N
RU1PUlk7CisJCQlyZXN1bHQgPSBJU0NfUl9OT01FTU9SWTsKKwkJCWdvdG8gZXhpdDsKIAkJ
fQogCiAJCWlmIChzdHJjbXAocmRuLCAiQCIpID09IDApIHsKQEAgLTExNjIsNyArMTIyNSw4
IEBAIF9QVUJMSUNfIGlzY19yZXN1bHRfdCBkbHpfYWxsbm9kZXMoY29uc3QgY2hhciAqem9u
ZSwgdm9pZCAqZGJkYXRhLAogCQluYW1lID0gYjlfZm9ybWF0X2ZxZG4oZWxfY3R4LCBuYW1l
KTsKIAkJaWYgKG5hbWUgPT0gTlVMTCkgewogCQkJdGFsbG9jX2ZyZWUodG1wX2N0eCk7Ci0J
CQlyZXR1cm4gSVNDX1JfTk9NRU1PUlk7CisJCQlyZXN1bHQgPSBJU0NfUl9OT01FTU9SWTsK
KwkJCWdvdG8gZXhpdDsKIAkJfQogCiAJCXdlcnIgPSBkbnNfY29tbW9uX2V4dHJhY3Qoc3Rh
dGUtPnNhbWRiLCBlbCwgZWxfY3R4LCAmcmVjcywgJm51bV9yZWNzKTsKQEAgLTExNzQsMTAg
KzEyMzgsMTAgQEAgX1BVQkxJQ18gaXNjX3Jlc3VsdF90IGRsel9hbGxub2Rlcyhjb25zdCBj
aGFyICp6b25lLCB2b2lkICpkYmRhdGEsCiAJCX0KIAogCQlmb3IgKGo9MDsgaiA8IG51bV9y
ZWNzOyBqKyspIHsKLQkJCWlzY19yZXN1bHRfdCByZXN1bHQ7CisJCQlpc2NfcmVzdWx0X3Qg
cmM7CiAKLQkJCXJlc3VsdCA9IGI5X3B1dG5hbWVkcnIoc3RhdGUsIGFsbG5vZGVzLCBuYW1l
LCAmcmVjc1tqXSk7Ci0JCQlpZiAocmVzdWx0ICE9IElTQ19SX1NVQ0NFU1MpIHsKKwkJCXJj
ID0gYjlfcHV0bmFtZWRycihzdGF0ZSwgYWxsbm9kZXMsIG5hbWUsICZyZWNzW2pdKTsKKwkJ
CWlmIChyYyAhPSBJU0NfUl9TVUNDRVNTKSB7CiAJCQkJY29udGludWU7CiAJCQl9CiAJCX0K
QEAgLTExODYsOCArMTI1MCwxNSBAQCBfUFVCTElDXyBpc2NfcmVzdWx0X3QgZGx6X2FsbG5v
ZGVzKGNvbnN0IGNoYXIgKnpvbmUsIHZvaWQgKmRiZGF0YSwKIAl9CiAKIAl0YWxsb2NfZnJl
ZSh0bXBfY3R4KTsKLQotCXJldHVybiBJU0NfUl9TVUNDRVNTOworZXhpdDoKKwlkbnNfY29t
bW9uX2xvZ19vcGVyYXRpb24oCisJCSJkbHpfYWxsbm9kZXMiLAorCQlpc2NfcmVzdWx0X3N0
cihyZXN1bHQpLAorCQkmc3RhcnQsCisJCXpvbmUsCisJCU5VTEwsCisJCU5VTEwpOworCXJl
dHVybiByZXN1bHQ7CiB9CiAKIApAQCAtMTE5NiwzMCArMTI2Nyw0MiBAQCBfUFVCTElDXyBp
c2NfcmVzdWx0X3QgZGx6X2FsbG5vZGVzKGNvbnN0IGNoYXIgKnpvbmUsIHZvaWQgKmRiZGF0
YSwKICAqLwogX1BVQkxJQ18gaXNjX3Jlc3VsdF90IGRsel9uZXd2ZXJzaW9uKGNvbnN0IGNo
YXIgKnpvbmUsIHZvaWQgKmRiZGF0YSwgdm9pZCAqKnZlcnNpb25wKQogeworCXN0cnVjdCB0
aW1ldmFsIHN0YXJ0ID0gdGltZXZhbF9jdXJyZW50KCk7CiAJc3RydWN0IGRsel9iaW5kOV9k
YXRhICpzdGF0ZSA9IHRhbGxvY19nZXRfdHlwZV9hYm9ydChkYmRhdGEsIHN0cnVjdCBkbHpf
YmluZDlfZGF0YSk7CisJaXNjX3Jlc3VsdF90IHJlc3VsdCA9IElTQ19SX1NVQ0NFU1M7CiAK
IAlzdGF0ZS0+bG9nKElTQ19MT0dfSU5GTywgInNhbWJhX2Rsejogc3RhcnRpbmcgdHJhbnNh
Y3Rpb24gb24gem9uZSAlcyIsIHpvbmUpOwogCiAJaWYgKHN0YXRlLT50cmFuc2FjdGlvbl90
b2tlbiAhPSBOVUxMKSB7CiAJCXN0YXRlLT5sb2coSVNDX0xPR19JTkZPLCAic2FtYmFfZGx6
OiB0cmFuc2FjdGlvbiBhbHJlYWR5IHN0YXJ0ZWQgZm9yIHpvbmUgJXMiLCB6b25lKTsKLQkJ
cmV0dXJuIElTQ19SX0ZBSUxVUkU7CisJCXJlc3VsdCA9IElTQ19SX0ZBSUxVUkU7CisJCWdv
dG8gZXhpdDsKIAl9CiAKIAlzdGF0ZS0+dHJhbnNhY3Rpb25fdG9rZW4gPSB0YWxsb2NfemVy
byhzdGF0ZSwgaW50KTsKIAlpZiAoc3RhdGUtPnRyYW5zYWN0aW9uX3Rva2VuID09IE5VTEwp
IHsKLQkJcmV0dXJuIElTQ19SX05PTUVNT1JZOworCQlyZXN1bHQgPSBJU0NfUl9OT01FTU9S
WTsKKwkJZ290byBleGl0OwogCX0KIAogCWlmIChsZGJfdHJhbnNhY3Rpb25fc3RhcnQoc3Rh
dGUtPnNhbWRiKSAhPSBMREJfU1VDQ0VTUykgewogCQlzdGF0ZS0+bG9nKElTQ19MT0dfSU5G
TywgInNhbWJhX2RsejogZmFpbGVkIHRvIHN0YXJ0IGEgdHJhbnNhY3Rpb24gZm9yIHpvbmUg
JXMiLCB6b25lKTsKIAkJdGFsbG9jX2ZyZWUoc3RhdGUtPnRyYW5zYWN0aW9uX3Rva2VuKTsK
IAkJc3RhdGUtPnRyYW5zYWN0aW9uX3Rva2VuID0gTlVMTDsKLQkJcmV0dXJuIElTQ19SX0ZB
SUxVUkU7CisJCXJlc3VsdCA9IElTQ19SX0ZBSUxVUkU7CisJCWdvdG8gZXhpdDsKIAl9CiAK
IAkqdmVyc2lvbnAgPSAodm9pZCAqKXN0YXRlLT50cmFuc2FjdGlvbl90b2tlbjsKLQotCXJl
dHVybiBJU0NfUl9TVUNDRVNTOworZXhpdDoKKwlkbnNfY29tbW9uX2xvZ19vcGVyYXRpb24o
CisJCSJkbHpfbmV3dmVyc2lvbiIsCisJCWlzY19yZXN1bHRfc3RyKHJlc3VsdCksCisJCSZz
dGFydCwKKwkJem9uZSwKKwkJTlVMTCwKKwkJTlVMTCk7CisJcmV0dXJuIHJlc3VsdDsKIH0K
IAogLyoKQEAgLTEyMjgsMjMgKzEzMTEsMjcgQEAgX1BVQkxJQ18gaXNjX3Jlc3VsdF90IGRs
el9uZXd2ZXJzaW9uKGNvbnN0IGNoYXIgKnpvbmUsIHZvaWQgKmRiZGF0YSwgdm9pZCAqKnZl
cnMKIF9QVUJMSUNfIHZvaWQgZGx6X2Nsb3NldmVyc2lvbihjb25zdCBjaGFyICp6b25lLCBp
c2NfYm9vbGVhbl90IGNvbW1pdCwKIAkJCSAgICAgICB2b2lkICpkYmRhdGEsIHZvaWQgKip2
ZXJzaW9ucCkKIHsKKwlzdHJ1Y3QgdGltZXZhbCBzdGFydCA9IHRpbWV2YWxfY3VycmVudCgp
OwogCXN0cnVjdCBkbHpfYmluZDlfZGF0YSAqc3RhdGUgPSB0YWxsb2NfZ2V0X3R5cGVfYWJv
cnQoZGJkYXRhLCBzdHJ1Y3QgZGx6X2JpbmQ5X2RhdGEpOworCWNvbnN0IGNoYXIgKmRhdGEg
PSBOVUxMOworCisJZGF0YSA9IGNvbW1pdCA/ICJjb21taXQiIDogImNhbmNlbCI7CiAKIAlp
ZiAoc3RhdGUtPnRyYW5zYWN0aW9uX3Rva2VuICE9IChpbnQgKikqdmVyc2lvbnApIHsKIAkJ
c3RhdGUtPmxvZyhJU0NfTE9HX0lORk8sICJzYW1iYV9kbHo6IHRyYW5zYWN0aW9uIG5vdCBz
dGFydGVkIGZvciB6b25lICVzIiwgem9uZSk7Ci0JCXJldHVybjsKKwkJZ290byBleGl0Owog
CX0KIAogCWlmIChjb21taXQpIHsKIAkJaWYgKGxkYl90cmFuc2FjdGlvbl9jb21taXQoc3Rh
dGUtPnNhbWRiKSAhPSBMREJfU1VDQ0VTUykgewogCQkJc3RhdGUtPmxvZyhJU0NfTE9HX0lO
Rk8sICJzYW1iYV9kbHo6IGZhaWxlZCB0byBjb21taXQgYSB0cmFuc2FjdGlvbiBmb3Igem9u
ZSAlcyIsIHpvbmUpOwotCQkJcmV0dXJuOworCQkJZ290byBleGl0OwogCQl9CiAJCXN0YXRl
LT5sb2coSVNDX0xPR19JTkZPLCAic2FtYmFfZGx6OiBjb21taXR0ZWQgdHJhbnNhY3Rpb24g
b24gem9uZSAlcyIsIHpvbmUpOwogCX0gZWxzZSB7CiAJCWlmIChsZGJfdHJhbnNhY3Rpb25f
Y2FuY2VsKHN0YXRlLT5zYW1kYikgIT0gTERCX1NVQ0NFU1MpIHsKIAkJCXN0YXRlLT5sb2co
SVNDX0xPR19JTkZPLCAic2FtYmFfZGx6OiBmYWlsZWQgdG8gY2FuY2VsIGEgdHJhbnNhY3Rp
b24gZm9yIHpvbmUgJXMiLCB6b25lKTsKLQkJCXJldHVybjsKKwkJCWdvdG8gZXhpdDsKIAkJ
fQogCQlzdGF0ZS0+bG9nKElTQ19MT0dfSU5GTywgInNhbWJhX2RsejogY2FuY2VsbGluZyB0
cmFuc2FjdGlvbiBvbiB6b25lICVzIiwgem9uZSk7CiAJfQpAQCAtMTI1Miw2ICsxMzM5LDE1
IEBAIF9QVUJMSUNfIHZvaWQgZGx6X2Nsb3NldmVyc2lvbihjb25zdCBjaGFyICp6b25lLCBp
c2NfYm9vbGVhbl90IGNvbW1pdCwKIAl0YWxsb2NfZnJlZShzdGF0ZS0+dHJhbnNhY3Rpb25f
dG9rZW4pOwogCXN0YXRlLT50cmFuc2FjdGlvbl90b2tlbiA9IE5VTEw7CiAJKnZlcnNpb25w
ID0gTlVMTDsKKworZXhpdDoKKwlkbnNfY29tbW9uX2xvZ19vcGVyYXRpb24oCisJCSJkbHpf
Y2xvc2V2ZXJzaW9uIiwKKwkJaXNjX3Jlc3VsdF9zdHIoSVNDX1JfU1VDQ0VTUyksCisJCSZz
dGFydCwKKwkJem9uZSwKKwkJTlVMTCwKKwkJZGF0YSk7CiB9CiAKIApAQCAtMTQ1MCw2ICsx
NTQ2LDcgQEAgX1BVQkxJQ18gaXNjX2Jvb2xlYW5fdCBkbHpfc3N1bWF0Y2goY29uc3QgY2hh
ciAqc2lnbmVyLCBjb25zdCBjaGFyICpuYW1lLCBjb25zdAogCQkJCSAgICBjb25zdCBjaGFy
ICp0eXBlLCBjb25zdCBjaGFyICprZXksIHVpbnQzMl90IGtleWRhdGFsZW4sIHVpbnQ4X3Qg
KmtleWRhdGEsCiAJCQkJICAgIHZvaWQgKmRiZGF0YSkKIHsKKwlzdHJ1Y3QgdGltZXZhbCBz
dGFydCA9IHRpbWV2YWxfY3VycmVudCgpOwogCXN0cnVjdCBkbHpfYmluZDlfZGF0YSAqc3Rh
dGUgPSB0YWxsb2NfZ2V0X3R5cGVfYWJvcnQoZGJkYXRhLCBzdHJ1Y3QgZGx6X2JpbmQ5X2Rh
dGEpOwogCVRBTExPQ19DVFggKnRtcF9jdHg7CiAJREFUQV9CTE9CIGFwX3JlcTsKQEAgLTE0
NjIsMTMgKzE1NTksMTQgQEAgX1BVQkxJQ18gaXNjX2Jvb2xlYW5fdCBkbHpfc3N1bWF0Y2go
Y29uc3QgY2hhciAqc2lnbmVyLCBjb25zdCBjaGFyICpuYW1lLCBjb25zdAogCXN0cnVjdCBn
ZW5zZWNfc2VjdXJpdHkgKmdlbnNlY19jdHg7CiAJc3RydWN0IGF1dGhfc2Vzc2lvbl9pbmZv
ICpzZXNzaW9uX2luZm87CiAJc3RydWN0IGxkYl9kbiAqZG47Ci0JaXNjX3Jlc3VsdF90IHJl
c3VsdDsKKwlpc2NfcmVzdWx0X3QgcmM7CiAJc3RydWN0IGxkYl9yZXN1bHQgKnJlczsKIAlj
b25zdCBjaGFyICogYXR0cnNbXSA9IHsgTlVMTCB9OwogCXVpbnQzMl90IGFjY2Vzc19tYXNr
OwogCXN0cnVjdCBnZW5zZWNfc2V0dGluZ3MgKnNldHRpbmdzID0gTlVMTDsKIAljb25zdCBz
dHJ1Y3QgZ2Vuc2VjX3NlY3VyaXR5X29wcyAqKmJhY2tlbmRzID0gTlVMTDsKIAlzaXplX3Qg
aWR4ID0gMDsKKwlpc2NfYm9vbGVhbl90IHJlc3VsdCA9IElTQ19GQUxTRTsKIAogCS8qIFJl
bW92ZSBjYWNoZWQgY3JlZGVudGlhbHMsIGlmIGFueSAqLwogCWlmIChzdGF0ZS0+c2Vzc2lv
bl9pbmZvKSB7CkBAIC0xNDgzLDcgKzE1ODEsOCBAQCBfUFVCTElDXyBpc2NfYm9vbGVhbl90
IGRsel9zc3VtYXRjaChjb25zdCBjaGFyICpzaWduZXIsIGNvbnN0IGNoYXIgKm5hbWUsIGNv
bnN0CiAJdG1wX2N0eCA9IHRhbGxvY19uZXcoTlVMTCk7CiAJaWYgKHRtcF9jdHggPT0gTlVM
TCkgewogCQlzdGF0ZS0+bG9nKElTQ19MT0dfRVJST1IsICJzYW1iYV9kbHo6IG5vIG1lbW9y
eSIpOwotCQlyZXR1cm4gSVNDX0ZBTFNFOworCQlyZXN1bHQgPSBJU0NfRkFMU0U7CisJCWdv
dG8gZXhpdDsKIAl9CiAKIAlhcF9yZXEgPSBkYXRhX2Jsb2JfY29uc3Qoa2V5ZGF0YSwga2V5
ZGF0YWxlbik7CkBAIC0xNDkxLDcgKzE1OTAsOCBAQCBfUFVCTElDXyBpc2NfYm9vbGVhbl90
IGRsel9zc3VtYXRjaChjb25zdCBjaGFyICpzaWduZXIsIGNvbnN0IGNoYXIgKm5hbWUsIGNv
bnN0CiAJaWYgKCFzZXJ2ZXJfY3JlZGVudGlhbHMpIHsKIAkJc3RhdGUtPmxvZyhJU0NfTE9H
X0VSUk9SLCAic2FtYmFfZGx6OiBmYWlsZWQgdG8gaW5pdCBzZXJ2ZXIgY3JlZGVudGlhbHMi
KTsKIAkJdGFsbG9jX2ZyZWUodG1wX2N0eCk7Ci0JCXJldHVybiBJU0NfRkFMU0U7CisJCXJl
c3VsdCA9IElTQ19GQUxTRTsKKwkJZ290byBleGl0OwogCX0KIAogCWNsaV9jcmVkZW50aWFs
c19zZXRfa3JiNV9jb250ZXh0KHNlcnZlcl9jcmVkZW50aWFscywgc3RhdGUtPnNtYl9rcmI1
X2N0eCk7CkBAIC0xNTAzLDcgKzE2MDMsOCBAQCBfUFVCTElDXyBpc2NfYm9vbGVhbl90IGRs
el9zc3VtYXRjaChjb25zdCBjaGFyICpzaWduZXIsIGNvbnN0IGNoYXIgKm5hbWUsIGNvbnN0
CiAJaWYgKGtleXRhYl9maWxlID09IE5VTEwpIHsKIAkJc3RhdGUtPmxvZyhJU0NfTE9HX0VS
Uk9SLCAic2FtYmFfZGx6OiBPdXQgb2YgbWVtb3J5ISIpOwogCQl0YWxsb2NfZnJlZSh0bXBf
Y3R4KTsKLQkJcmV0dXJuIElTQ19GQUxTRTsKKwkJcmVzdWx0ID0gSVNDX0ZBTFNFOworCQln
b3RvIGV4aXQ7CiAJfQogCiAJaWYgKCFmaWxlX2V4aXN0KGtleXRhYl9maWxlKSkgewpAQCAt
MTUxMyw3ICsxNjE0LDggQEAgX1BVQkxJQ18gaXNjX2Jvb2xlYW5fdCBkbHpfc3N1bWF0Y2go
Y29uc3QgY2hhciAqc2lnbmVyLCBjb25zdCBjaGFyICpuYW1lLCBjb25zdAogCQlpZiAoa2V5
dGFiX2ZpbGUgPT0gTlVMTCkgewogCQkJc3RhdGUtPmxvZyhJU0NfTE9HX0VSUk9SLCAic2Ft
YmFfZGx6OiBPdXQgb2YgbWVtb3J5ISIpOwogCQkJdGFsbG9jX2ZyZWUodG1wX2N0eCk7Ci0J
CQlyZXR1cm4gSVNDX0ZBTFNFOworCQkJcmVzdWx0ID0gSVNDX0ZBTFNFOworCQkJZ290byBl
eGl0OwogCQl9CiAJfQogCkBAIC0xNTIxLDcgKzE2MjMsOCBAQCBfUFVCTElDXyBpc2NfYm9v
bGVhbl90IGRsel9zc3VtYXRjaChjb25zdCBjaGFyICpzaWduZXIsIGNvbnN0IGNoYXIgKm5h
bWUsIGNvbnN0CiAJaWYgKGtleXRhYl9uYW1lID09IE5VTEwpIHsKIAkJc3RhdGUtPmxvZyhJ
U0NfTE9HX0VSUk9SLCAic2FtYmFfZGx6OiBPdXQgb2YgbWVtb3J5ISIpOwogCQl0YWxsb2Nf
ZnJlZSh0bXBfY3R4KTsKLQkJcmV0dXJuIElTQ19GQUxTRTsKKwkJcmVzdWx0ID0gSVNDX0ZB
TFNFOworCQlnb3RvIGV4aXQ7CiAJfQogCiAJcmV0ID0gY2xpX2NyZWRlbnRpYWxzX3NldF9r
ZXl0YWJfbmFtZShzZXJ2ZXJfY3JlZGVudGlhbHMsIHN0YXRlLT5scCwga2V5dGFiX25hbWUs
CkBAIC0xNTMwLDcgKzE2MzMsOCBAQCBfUFVCTElDXyBpc2NfYm9vbGVhbl90IGRsel9zc3Vt
YXRjaChjb25zdCBjaGFyICpzaWduZXIsIGNvbnN0IGNoYXIgKm5hbWUsIGNvbnN0CiAJCXN0
YXRlLT5sb2coSVNDX0xPR19FUlJPUiwgInNhbWJhX2RsejogZmFpbGVkIHRvIG9idGFpbiBz
ZXJ2ZXIgY3JlZGVudGlhbHMgZnJvbSAlcyIsCiAJCQkgICBrZXl0YWJfbmFtZSk7CiAJCXRh
bGxvY19mcmVlKHRtcF9jdHgpOwotCQlyZXR1cm4gSVNDX0ZBTFNFOworCQlyZXN1bHQgPSBJ
U0NfRkFMU0U7CisJCWdvdG8gZXhpdDsKIAl9CiAJdGFsbG9jX2ZyZWUoa2V5dGFiX25hbWUp
OwogCkBAIC0xNTM4LDE0ICsxNjQyLDE2IEBAIF9QVUJMSUNfIGlzY19ib29sZWFuX3QgZGx6
X3NzdW1hdGNoKGNvbnN0IGNoYXIgKnNpZ25lciwgY29uc3QgY2hhciAqbmFtZSwgY29uc3QK
IAlpZiAoc2V0dGluZ3MgPT0gTlVMTCkgewogCQlzdGF0ZS0+bG9nKElTQ19MT0dfRVJST1Is
ICJzYW1iYV9kbHo6IGxwY2ZnX2dlbnNlY19zZXR0aW5ncyBmYWlsZWQiKTsKIAkJdGFsbG9j
X2ZyZWUodG1wX2N0eCk7Ci0JCXJldHVybiBJU0NfRkFMU0U7CisJCXJlc3VsdCA9IElTQ19G
QUxTRTsKKwkJZ290byBleGl0OwogCX0KIAliYWNrZW5kcyA9IHRhbGxvY196ZXJvX2FycmF5
KHNldHRpbmdzLAogCQkJCSAgICAgY29uc3Qgc3RydWN0IGdlbnNlY19zZWN1cml0eV9vcHMg
KiwgMyk7CiAJaWYgKGJhY2tlbmRzID09IE5VTEwpIHsKIAkJc3RhdGUtPmxvZyhJU0NfTE9H
X0VSUk9SLCAic2FtYmFfZGx6OiB0YWxsb2NfemVyb19hcnJheSBnZW5zZWNfc2VjdXJpdHlf
b3BzIGZhaWxlZCIpOwogCQl0YWxsb2NfZnJlZSh0bXBfY3R4KTsKLQkJcmV0dXJuIElTQ19G
QUxTRTsKKwkJcmVzdWx0ID0gSVNDX0ZBTFNFOworCQlnb3RvIGV4aXQ7CiAJfQogCXNldHRp
bmdzLT5iYWNrZW5kcyA9IGJhY2tlbmRzOwogCkBAIC0xNTU5LDcgKzE2NjUsOCBAQCBfUFVC
TElDXyBpc2NfYm9vbGVhbl90IGRsel9zc3VtYXRjaChjb25zdCBjaGFyICpzaWduZXIsIGNv
bnN0IGNoYXIgKm5hbWUsIGNvbnN0CiAJaWYgKCFOVF9TVEFUVVNfSVNfT0sobnRfc3RhdHVz
KSkgewogCQlzdGF0ZS0+bG9nKElTQ19MT0dfRVJST1IsICJzYW1iYV9kbHo6IGZhaWxlZCB0
byBzdGFydCBnZW5zZWMgc2VydmVyIik7CiAJCXRhbGxvY19mcmVlKHRtcF9jdHgpOwotCQly
ZXR1cm4gSVNDX0ZBTFNFOworCQlyZXN1bHQgPSBJU0NfRkFMU0U7CisJCWdvdG8gZXhpdDsK
IAl9CiAKIAlnZW5zZWNfc2V0X2NyZWRlbnRpYWxzKGdlbnNlY19jdHgsIHNlcnZlcl9jcmVk
ZW50aWFscyk7CkBAIC0xNTY4LDcgKzE2NzUsOCBAQCBfUFVCTElDXyBpc2NfYm9vbGVhbl90
IGRsel9zc3VtYXRjaChjb25zdCBjaGFyICpzaWduZXIsIGNvbnN0IGNoYXIgKm5hbWUsIGNv
bnN0CiAJaWYgKCFOVF9TVEFUVVNfSVNfT0sobnRfc3RhdHVzKSkgewogCQlzdGF0ZS0+bG9n
KElTQ19MT0dfRVJST1IsICJzYW1iYV9kbHo6IGZhaWxlZCB0byBzdGFydCBzcG5lZ28iKTsK
IAkJdGFsbG9jX2ZyZWUodG1wX2N0eCk7Ci0JCXJldHVybiBJU0NfRkFMU0U7CisJCXJlc3Vs
dCA9IElTQ19GQUxTRTsKKwkJZ290byBleGl0OwogCX0KIAogCS8qCkBAIC0xNTg3LDIyICsx
Njk1LDI1IEBAIF9QVUJMSUNfIGlzY19ib29sZWFuX3QgZGx6X3NzdW1hdGNoKGNvbnN0IGNo
YXIgKnNpZ25lciwgY29uc3QgY2hhciAqbmFtZSwgY29uc3QKIAlpZiAoIU5UX1NUQVRVU19J
U19PSyhudF9zdGF0dXMpKSB7CiAJCXN0YXRlLT5sb2coSVNDX0xPR19FUlJPUiwgInNhbWJh
X2Rsejogc3BuZWdvIHVwZGF0ZSBmYWlsZWQiKTsKIAkJdGFsbG9jX2ZyZWUodG1wX2N0eCk7
Ci0JCXJldHVybiBJU0NfRkFMU0U7CisJCXJlc3VsdCA9IElTQ19GQUxTRTsKKwkJZ290byBl
eGl0OwogCX0KIAogCW50X3N0YXR1cyA9IGdlbnNlY19zZXNzaW9uX2luZm8oZ2Vuc2VjX2N0
eCwgdG1wX2N0eCwgJnNlc3Npb25faW5mbyk7CiAJaWYgKCFOVF9TVEFUVVNfSVNfT0sobnRf
c3RhdHVzKSkgewogCQlzdGF0ZS0+bG9nKElTQ19MT0dfRVJST1IsICJzYW1iYV9kbHo6IGZh
aWxlZCB0byBjcmVhdGUgc2Vzc2lvbiBpbmZvIik7CiAJCXRhbGxvY19mcmVlKHRtcF9jdHgp
OwotCQlyZXR1cm4gSVNDX0ZBTFNFOworCQlyZXN1bHQgPSBJU0NfRkFMU0U7CisJCWdvdG8g
ZXhpdDsKIAl9CiAKIAkvKiBHZXQgdGhlIEROIGZyb20gbmFtZSAqLwotCXJlc3VsdCA9IGI5
X2ZpbmRfbmFtZV9kbihzdGF0ZSwgbmFtZSwgdG1wX2N0eCwgJmRuKTsKLQlpZiAocmVzdWx0
ICE9IElTQ19SX1NVQ0NFU1MpIHsKKwlyYyA9IGI5X2ZpbmRfbmFtZV9kbihzdGF0ZSwgbmFt
ZSwgdG1wX2N0eCwgJmRuKTsKKwlpZiAocmMgIT0gSVNDX1JfU1VDQ0VTUykgewogCQlzdGF0
ZS0+bG9nKElTQ19MT0dfRVJST1IsICJzYW1iYV9kbHo6IGZhaWxlZCB0byBmaW5kIG5hbWUg
JXMiLCBuYW1lKTsKIAkJdGFsbG9jX2ZyZWUodG1wX2N0eCk7Ci0JCXJldHVybiBJU0NfRkFM
U0U7CisJCXJlc3VsdCA9IElTQ19GQUxTRTsKKwkJZ290byBleGl0OwogCX0KIAogCS8qIG1h
a2Ugc3VyZSB0aGUgZG4gZXhpc3RzLCBvciBmaW5kIHBhcmVudCBkbiBpbiBjYXNlIG5ldyBv
YmplY3QgaXMgYmVpbmcgYWRkZWQgKi8KQEAgLTE2MTcsNyArMTcyOCw4IEBAIF9QVUJMSUNf
IGlzY19ib29sZWFuX3QgZGx6X3NzdW1hdGNoKGNvbnN0IGNoYXIgKnNpZ25lciwgY29uc3Qg
Y2hhciAqbmFtZSwgY29uc3QKIAkJdGFsbG9jX2ZyZWUocmVzKTsKIAl9IGVsc2UgewogCQl0
YWxsb2NfZnJlZSh0bXBfY3R4KTsKLQkJcmV0dXJuIElTQ19GQUxTRTsKKwkJcmVzdWx0ID0g
SVNDX0ZBTFNFOworCQlnb3RvIGV4aXQ7CiAJfQogCiAJLyogRG8gQUNMIGNoZWNrICovCkBA
IC0xNjI5LDcgKzE3NDEsOCBAQCBfUFVCTElDXyBpc2NfYm9vbGVhbl90IGRsel9zc3VtYXRj
aChjb25zdCBjaGFyICpzaWduZXIsIGNvbnN0IGNoYXIgKm5hbWUsIGNvbnN0CiAJCQkic2Ft
YmFfZGx6OiBkaXNhbGxvd2luZyB1cGRhdGUgb2Ygc2lnbmVyPSVzIG5hbWU9JXMgdHlwZT0l
cyBlcnJvcj0lcyIsCiAJCQlzaWduZXIsIG5hbWUsIHR5cGUsIGxkYl9zdHJlcnJvcihsZGJf
cmV0KSk7CiAJCXRhbGxvY19mcmVlKHRtcF9jdHgpOwotCQlyZXR1cm4gSVNDX0ZBTFNFOwor
CQlyZXN1bHQgPSBJU0NfRkFMU0U7CisJCWdvdG8gZXhpdDsKIAl9CiAKIAkvKiBDYWNoZSBz
ZXNzaW9uX2luZm8sIHNvIGl0IGNhbiBiZSB1c2VkIGluIHRoZSBhY3R1YWwgYWRkL2RlbGV0
ZSBvcGVyYXRpb24gKi8KQEAgLTE2MzcsNyArMTc1MCw4IEBAIF9QVUJMSUNfIGlzY19ib29s
ZWFuX3QgZGx6X3NzdW1hdGNoKGNvbnN0IGNoYXIgKnNpZ25lciwgY29uc3QgY2hhciAqbmFt
ZSwgY29uc3QKIAlpZiAoc3RhdGUtPnVwZGF0ZV9uYW1lID09IE5VTEwpIHsKIAkJc3RhdGUt
PmxvZyhJU0NfTE9HX0VSUk9SLCAic2FtYmFfZGx6OiBtZW1vcnkgYWxsb2NhdGlvbiBlcnJv
ciIpOwogCQl0YWxsb2NfZnJlZSh0bXBfY3R4KTsKLQkJcmV0dXJuIElTQ19GQUxTRTsKKwkJ
cmVzdWx0ID0gSVNDX0ZBTFNFOworCQlnb3RvIGV4aXQ7CiAJfQogCXN0YXRlLT5zZXNzaW9u
X2luZm8gPSB0YWxsb2Nfc3RlYWwoc3RhdGUsIHNlc3Npb25faW5mbyk7CiAKQEAgLTE2NDUs
NyArMTc1OSwxNiBAQCBfUFVCTElDXyBpc2NfYm9vbGVhbl90IGRsel9zc3VtYXRjaChjb25z
dCBjaGFyICpzaWduZXIsIGNvbnN0IGNoYXIgKm5hbWUsIGNvbnN0CiAJCSAgIHNpZ25lciwg
bmFtZSwgdGNwYWRkciwgdHlwZSwga2V5KTsKIAogCXRhbGxvY19mcmVlKHRtcF9jdHgpOwot
CXJldHVybiBJU0NfVFJVRTsKKwlyZXN1bHQgPSBJU0NfVFJVRTsKK2V4aXQ6CisJZG5zX2Nv
bW1vbl9sb2dfb3BlcmF0aW9uKAorCQkiZGx6X3NzdW1hdGNoIiwKKwkJaXNjX3Jlc3VsdF9z
dHIocmVzdWx0KSwKKwkJJnN0YXJ0LAorCQlOVUxMLAorCQluYW1lLAorCQlOVUxMKTsKKwly
ZXR1cm4gcmVzdWx0OwogfQogCiAvKgpAQCAtMTc3NSwxMCArMTg5OCwxMSBAQCBzdGF0aWMg
dm9pZCBiOV9yZXNldF9zZXNzaW9uX2luZm8oc3RydWN0IGRsel9iaW5kOV9kYXRhICpzdGF0
ZSkKICAqLwogX1BVQkxJQ18gaXNjX3Jlc3VsdF90IGRsel9hZGRyZGF0YXNldChjb25zdCBj
aGFyICpuYW1lLCBjb25zdCBjaGFyICpyZGF0YXN0ciwgdm9pZCAqZGJkYXRhLCB2b2lkICp2
ZXJzaW9uKQogeworCXN0cnVjdCB0aW1ldmFsIHN0YXJ0ID0gdGltZXZhbF9jdXJyZW50KCk7
CiAJc3RydWN0IGRsel9iaW5kOV9kYXRhICpzdGF0ZSA9IHRhbGxvY19nZXRfdHlwZV9hYm9y
dChkYmRhdGEsIHN0cnVjdCBkbHpfYmluZDlfZGF0YSk7CiAJc3RydWN0IGRuc3BfRG5zc3J2
UnBjUmVjb3JkICpyZWM7CiAJc3RydWN0IGxkYl9kbiAqZG47Ci0JaXNjX3Jlc3VsdF90IHJl
c3VsdDsKKwlpc2NfcmVzdWx0X3QgcmVzdWx0ID0gSVNDX1JfU1VDQ0VTUzsKIAlib29sIHRv
bWJzdG9uZWQgPSBmYWxzZTsKIAlib29sIG5lZWRzX2FkZCA9IGZhbHNlOwogCXN0cnVjdCBk
bnNwX0Ruc3NydlJwY1JlY29yZCAqcmVjcyA9IE5VTEw7CkBAIC0xNzkwLDEyICsxOTE0LDE0
IEBAIF9QVUJMSUNfIGlzY19yZXN1bHRfdCBkbHpfYWRkcmRhdGFzZXQoY29uc3QgY2hhciAq
bmFtZSwgY29uc3QgY2hhciAqcmRhdGFzdHIsIHZvCiAKIAlpZiAoc3RhdGUtPnRyYW5zYWN0
aW9uX3Rva2VuICE9ICh2b2lkKil2ZXJzaW9uKSB7CiAJCXN0YXRlLT5sb2coSVNDX0xPR19J
TkZPLCAic2FtYmFfZGx6OiBiYWQgdHJhbnNhY3Rpb24gdmVyc2lvbiIpOwotCQlyZXR1cm4g
SVNDX1JfRkFJTFVSRTsKKwkJcmVzdWx0ID0gSVNDX1JfRkFJTFVSRTsKKwkJZ290byBleGl0
OwogCX0KIAogCXJlYyA9IHRhbGxvY196ZXJvKHN0YXRlLCBzdHJ1Y3QgZG5zcF9EbnNzcnZS
cGNSZWNvcmQpOwogCWlmIChyZWMgPT0gTlVMTCkgewotCQlyZXR1cm4gSVNDX1JfTk9NRU1P
Ulk7CisJCXJlc3VsdCA9IElTQ19SX05PTUVNT1JZOworCQlnb3RvIGV4aXQ7CiAJfQogCiAJ
cmVjLT5yYW5rICAgICAgICA9IEROU19SQU5LX1pPTkU7CkBAIC0xODAzLDE0ICsxOTI5LDE1
IEBAIF9QVUJMSUNfIGlzY19yZXN1bHRfdCBkbHpfYWRkcmRhdGFzZXQoY29uc3QgY2hhciAq
bmFtZSwgY29uc3QgY2hhciAqcmRhdGFzdHIsIHZvCiAJaWYgKCFiOV9wYXJzZShzdGF0ZSwg
cmRhdGFzdHIsIHJlYykpIHsKIAkJc3RhdGUtPmxvZyhJU0NfTE9HX0lORk8sICJzYW1iYV9k
bHo6IGZhaWxlZCB0byBwYXJzZSByZGF0YXNldCAnJXMnIiwgcmRhdGFzdHIpOwogCQl0YWxs
b2NfZnJlZShyZWMpOwotCQlyZXR1cm4gSVNDX1JfRkFJTFVSRTsKKwkJcmVzdWx0ID0gSVND
X1JfRkFJTFVSRTsKKwkJZ290byBleGl0OwogCX0KIAogCS8qIGZpbmQgdGhlIEROIG9mIHRo
ZSByZWNvcmQgKi8KIAlyZXN1bHQgPSBiOV9maW5kX25hbWVfZG4oc3RhdGUsIG5hbWUsIHJl
YywgJmRuKTsKIAlpZiAocmVzdWx0ICE9IElTQ19SX1NVQ0NFU1MpIHsKIAkJdGFsbG9jX2Zy
ZWUocmVjKTsKLQkJcmV0dXJuIHJlc3VsdDsKKwkJZ290byBleGl0OwogCX0KIAogCS8qIGdl
dCBhbnkgZXhpc3RpbmcgcmVjb3JkcyAqLwpAQCAtMTgyNCw3ICsxOTUxLDggQEAgX1BVQkxJ
Q18gaXNjX3Jlc3VsdF90IGRsel9hZGRyZGF0YXNldChjb25zdCBjaGFyICpuYW1lLCBjb25z
dCBjaGFyICpyZGF0YXN0ciwgdm8KIAkJc3RhdGUtPmxvZyhJU0NfTE9HX0VSUk9SLCAic2Ft
YmFfZGx6OiBmYWlsZWQgdG8gcGFyc2UgZG5zUmVjb3JkIGZvciAlcywgJXMiLAogCQkJICAg
bGRiX2RuX2dldF9saW5lYXJpemVkKGRuKSwgd2luX2VycnN0cih3ZXJyKSk7CiAJCXRhbGxv
Y19mcmVlKHJlYyk7Ci0JCXJldHVybiBJU0NfUl9GQUlMVVJFOworCQlyZXN1bHQgPSBJU0Nf
Ul9GQUlMVVJFOworCQlnb3RvIGV4aXQ7CiAJfQogCiAJaWYgKHRvbWJzdG9uZWQpIHsKQEAg
LTE4NDcsNyArMTk3NSw4IEBAIF9QVUJMSUNfIGlzY19yZXN1bHRfdCBkbHpfYWRkcmRhdGFz
ZXQoY29uc3QgY2hhciAqbmFtZSwgY29uc3QgY2hhciAqcmRhdGFzdHIsIHZvCiAJCXN0YXRl
LT5sb2coSVNDX0xPR19FUlJPUiwgInNhbWJhX2RsejogZmFpbGVkIHRvIGFscmVhZHkgJXUg
ZG5zUmVjb3JkIHZhbHVlcyBmb3IgJXMiLAogCQkJICAgaSwgbGRiX2RuX2dldF9saW5lYXJp
emVkKGRuKSk7CiAJCXRhbGxvY19mcmVlKHJlYyk7Ci0JCXJldHVybiBJU0NfUl9GQUlMVVJF
OworCQlyZXN1bHQgPSBJU0NfUl9GQUlMVVJFOworCQlnb3RvIGV4aXQ7CiAJfQogCiAJaWYg
KGkgPT0gbnVtX3JlY3MpIHsKQEAgLTE4NTcsNyArMTk4Niw4IEBAIF9QVUJMSUNfIGlzY19y
ZXN1bHRfdCBkbHpfYWRkcmRhdGFzZXQoY29uc3QgY2hhciAqbmFtZSwgY29uc3QgY2hhciAq
cmRhdGFzdHIsIHZvCiAJCQkJICAgICAgbnVtX3JlY3MgKyAxKTsKIAkJaWYgKHJlY3MgPT0g
TlVMTCkgewogCQkJdGFsbG9jX2ZyZWUocmVjKTsKLQkJCXJldHVybiBJU0NfUl9OT01FTU9S
WTsKKwkJCXJlc3VsdCA9IElTQ19SX05PTUVNT1JZOworCQkJZ290byBleGl0OwogCQl9CiAJ
CW51bV9yZWNzKys7CiAKQEAgLTE4NzUsNyArMjAwNSw4IEBAIF9QVUJMSUNfIGlzY19yZXN1
bHRfdCBkbHpfYWRkcmRhdGFzZXQoY29uc3QgY2hhciAqbmFtZSwgY29uc3QgY2hhciAqcmRh
dGFzdHIsIHZvCiAKIAlpZiAoIWI5X3NldF9zZXNzaW9uX2luZm8oc3RhdGUsIG5hbWUpKSB7
CiAJCXRhbGxvY19mcmVlKHJlYyk7Ci0JCXJldHVybiBJU0NfUl9GQUlMVVJFOworCQlyZXN1
bHQgPSBJU0NfUl9GQUlMVVJFOworCQlnb3RvIGV4aXQ7CiAJfQogCiAJLyogbW9kaWZ5IHRo
ZSByZWNvcmQgKi8KQEAgLTE4ODksMTMgKzIwMjAsMjIgQEAgX1BVQkxJQ18gaXNjX3Jlc3Vs
dF90IGRsel9hZGRyZGF0YXNldChjb25zdCBjaGFyICpuYW1lLCBjb25zdCBjaGFyICpyZGF0
YXN0ciwgdm8KIAkJCSAgIG5lZWRzX2FkZCA/ICJhZGQiIDogIm1vZGlmeSIsCiAJCQkgICBs
ZGJfZG5fZ2V0X2xpbmVhcml6ZWQoZG4pLCB3aW5fZXJyc3RyKHdlcnIpKTsKIAkJdGFsbG9j
X2ZyZWUocmVjKTsKLQkJcmV0dXJuIElTQ19SX0ZBSUxVUkU7CisJCXJlc3VsdCA9IElTQ19S
X0ZBSUxVUkU7CisJCWdvdG8gZXhpdDsKIAl9CiAKIAlzdGF0ZS0+bG9nKElTQ19MT0dfSU5G
TywgInNhbWJhX2RsejogYWRkZWQgcmRhdGFzZXQgJXMgJyVzJyIsIG5hbWUsIHJkYXRhc3Ry
KTsKIAogCXRhbGxvY19mcmVlKHJlYyk7Ci0JcmV0dXJuIElTQ19SX1NVQ0NFU1M7CitleGl0
OgorCWRuc19jb21tb25fbG9nX29wZXJhdGlvbigKKwkJImRsel9hZGRyZGF0YXNldCIsCisJ
CWlzY19yZXN1bHRfc3RyKHJlc3VsdCksCisJCSZzdGFydCwKKwkJTlVMTCwKKwkJbmFtZSwK
KwkJcmRhdGFzdHIpOworCXJldHVybiByZXN1bHQ7CiB9CiAKIC8qCkBAIC0xOTAzLDEwICsy
MDQzLDExIEBAIF9QVUJMSUNfIGlzY19yZXN1bHRfdCBkbHpfYWRkcmRhdGFzZXQoY29uc3Qg
Y2hhciAqbmFtZSwgY29uc3QgY2hhciAqcmRhdGFzdHIsIHZvCiAgKi8KIF9QVUJMSUNfIGlz
Y19yZXN1bHRfdCBkbHpfc3VicmRhdGFzZXQoY29uc3QgY2hhciAqbmFtZSwgY29uc3QgY2hh
ciAqcmRhdGFzdHIsIHZvaWQgKmRiZGF0YSwgdm9pZCAqdmVyc2lvbikKIHsKKwlzdHJ1Y3Qg
dGltZXZhbCBzdGFydCA9IHRpbWV2YWxfY3VycmVudCgpOwogCXN0cnVjdCBkbHpfYmluZDlf
ZGF0YSAqc3RhdGUgPSB0YWxsb2NfZ2V0X3R5cGVfYWJvcnQoZGJkYXRhLCBzdHJ1Y3QgZGx6
X2JpbmQ5X2RhdGEpOwogCXN0cnVjdCBkbnNwX0Ruc3NydlJwY1JlY29yZCAqcmVjOwogCXN0
cnVjdCBsZGJfZG4gKmRuOwotCWlzY19yZXN1bHRfdCByZXN1bHQ7CisJaXNjX3Jlc3VsdF90
IHJlc3VsdCA9IElTQ19SX1NVQ0NFU1M7CiAJc3RydWN0IGRuc3BfRG5zc3J2UnBjUmVjb3Jk
ICpyZWNzID0gTlVMTDsKIAl1aW50MTZfdCBudW1fcmVjcyA9IDA7CiAJdWludDE2X3QgaTsK
QEAgLTE5MTQsMjUgKzIwNTUsMjggQEAgX1BVQkxJQ18gaXNjX3Jlc3VsdF90IGRsel9zdWJy
ZGF0YXNldChjb25zdCBjaGFyICpuYW1lLCBjb25zdCBjaGFyICpyZGF0YXN0ciwgdm8KIAog
CWlmIChzdGF0ZS0+dHJhbnNhY3Rpb25fdG9rZW4gIT0gKHZvaWQqKXZlcnNpb24pIHsKIAkJ
c3RhdGUtPmxvZyhJU0NfTE9HX0VSUk9SLCAic2FtYmFfZGx6OiBiYWQgdHJhbnNhY3Rpb24g
dmVyc2lvbiIpOwotCQlyZXR1cm4gSVNDX1JfRkFJTFVSRTsKKwkJcmVzdWx0ID0gSVNDX1Jf
RkFJTFVSRTsKKwkJZ290byBleGl0OwogCX0KIAogCXJlYyA9IHRhbGxvY196ZXJvKHN0YXRl
LCBzdHJ1Y3QgZG5zcF9EbnNzcnZScGNSZWNvcmQpOwogCWlmIChyZWMgPT0gTlVMTCkgewot
CQlyZXR1cm4gSVNDX1JfTk9NRU1PUlk7CisJCXJlc3VsdCA9IElTQ19SX05PTUVNT1JZOwor
CQlnb3RvIGV4aXQ7CiAJfQogCiAJaWYgKCFiOV9wYXJzZShzdGF0ZSwgcmRhdGFzdHIsIHJl
YykpIHsKIAkJc3RhdGUtPmxvZyhJU0NfTE9HX0VSUk9SLCAic2FtYmFfZGx6OiBmYWlsZWQg
dG8gcGFyc2UgcmRhdGFzZXQgJyVzJyIsIHJkYXRhc3RyKTsKIAkJdGFsbG9jX2ZyZWUocmVj
KTsKLQkJcmV0dXJuIElTQ19SX0ZBSUxVUkU7CisJCXJlc3VsdCA9IElTQ19SX0ZBSUxVUkU7
CisJCWdvdG8gZXhpdDsKIAl9CiAKIAkvKiBmaW5kIHRoZSBETiBvZiB0aGUgcmVjb3JkICov
CiAJcmVzdWx0ID0gYjlfZmluZF9uYW1lX2RuKHN0YXRlLCBuYW1lLCByZWMsICZkbik7CiAJ
aWYgKHJlc3VsdCAhPSBJU0NfUl9TVUNDRVNTKSB7CiAJCXRhbGxvY19mcmVlKHJlYyk7Ci0J
CXJldHVybiByZXN1bHQ7CisJCWdvdG8gZXhpdDsKIAl9CiAKIAkvKiBnZXQgdGhlIGV4aXN0
aW5nIHJlY29yZHMgKi8KQEAgLTE5NDAsNyArMjA4NCw4IEBAIF9QVUJMSUNfIGlzY19yZXN1
bHRfdCBkbHpfc3VicmRhdGFzZXQoY29uc3QgY2hhciAqbmFtZSwgY29uc3QgY2hhciAqcmRh
dGFzdHIsIHZvCiAJCQkJICZyZWNzLCAmbnVtX3JlY3MsIE5VTEwpOwogCWlmICghV19FUlJP
Ul9JU19PSyh3ZXJyKSkgewogCQl0YWxsb2NfZnJlZShyZWMpOwotCQlyZXR1cm4gSVNDX1Jf
Tk9URk9VTkQ7CisJCXJlc3VsdCA9IElTQ19SX05PVEZPVU5EOworCQlnb3RvIGV4aXQ7CiAJ
fQogCiAJZm9yIChpPTA7IGkgPCBudW1fcmVjczsgaSsrKSB7CkBAIC0xOTUzLDEyICsyMDk4
LDE0IEBAIF9QVUJMSUNfIGlzY19yZXN1bHRfdCBkbHpfc3VicmRhdGFzZXQoY29uc3QgY2hh
ciAqbmFtZSwgY29uc3QgY2hhciAqcmRhdGFzdHIsIHZvCiAJfQogCWlmIChpID09IG51bV9y
ZWNzKSB7CiAJCXRhbGxvY19mcmVlKHJlYyk7Ci0JCXJldHVybiBJU0NfUl9OT1RGT1VORDsK
KwkJcmVzdWx0ID0gSVNDX1JfTk9URk9VTkQ7CisJCWdvdG8gZXhpdDsKIAl9CiAKIAlpZiAo
IWI5X3NldF9zZXNzaW9uX2luZm8oc3RhdGUsIG5hbWUpKSB7CiAJCXRhbGxvY19mcmVlKHJl
Yyk7Ci0JCXJldHVybiBJU0NfUl9GQUlMVVJFOworCQlyZXN1bHQgPSBJU0NfUl9GQUlMVVJF
OworCQlnb3RvIGV4aXQ7CiAJfQogCiAJLyogbW9kaWZ5IHRoZSByZWNvcmQgKi8KQEAgLTE5
NzEsMTMgKzIxMTgsMjIgQEAgX1BVQkxJQ18gaXNjX3Jlc3VsdF90IGRsel9zdWJyZGF0YXNl
dChjb25zdCBjaGFyICpuYW1lLCBjb25zdCBjaGFyICpyZGF0YXN0ciwgdm8KIAkJc3RhdGUt
PmxvZyhJU0NfTE9HX0VSUk9SLCAic2FtYmFfZGx6OiBmYWlsZWQgdG8gbW9kaWZ5ICVzIC0g
JXMiLAogCQkJICAgbGRiX2RuX2dldF9saW5lYXJpemVkKGRuKSwgd2luX2VycnN0cih3ZXJy
KSk7CiAJCXRhbGxvY19mcmVlKHJlYyk7Ci0JCXJldHVybiBJU0NfUl9GQUlMVVJFOworCQly
ZXN1bHQgPSBJU0NfUl9GQUlMVVJFOworCQlnb3RvIGV4aXQ7CiAJfQogCiAJc3RhdGUtPmxv
ZyhJU0NfTE9HX0lORk8sICJzYW1iYV9kbHo6IHN1YnRyYWN0ZWQgcmRhdGFzZXQgJXMgJyVz
JyIsIG5hbWUsIHJkYXRhc3RyKTsKIAogCXRhbGxvY19mcmVlKHJlYyk7Ci0JcmV0dXJuIElT
Q19SX1NVQ0NFU1M7CitleGl0OgorCWRuc19jb21tb25fbG9nX29wZXJhdGlvbigKKwkJImRs
el9zdWJyZGF0YXNldCIsCisJCWlzY19yZXN1bHRfc3RyKHJlc3VsdCksCisJCSZzdGFydCwK
KwkJTlVMTCwKKwkJbmFtZSwKKwkJcmRhdGFzdHIpOworCXJldHVybiByZXN1bHQ7CiB9CiAK
IApAQCAtMTk4NiwxMCArMjE0MiwxMSBAQCBfUFVCTElDXyBpc2NfcmVzdWx0X3QgZGx6X3N1
YnJkYXRhc2V0KGNvbnN0IGNoYXIgKm5hbWUsIGNvbnN0IGNoYXIgKnJkYXRhc3RyLCB2bwog
ICovCiBfUFVCTElDXyBpc2NfcmVzdWx0X3QgZGx6X2RlbHJkYXRhc2V0KGNvbnN0IGNoYXIg
Km5hbWUsIGNvbnN0IGNoYXIgKnR5cGUsIHZvaWQgKmRiZGF0YSwgdm9pZCAqdmVyc2lvbikK
IHsKKwlzdHJ1Y3QgdGltZXZhbCBzdGFydCA9IHRpbWV2YWxfY3VycmVudCgpOwogCXN0cnVj
dCBkbHpfYmluZDlfZGF0YSAqc3RhdGUgPSB0YWxsb2NfZ2V0X3R5cGVfYWJvcnQoZGJkYXRh
LCBzdHJ1Y3QgZGx6X2JpbmQ5X2RhdGEpOwogCVRBTExPQ19DVFggKnRtcF9jdHg7CiAJc3Ry
dWN0IGxkYl9kbiAqZG47Ci0JaXNjX3Jlc3VsdF90IHJlc3VsdDsKKwlpc2NfcmVzdWx0X3Qg
cmVzdWx0ID0gSVNDX1JfU1VDQ0VTUzsKIAllbnVtIGRuc19yZWNvcmRfdHlwZSBkbnNfdHlw
ZTsKIAlib29sIGZvdW5kID0gZmFsc2U7CiAJc3RydWN0IGRuc3BfRG5zc3J2UnBjUmVjb3Jk
ICpyZWNzID0gTlVMTDsKQEAgLTE5OTksMTIgKzIxNTYsMTQgQEAgX1BVQkxJQ18gaXNjX3Jl
c3VsdF90IGRsel9kZWxyZGF0YXNldChjb25zdCBjaGFyICpuYW1lLCBjb25zdCBjaGFyICp0
eXBlLCB2b2lkICoKIAogCWlmIChzdGF0ZS0+dHJhbnNhY3Rpb25fdG9rZW4gIT0gKHZvaWQq
KXZlcnNpb24pIHsKIAkJc3RhdGUtPmxvZyhJU0NfTE9HX0VSUk9SLCAic2FtYmFfZGx6OiBi
YWQgdHJhbnNhY3Rpb24gdmVyc2lvbiIpOwotCQlyZXR1cm4gSVNDX1JfRkFJTFVSRTsKKwkJ
cmVzdWx0ID0gSVNDX1JfRkFJTFVSRTsKKwkJZ290byBleGl0OwogCX0KIAogCWlmICghYjlf
ZG5zX3R5cGUodHlwZSwgJmRuc190eXBlKSkgewogCQlzdGF0ZS0+bG9nKElTQ19MT0dfRVJS
T1IsICJzYW1iYV9kbHo6IGJhZCBkbnMgdHlwZSAlcyBpbiBkZWxldGUiLCB0eXBlKTsKLQkJ
cmV0dXJuIElTQ19SX0ZBSUxVUkU7CisJCXJlc3VsdCA9IElTQ19SX0ZBSUxVUkU7CisJCWdv
dG8gZXhpdDsKIAl9CiAKIAl0bXBfY3R4ID0gdGFsbG9jX25ldyhzdGF0ZSk7CkBAIC0yMDEz
LDcgKzIxNzIsNyBAQCBfUFVCTElDXyBpc2NfcmVzdWx0X3QgZGx6X2RlbHJkYXRhc2V0KGNv
bnN0IGNoYXIgKm5hbWUsIGNvbnN0IGNoYXIgKnR5cGUsIHZvaWQgKgogCXJlc3VsdCA9IGI5
X2ZpbmRfbmFtZV9kbihzdGF0ZSwgbmFtZSwgdG1wX2N0eCwgJmRuKTsKIAlpZiAocmVzdWx0
ICE9IElTQ19SX1NVQ0NFU1MpIHsKIAkJdGFsbG9jX2ZyZWUodG1wX2N0eCk7Ci0JCXJldHVy
biByZXN1bHQ7CisJCWdvdG8gZXhpdDsKIAl9CiAKIAkvKiBnZXQgdGhlIGV4aXN0aW5nIHJl
Y29yZHMgKi8KQEAgLTIwMjEsNyArMjE4MCw4IEBAIF9QVUJMSUNfIGlzY19yZXN1bHRfdCBk
bHpfZGVscmRhdGFzZXQoY29uc3QgY2hhciAqbmFtZSwgY29uc3QgY2hhciAqdHlwZSwgdm9p
ZCAqCiAJCQkJICZyZWNzLCAmbnVtX3JlY3MsIE5VTEwpOwogCWlmICghV19FUlJPUl9JU19P
Syh3ZXJyKSkgewogCQl0YWxsb2NfZnJlZSh0bXBfY3R4KTsKLQkJcmV0dXJuIElTQ19SX05P
VEZPVU5EOworCQlyZXN1bHQgPSBJU0NfUl9OT1RGT1VORDsKKwkJZ290byBleGl0OwogCX0K
IAogCWZvciAocmk9MDsgcmkgPCBudW1fcmVjczsgcmkrKykgewpAQCAtMjAzNywxMiArMjE5
NywxNCBAQCBfUFVCTElDXyBpc2NfcmVzdWx0X3QgZGx6X2RlbHJkYXRhc2V0KGNvbnN0IGNo
YXIgKm5hbWUsIGNvbnN0IGNoYXIgKnR5cGUsIHZvaWQgKgogCiAJaWYgKCFmb3VuZCkgewog
CQl0YWxsb2NfZnJlZSh0bXBfY3R4KTsKLQkJcmV0dXJuIElTQ19SX0ZBSUxVUkU7CisJCXJl
c3VsdCA9IElTQ19SX0ZBSUxVUkU7CisJCWdvdG8gZXhpdDsKIAl9CiAKIAlpZiAoIWI5X3Nl
dF9zZXNzaW9uX2luZm8oc3RhdGUsIG5hbWUpKSB7CiAJCXRhbGxvY19mcmVlKHRtcF9jdHgp
OwotCQlyZXR1cm4gSVNDX1JfRkFJTFVSRTsKKwkJcmVzdWx0ID0gSVNDX1JfRkFJTFVSRTsK
KwkJZ290byBleGl0OwogCX0KIAogCS8qIG1vZGlmeSB0aGUgcmVjb3JkICovCkBAIC0yMDU1
LDExICsyMjE3LDIwIEBAIF9QVUJMSUNfIGlzY19yZXN1bHRfdCBkbHpfZGVscmRhdGFzZXQo
Y29uc3QgY2hhciAqbmFtZSwgY29uc3QgY2hhciAqdHlwZSwgdm9pZCAqCiAJCXN0YXRlLT5s
b2coSVNDX0xPR19FUlJPUiwgInNhbWJhX2RsejogZmFpbGVkIHRvIG1vZGlmeSAlcyAtICVz
IiwKIAkJCSAgIGxkYl9kbl9nZXRfbGluZWFyaXplZChkbiksIHdpbl9lcnJzdHIod2Vycikp
OwogCQl0YWxsb2NfZnJlZSh0bXBfY3R4KTsKLQkJcmV0dXJuIElTQ19SX0ZBSUxVUkU7CisJ
CXJlc3VsdCA9IElTQ19SX0ZBSUxVUkU7CisJCWdvdG8gZXhpdDsKIAl9CiAKIAlzdGF0ZS0+
bG9nKElTQ19MT0dfSU5GTywgInNhbWJhX2RsejogZGVsZXRlZCByZGF0YXNldCAlcyBvZiB0
eXBlICVzIiwgbmFtZSwgdHlwZSk7CiAKIAl0YWxsb2NfZnJlZSh0bXBfY3R4KTsKLQlyZXR1
cm4gSVNDX1JfU1VDQ0VTUzsKK2V4aXQ6CisJZG5zX2NvbW1vbl9sb2dfb3BlcmF0aW9uKAor
CQkiZGx6X2RlbHJkYXRhc2V0IiwKKwkJaXNjX3Jlc3VsdF9zdHIocmVzdWx0KSwKKwkJJnN0
YXJ0LAorCQlOVUxMLAorCQluYW1lLAorCQl0eXBlKTsKKwlyZXR1cm4gcmVzdWx0OwogfQpk
aWZmIC0tZ2l0IGEvc291cmNlNC9kbnNfc2VydmVyL2Ruc3NlcnZlcl9jb21tb24uYyBiL3Nv
dXJjZTQvZG5zX3NlcnZlci9kbnNzZXJ2ZXJfY29tbW9uLmMKaW5kZXggZTA4NDk3MTM2MDQu
LmY1MjEzYzQ4NjUwIDEwMDY0NAotLS0gYS9zb3VyY2U0L2Ruc19zZXJ2ZXIvZG5zc2VydmVy
X2NvbW1vbi5jCisrKyBiL3NvdXJjZTQvZG5zX3NlcnZlci9kbnNzZXJ2ZXJfY29tbW9uLmMK
QEAgLTE0NSwxMyArMTQ1LDE0IEBAIFdFUlJPUiBkbnNfY29tbW9uX2xvb2t1cChzdHJ1Y3Qg
bGRiX2NvbnRleHQgKnNhbWRiLAogCQkJIHVpbnQxNl90ICpudW1fcmVjb3JkcywKIAkJCSBi
b29sICp0b21ic3RvbmVkKQogeworCWNvbnN0IHN0cnVjdCB0aW1ldmFsIHN0YXJ0ID0gdGlt
ZXZhbF9jdXJyZW50KCk7CiAJc3RhdGljIGNvbnN0IGNoYXIgKiBjb25zdCBhdHRyc1tdID0g
ewogCQkiZG5zUmVjb3JkIiwKIAkJImROU1RvbWJzdG9uZWQiLAogCQlOVUxMCiAJfTsKIAlp
bnQgcmV0OwotCVdFUlJPUiB3ZXJyOworCVdFUlJPUiB3ZXJyID0gV0VSUl9PSzsKIAlzdHJ1
Y3QgbGRiX21lc3NhZ2UgKm1zZyA9IE5VTEw7CiAJc3RydWN0IGxkYl9tZXNzYWdlX2VsZW1l
bnQgKmVsOwogCkBAIC0xNjksMTIgKzE3MCwxNCBAQCBXRVJST1IgZG5zX2NvbW1vbl9sb29r
dXAoc3RydWN0IGxkYl9jb250ZXh0ICpzYW1kYiwKIAkJCSIoJihvYmplY3RDbGFzcz1kbnNO
b2RlKSghKGROU1RvbWJzdG9uZWQ9VFJVRSkpKSIpOwogCX0KIAlpZiAocmV0ID09IExEQl9F
UlJfTk9fU1VDSF9PQkpFQ1QpIHsKLQkJcmV0dXJuIFdFUlJfRE5TX0VSUk9SX05BTUVfRE9F
U19OT1RfRVhJU1Q7CisJCXdlcnIgPSBXRVJSX0ROU19FUlJPUl9OQU1FX0RPRVNfTk9UX0VY
SVNUOworCQlnb3RvIGV4aXQ7CiAJfQogCWlmIChyZXQgIT0gTERCX1NVQ0NFU1MpIHsKIAkJ
LyogVE9ETzogd2UgbmVlZCB0byBjaGVjayBpZiB0aGVyZSdzIGEgZ2x1ZSByZWNvcmQgd2Ug
bmVlZCB0bwogCQkgKiBjcmVhdGUgYSByZWZlcnJhbCB0byAqLwotCQlyZXR1cm4gRE5TX0VS
UihOQU1FX0VSUk9SKTsKKwkJd2VyciA9IEROU19FUlIoTkFNRV9FUlJPUik7CisJCWdvdG8g
ZXhpdDsKIAl9CiAKIAlpZiAodG9tYnN0b25lZCAhPSBOVUxMKSB7CkBAIC0xOTgsNyArMjAx
LDggQEAgV0VSUk9SIGRuc19jb21tb25fbG9va3VwKHN0cnVjdCBsZGJfY29udGV4dCAqc2Ft
ZGIsCiAJCQkJCSAgICBzdHJ1Y3QgZG5zcF9EbnNzcnZScGNSZWNvcmQsCiAJCQkJCSAgICAx
KTsKIAkJCWlmIChyZWNzID09IE5VTEwpIHsKLQkJCQlyZXR1cm4gV0VSUl9OT1RfRU5PVUdI
X01FTU9SWTsKKwkJCQl3ZXJyID0gV0VSUl9OT1RfRU5PVUdIX01FTU9SWTsKKwkJCQlnb3Rv
IGV4aXQ7CiAJCQl9CiAJCQlyZWNzWzBdID0gKHN0cnVjdCBkbnNwX0Ruc3NydlJwY1JlY29y
ZCkgewogCQkJCS53VHlwZSA9IEROU19UWVBFX1RPTUJTVE9ORSwKQEAgLTIxNCwyNCArMjE4
LDM1IEBAIFdFUlJPUiBkbnNfY29tbW9uX2xvb2t1cChzdHJ1Y3QgbGRiX2NvbnRleHQgKnNh
bWRiLAogCQkJKnRvbWJzdG9uZWQgPSB0cnVlOwogCQkJKnJlY29yZHMgPSByZWNzOwogCQkJ
Km51bV9yZWNvcmRzID0gMTsKLQkJCXJldHVybiBXRVJSX09LOworCQkJd2VyciA9IFdFUlJf
T0s7CisJCQlnb3RvIGV4aXQ7CiAJCX0gZWxzZSB7CiAJCQkvKgogCQkJICogQmVjYXVzZSB3
ZSBhcmUgbm90IGxvb2tpbmcgZm9yIGEgdG9tYnN0b25lCiAJCQkgKiBpbiB0aGlzIGNvZGVw
YXRoLCB3ZSBqdXN0IHByZXRlbmQgaXQgZG9lcwogCQkJICogbm90IGV4aXN0IGF0IGFsbC4K
IAkJCSAqLwotCQkJcmV0dXJuIFdFUlJfRE5TX0VSUk9SX05BTUVfRE9FU19OT1RfRVhJU1Q7
CisJCQl3ZXJyID0gV0VSUl9ETlNfRVJST1JfTkFNRV9ET0VTX05PVF9FWElTVDsKKwkJCWdv
dG8gZXhpdDsKIAkJfQogCX0KIAogCXdlcnIgPSBkbnNfY29tbW9uX2V4dHJhY3Qoc2FtZGIs
IGVsLCBtZW1fY3R4LCByZWNvcmRzLCBudW1fcmVjb3Jkcyk7CiAJVEFMTE9DX0ZSRUUobXNn
KTsKIAlpZiAoIVdfRVJST1JfSVNfT0sod2VycikpIHsKLQkJcmV0dXJuIHdlcnI7CisJCWdv
dG8gZXhpdDsKIAl9CiAKLQlyZXR1cm4gV0VSUl9PSzsKKwl3ZXJyID0gV0VSUl9PSzsKK2V4
aXQ6CisJZG5zX2NvbW1vbl9sb2dfb3BlcmF0aW9uKAorCQkibG9va3VwIiwKKwkJd2luX2Vy
cnN0cih3ZXJyKSwKKwkJJnN0YXJ0LAorCQlOVUxMLAorCQlsZGJfZG5fZ2V0X2xpbmVhcml6
ZWQoZG4pLAorCQlOVUxMKTsKKwlyZXR1cm4gd2VycjsKIH0KIAogLyoKQEAgLTUzMyw4ICs1
NDgsOSBAQCBXRVJST1IgZG5zX2NvbW1vbl93aWxkY2FyZF9sb29rdXAoc3RydWN0IGxkYl9j
b250ZXh0ICpzYW1kYiwKIAkJCQkgIHN0cnVjdCBkbnNwX0Ruc3NydlJwY1JlY29yZCAqKnJl
Y29yZHMsCiAJCQkJICB1aW50MTZfdCAqbnVtX3JlY29yZHMpCiB7CisJY29uc3Qgc3RydWN0
IHRpbWV2YWwgc3RhcnQgPSB0aW1ldmFsX2N1cnJlbnQoKTsKIAlpbnQgcmV0OwotCVdFUlJP
UiB3ZXJyOworCVdFUlJPUiB3ZXJyID0gV0VSUl9PSzsKIAlzdHJ1Y3QgbGRiX21lc3NhZ2Ug
Km1zZyA9IE5VTEw7CiAJc3RydWN0IGxkYl9tZXNzYWdlX2VsZW1lbnQgKmVsID0gTlVMTDsK
IAljb25zdCBzdHJ1Y3QgbGRiX3ZhbCAqbmFtZSA9IE5VTEw7CkBAIC01NDUsMTYgKzU2MSwx
OCBAQCBXRVJST1IgZG5zX2NvbW1vbl93aWxkY2FyZF9sb29rdXAoc3RydWN0IGxkYl9jb250
ZXh0ICpzYW1kYiwKIAluYW1lID0gbGRiX2RuX2dldF9yZG5fdmFsKGRuKTsKIAlpZiAobmFt
ZSA9PSBOVUxMKSB7CiAJCXJldHVybiBETlNfRVJSKE5BTUVfRVJST1IpOworCQlnb3RvIGV4
aXQ7CiAJfQogCiAJLyogRG9uJ3QgbG9vayBmb3IgYSB3aWxkY2FyZCBmb3IgQCAqLwogCWlm
IChuYW1lLT5sZW5ndGggPT0gMSAmJiBuYW1lLT5kYXRhWzBdID09ICdAJykgewotCQlyZXR1
cm4gZG5zX2NvbW1vbl9sb29rdXAoc2FtZGIsCisJCXdlcnIgPSBkbnNfY29tbW9uX2xvb2t1
cChzYW1kYiwKIAkJCQkJIG1lbV9jdHgsCiAJCQkJCSBkbiwKIAkJCQkJIHJlY29yZHMsCiAJ
CQkJCSBudW1fcmVjb3JkcywKIAkJCQkJIE5VTEwpOworCQlnb3RvIGV4aXQ7CiAJfQogCiAJ
d2VyciA9ICBkbnNfbmFtZV9jaGVjaygKQEAgLTU2Miw3ICs1ODAsNyBAQCBXRVJST1IgZG5z
X2NvbW1vbl93aWxkY2FyZF9sb29rdXAoc3RydWN0IGxkYl9jb250ZXh0ICpzYW1kYiwKIAkJ
CXN0cmxlbigoY29uc3QgY2hhciopbmFtZS0+ZGF0YSksCiAJCQkoY29uc3QgY2hhciopIG5h
bWUtPmRhdGEpOwogCWlmICghV19FUlJPUl9JU19PSyh3ZXJyKSkgewotCQlyZXR1cm4gd2Vy
cjsKKwkJZ290byBleGl0OwogCX0KIAogCS8qCkBAIC01NzYsMjkgKzU5NCw0MiBAQCBXRVJS
T1IgZG5zX2NvbW1vbl93aWxkY2FyZF9sb29rdXAoc3RydWN0IGxkYl9jb250ZXh0ICpzYW1k
YiwKIAkJCQkgbnVtX3JlY29yZHMsCiAJCQkJIE5VTEwpOwogCWlmICghV19FUlJPUl9FUVVB
TCh3ZXJyLCBXRVJSX0ROU19FUlJPUl9OQU1FX0RPRVNfTk9UX0VYSVNUKSkgewotCQlyZXR1
cm4gd2VycjsKKwkJZ290byBleGl0OwogCX0KIAogCXJldCA9IGRuc193aWxkY2FyZF9sb29r
dXAoc2FtZGIsIG1lbV9jdHgsIGRuLCAmbXNnKTsKIAlpZiAocmV0ID09IExEQl9FUlJfT1BF
UkFUSU9OU19FUlJPUikgewotCQlyZXR1cm4gRE5TX0VSUihTRVJWRVJfRkFJTFVSRSk7CisJ
CXdlcnIgPSBETlNfRVJSKFNFUlZFUl9GQUlMVVJFKTsKKwkJZ290byBleGl0OwogCX0KIAlp
ZiAocmV0ICE9IExEQl9TVUNDRVNTKSB7Ci0JCXJldHVybiBETlNfRVJSKE5BTUVfRVJST1Ip
OworCQl3ZXJyID0gRE5TX0VSUihOQU1FX0VSUk9SKTsKKwkJZ290byBleGl0OwogCX0KIAog
CWVsID0gbGRiX21zZ19maW5kX2VsZW1lbnQobXNnLCAiZG5zUmVjb3JkIik7CiAJaWYgKGVs
ID09IE5VTEwpIHsKLQkJcmV0dXJuIFdFUlJfRE5TX0VSUk9SX05BTUVfRE9FU19OT1RfRVhJ
U1Q7CisJCXdlcnIgPSBXRVJSX0ROU19FUlJPUl9OQU1FX0RPRVNfTk9UX0VYSVNUOworCQln
b3RvIGV4aXQ7CiAJfQogCiAJd2VyciA9IGRuc19jb21tb25fZXh0cmFjdChzYW1kYiwgZWws
IG1lbV9jdHgsIHJlY29yZHMsIG51bV9yZWNvcmRzKTsKIAlUQUxMT0NfRlJFRShtc2cpOwog
CWlmICghV19FUlJPUl9JU19PSyh3ZXJyKSkgewogCQlyZXR1cm4gd2VycjsKKwkJZ290byBl
eGl0OwogCX0KIAotCXJldHVybiBXRVJSX09LOworCXdlcnIgPSBXRVJSX09LOworZXhpdDoK
KwlkbnNfY29tbW9uX2xvZ19vcGVyYXRpb24oCisJCSJ3aWxkY2FyZF9sb29rdXAiLAorCQl3
aW5fZXJyc3RyKHdlcnIpLAorCQkmc3RhcnQsCisJCU5VTEwsCisJCWxkYl9kbl9nZXRfbGlu
ZWFyaXplZChkbiksCisJCU5VTEwpOworCXJldHVybiB3ZXJyOwogfQogCiBzdGF0aWMgaW50
IHJlY19jbXAoY29uc3Qgc3RydWN0IGRuc3BfRG5zc3J2UnBjUmVjb3JkICpyMSwKQEAgLTg5
NCw2ICs5MjUsNyBAQCBXRVJST1IgZG5zX2NvbW1vbl9yZXBsYWNlKHN0cnVjdCBsZGJfY29u
dGV4dCAqc2FtZGIsCiAJCQkgIHN0cnVjdCBkbnNwX0Ruc3NydlJwY1JlY29yZCAqcmVjb3Jk
cywKIAkJCSAgdWludDE2X3QgcmVjX2NvdW50KQogeworCWNvbnN0IHN0cnVjdCB0aW1ldmFs
IHN0YXJ0ID0gdGltZXZhbF9jdXJyZW50KCk7CiAJc3RydWN0IGxkYl9tZXNzYWdlX2VsZW1l
bnQgKmVsOwogCXVpbnQxNl90IGk7CiAJaW50IHJldDsKQEAgLTkxMiwxNCArOTQ0LDE3IEBA
IFdFUlJPUiBkbnNfY29tbW9uX3JlcGxhY2Uoc3RydWN0IGxkYl9jb250ZXh0ICpzYW1kYiwK
IAogCXpvbmVfZG4gPSBsZGJfZG5fY29weShtZW1fY3R4LCBkbik7CiAJaWYgKHpvbmVfZG4g
PT0gTlVMTCkgewotCQlyZXR1cm4gV0VSUl9OT1RfRU5PVUdIX01FTU9SWTsKKwkJd2VyciA9
IFdFUlJfTk9UX0VOT1VHSF9NRU1PUlk7CisJCWdvdG8gZXhpdDsKIAl9CiAJaWYgKCFsZGJf
ZG5fcmVtb3ZlX2NoaWxkX2NvbXBvbmVudHMoem9uZV9kbiwgMSkpIHsKLQkJcmV0dXJuIERO
U19FUlIoU0VSVkVSX0ZBSUxVUkUpOworCQl3ZXJyID0gRE5TX0VSUihTRVJWRVJfRkFJTFVS
RSk7CisJCWdvdG8gZXhpdDsKIAl9CiAJem9uZWluZm8gPSB0YWxsb2MobWVtX2N0eCwgc3Ry
dWN0IGRuc3NlcnZlcl96b25laW5mbyk7CiAJaWYgKHpvbmVpbmZvID09IE5VTEwpIHsKLQkJ
cmV0dXJuIFdFUlJfTk9UX0VOT1VHSF9NRU1PUlk7CisJCXdlcnIgPSBXRVJSX05PVF9FTk9V
R0hfTUVNT1JZOworCQlnb3RvIGV4aXQ7CiAJfQogCXdlcnIgPSBkbnNfZ2V0X3pvbmVfcHJv
cGVydGllcyhzYW1kYiwgbWVtX2N0eCwgem9uZV9kbiwgem9uZWluZm8pOwogCWlmIChXX0VS
Uk9SX0VRVUFMKEROU19FUlIoTk9UWk9ORSksIHdlcnIpKSB7CkBAIC05MjksMTcgKzk2NCwx
OCBAQCBXRVJST1IgZG5zX2NvbW1vbl9yZXBsYWNlKHN0cnVjdCBsZGJfY29udGV4dCAqc2Ft
ZGIsCiAJCSAqLwogCQl6b25laW5mby0+ZkFnaW5nID0gMDsKIAl9IGVsc2UgaWYgKCFXX0VS
Uk9SX0lTX09LKHdlcnIpKSB7Ci0JCXJldHVybiB3ZXJyOworCQlnb3RvIGV4aXQ7CiAJfQog
CiAJd2VyciA9IGNoZWNrX25hbWVfbGlzdChtZW1fY3R4LCByZWNfY291bnQsIHJlY29yZHMp
OwogCWlmICghV19FUlJPUl9JU19PSyh3ZXJyKSkgewotCQlyZXR1cm4gd2VycjsKKwkJZ290
byBleGl0OwogCX0KIAogCXJldCA9IGxkYl9tc2dfYWRkX2VtcHR5KG1zZywgImRuc1JlY29y
ZCIsIExEQl9GTEFHX01PRF9SRVBMQUNFLCAmZWwpOwogCWlmIChyZXQgIT0gTERCX1NVQ0NF
U1MpIHsKLQkJcmV0dXJuIEROU19FUlIoU0VSVkVSX0ZBSUxVUkUpOworCQl3ZXJyID0gRE5T
X0VSUihTRVJWRVJfRkFJTFVSRSk7CisJCWdvdG8gZXhpdDsKIAl9CiAKIAkvKgpAQCAtOTQ4
LDcgKzk4NCwxMCBAQCBXRVJST1IgZG5zX2NvbW1vbl9yZXBsYWNlKHN0cnVjdCBsZGJfY29u
dGV4dCAqc2FtZGIsCiAJICovCiAJZWwtPnZhbHVlcyA9IHRhbGxvY196ZXJvX2FycmF5KGVs
LCBzdHJ1Y3QgbGRiX3ZhbCwgTUFYKDEsIHJlY19jb3VudCkpOwogCWlmIChyZWNfY291bnQg
PiAwKSB7Ci0JCVdfRVJST1JfSEFWRV9OT19NRU1PUlkoZWwtPnZhbHVlcyk7CisJCWlmIChl
bC0+dmFsdWVzID09IE5VTEwpIHsKKwkJCXdlcnIgPSBXRVJSX05PVF9FTk9VR0hfTUVNT1JZ
OworCQkJZ290byBleGl0OworCQl9CiAKIAkJLyoKIAkJICogV2Ugc3RvcmUgYSBzb3J0ZWQg
bGlzdCB3aXRoIHRoZSBoaWdoIHdUeXBlIHZhbHVlcyBmaXJzdApAQCAtOTg0LDI3ICsxMDIz
LDMyIEBAIFdFUlJPUiBkbnNfY29tbW9uX3JlcGxhY2Uoc3RydWN0IGxkYl9jb250ZXh0ICpz
YW1kYiwKIAkJCQkobmRyX3B1c2hfZmxhZ3NfZm5fdCluZHJfcHVzaF9kbnNwX0Ruc3NydlJw
Y1JlY29yZCk7CiAJCWlmICghTkRSX0VSUl9DT0RFX0lTX1NVQ0NFU1MobmRyX2VycikpIHsK
IAkJCURFQlVHKDAsICgiRmFpbGVkIHRvIHB1c2ggZG5zcF9EbnNzcnZScGNSZWNvcmRcbiIp
KTsKLQkJCXJldHVybiBETlNfRVJSKFNFUlZFUl9GQUlMVVJFKTsKKwkJCXdlcnIgPSBETlNf
RVJSKFNFUlZFUl9GQUlMVVJFKTsKKwkJCWdvdG8gZXhpdDsKIAkJfQogCQllbC0+bnVtX3Zh
bHVlcysrOwogCX0KIAogCWlmIChuZWVkc19hZGQpIHsKIAkJaWYgKGVsLT5udW1fdmFsdWVz
ID09IDApIHsKLQkJCXJldHVybiBXRVJSX09LOworCQkJd2VyciA9IFdFUlJfT0s7CisJCQln
b3RvIGV4aXQ7CiAJCX0KIAogCQlyZXQgPSBsZGJfbXNnX2FkZF9zdHJpbmcobXNnLCAib2Jq
ZWN0Q2xhc3MiLCAiZG5zTm9kZSIpOwogCQlpZiAocmV0ICE9IExEQl9TVUNDRVNTKSB7Ci0J
CQlyZXR1cm4gRE5TX0VSUihTRVJWRVJfRkFJTFVSRSk7CisJCQl3ZXJyID0gRE5TX0VSUihT
RVJWRVJfRkFJTFVSRSk7CisJCQlnb3RvIGV4aXQ7CiAJCX0KIAogCQlyZXQgPSBsZGJfYWRk
KHNhbWRiLCBtc2cpOwogCQlpZiAocmV0ICE9IExEQl9TVUNDRVNTKSB7Ci0JCQlyZXR1cm4g
RE5TX0VSUihTRVJWRVJfRkFJTFVSRSk7CisJCQl3ZXJyID0gRE5TX0VSUihTRVJWRVJfRkFJ
TFVSRSk7CisJCQlnb3RvIGV4aXQ7CiAJCX0KIAogCQlyZXR1cm4gV0VSUl9PSzsKKwkJZ290
byBleGl0OwogCX0KIAogCWlmIChlbC0+bnVtX3ZhbHVlcyA9PSAwKSB7CkBAIC0xMDE4LDcg
KzEwNjIsOCBAQCBXRVJST1IgZG5zX2NvbW1vbl9yZXBsYWNlKHN0cnVjdCBsZGJfY29udGV4
dCAqc2FtZGIsCiAJCQkgKiBUaGlzIGlzIGFscmVhZHkgYSB0b21ic3RvbmVkIG9iamVjdC4K
IAkJCSAqIEp1c3QgbGVhdmUgaXQgaW5zdGVhZCBvZiB1cGRhdGluZyB0aGUgdGltZSBzdGFt
cC4KIAkJCSAqLwotCQkJcmV0dXJuIFdFUlJfT0s7CisJCQl3ZXJyID0gV0VSUl9PSzsKKwkJ
CWdvdG8gZXhpdDsKIAkJfQogCiAJCXR2ID0gdGltZXZhbF9jdXJyZW50KCk7CkBAIC0xMDMy
LDcgKzEwNzcsOCBAQCBXRVJST1IgZG5zX2NvbW1vbl9yZXBsYWNlKHN0cnVjdCBsZGJfY29u
dGV4dCAqc2FtZGIsCiAJCQkJKG5kcl9wdXNoX2ZsYWdzX2ZuX3QpbmRyX3B1c2hfZG5zcF9E
bnNzcnZScGNSZWNvcmQpOwogCQlpZiAoIU5EUl9FUlJfQ09ERV9JU19TVUNDRVNTKG5kcl9l
cnIpKSB7CiAJCQlERUJVRygwLCAoIkZhaWxlZCB0byBwdXNoIGRuc3BfRG5zc3J2UnBjUmVj
b3JkXG4iKSk7Ci0JCQlyZXR1cm4gRE5TX0VSUihTRVJWRVJfRkFJTFVSRSk7CisJCQl3ZXJy
ID0gRE5TX0VSUihTRVJWRVJfRkFJTFVSRSk7CisJCQlnb3RvIGV4aXQ7CiAJCX0KIAkJZWwt
Pm51bV92YWx1ZXMrKzsKIApAQCAtMTA0MywyMyArMTA4OSwzNSBAQCBXRVJST1IgZG5zX2Nv
bW1vbl9yZXBsYWNlKHN0cnVjdCBsZGJfY29udGV4dCAqc2FtZGIsCiAJCXJldCA9IGxkYl9t
c2dfYWRkX2VtcHR5KG1zZywgImROU1RvbWJzdG9uZWQiLAogCQkJCQlMREJfRkxBR19NT0Rf
UkVQTEFDRSwgTlVMTCk7CiAJCWlmIChyZXQgIT0gTERCX1NVQ0NFU1MpIHsKLQkJCXJldHVy
biBETlNfRVJSKFNFUlZFUl9GQUlMVVJFKTsKKwkJCXdlcnIgPSBETlNfRVJSKFNFUlZFUl9G
QUlMVVJFKTsKKwkJCWdvdG8gZXhpdDsKIAkJfQogCiAJCXJldCA9IGxkYl9tc2dfYWRkX2Zt
dChtc2csICJkTlNUb21ic3RvbmVkIiwgIiVzIiwKIAkJCQkgICAgICBiZWNvbWVfdG9tYnN0
b25lZCA/ICJUUlVFIiA6ICJGQUxTRSIpOwogCQlpZiAocmV0ICE9IExEQl9TVUNDRVNTKSB7
Ci0JCQlyZXR1cm4gRE5TX0VSUihTRVJWRVJfRkFJTFVSRSk7CisJCQl3ZXJyID0gRE5TX0VS
UihTRVJWRVJfRkFJTFVSRSk7CisJCQlnb3RvIGV4aXQ7CiAJCX0KIAl9CiAKIAlyZXQgPSBs
ZGJfbW9kaWZ5KHNhbWRiLCBtc2cpOwogCWlmIChyZXQgIT0gTERCX1NVQ0NFU1MpIHsKIAkJ
TlRTVEFUVVMgbnQgPSBkc2RiX2xkYl9lcnJfdG9fbnRzdGF0dXMocmV0KTsKLQkJcmV0dXJu
IG50c3RhdHVzX3RvX3dlcnJvcihudCk7CisJCXdlcnIgPSBudHN0YXR1c190b193ZXJyb3Io
bnQpOworCQlnb3RvIGV4aXQ7CiAJfQogCi0JcmV0dXJuIFdFUlJfT0s7CisJd2VyciA9IFdF
UlJfT0s7CitleGl0OgorCWRuc19jb21tb25fbG9nX29wZXJhdGlvbigKKwkJInJlcGxhY2Ui
LAorCQl3aW5fZXJyc3RyKHdlcnIpLAorCQkmc3RhcnQsCisJCU5VTEwsCisJCWxkYl9kbl9n
ZXRfbGluZWFyaXplZChkbiksCisJCU5VTEwpOworCXJldHVybiB3ZXJyOwogfQogCiBib29s
IGRuc19uYW1lX21hdGNoKGNvbnN0IGNoYXIgKnpvbmUsIGNvbnN0IGNoYXIgKm5hbWUsIHNp
emVfdCAqaG9zdF9wYXJ0X2xlbikKQEAgLTEyMzEsMTIgKzEyODksMTQgQEAgTlRTVEFUVVMg
ZG5zX2NvbW1vbl96b25lcyhzdHJ1Y3QgbGRiX2NvbnRleHQgKnNhbWRiLAogCQkJICBzdHJ1
Y3QgbGRiX2RuICpiYXNlX2RuLAogCQkJICBzdHJ1Y3QgZG5zX3NlcnZlcl96b25lICoqem9u
ZXNfcmV0KQogeworCWNvbnN0IHN0cnVjdCB0aW1ldmFsIHN0YXJ0ID0gdGltZXZhbF9jdXJy
ZW50KCk7CiAJaW50IHJldDsKIAlzdGF0aWMgY29uc3QgY2hhciAqIGNvbnN0IGF0dHJzW10g
PSB7ICJuYW1lIiwgTlVMTH07CiAJc3RydWN0IGxkYl9yZXN1bHQgKnJlczsKIAlpbnQgaTsK
IAlzdHJ1Y3QgZG5zX3NlcnZlcl96b25lICpuZXdfbGlzdCA9IE5VTEw7CiAJVEFMTE9DX0NU
WCAqZnJhbWUgPSB0YWxsb2Nfc3RhY2tmcmFtZSgpOworCU5UU1RBVFVTIHJlc3VsdCA9IE5U
X1NUQVRVU19PSzsKIAogCWlmIChiYXNlX2RuKSB7CiAJCS8qIFRoaXMgc2VhcmNoIHdpbGwg
d29yayBhZ2FpbnN0IHdpbmRvd3MgKi8KQEAgLTEyNTMsNyArMTMxMyw4IEBAIE5UU1RBVFVT
IGRuc19jb21tb25fem9uZXMoc3RydWN0IGxkYl9jb250ZXh0ICpzYW1kYiwKIAl9CiAJaWYg
KHJldCAhPSBMREJfU1VDQ0VTUykgewogCQlUQUxMT0NfRlJFRShmcmFtZSk7Ci0JCXJldHVy
biBOVF9TVEFUVVNfSU5URVJOQUxfREJfQ09SUlVQVElPTjsKKwkJcmVzdWx0ID0gTlRfU1RB
VFVTX0lOVEVSTkFMX0RCX0NPUlJVUFRJT047CisJCWdvdG8gZXhpdDsKIAl9CiAKIAlUWVBF
U0FGRV9RU09SVChyZXMtPm1zZ3MsIHJlcy0+Y291bnQsIGRuc19jb21tb25fc29ydF96b25l
cyk7CkBAIC0xMjY0LDcgKzEzMjUsOCBAQCBOVFNUQVRVUyBkbnNfY29tbW9uX3pvbmVzKHN0
cnVjdCBsZGJfY29udGV4dCAqc2FtZGIsCiAJCXogPSB0YWxsb2NfemVybyhtZW1fY3R4LCBz
dHJ1Y3QgZG5zX3NlcnZlcl96b25lKTsKIAkJaWYgKHogPT0gTlVMTCkgewogCQkJVEFMTE9D
X0ZSRUUoZnJhbWUpOwotCQkJcmV0dXJuIE5UX1NUQVRVU19OT19NRU1PUlk7CisJCQlyZXN1
bHQgPSBOVF9TVEFUVVNfTk9fTUVNT1JZOworCQkJZ290byBleGl0OwogCQl9CiAKIAkJei0+
bmFtZSA9IGxkYl9tc2dfZmluZF9hdHRyX2FzX3N0cmluZyhyZXMtPm1zZ3NbaV0sICJuYW1l
IiwgTlVMTCk7CkBAIC0xMjg5LDcgKzEzNTEsMTYgQEAgTlRTVEFUVVMgZG5zX2NvbW1vbl96
b25lcyhzdHJ1Y3QgbGRiX2NvbnRleHQgKnNhbWRiLAogCiAJKnpvbmVzX3JldCA9IG5ld19s
aXN0OwogCVRBTExPQ19GUkVFKGZyYW1lKTsKLQlyZXR1cm4gTlRfU1RBVFVTX09LOworCXJl
c3VsdCA9IE5UX1NUQVRVU19PSzsKK2V4aXQ6CisJZG5zX2NvbW1vbl9sb2dfb3BlcmF0aW9u
KAorCQkiem9uZXMiLAorCQludF9lcnJzdHIocmVzdWx0KSwKKwkJJnN0YXJ0LAorCQlOVUxM
LAorCQliYXNlX2RuID09IE5VTEwgPyAiKG51bGwpIiA6IGxkYl9kbl9nZXRfbGluZWFyaXpl
ZChiYXNlX2RuKSwKKwkJTlVMTCk7CisJcmV0dXJuIHJlc3VsdDsKIH0KIAogLyoKQEAgLTEz
MTEsMyArMTM4MiwzMCBAQCBib29sIGRuc19uYW1lX2VxdWFsKGNvbnN0IGNoYXIgKm5hbWUx
LCBjb25zdCBjaGFyICpuYW1lMikKIAl9CiAJcmV0dXJuIHN0cm5jYXNlY21wKG5hbWUxLCBu
YW1lMiwgbGVuMSkgPT0gMDsKIH0KKworLyoKKyAqIExvZyBhIEROUyBvcGVyYXRpb24gYWxv
bmcgd2l0aCBpdCdzIGR1cmF0aW9uCisgKiBFbmFibGVkIGJ5IHNldHRpbmcgYSBsb2cgbGV2
ZWwgb2YgImRuczoxMCIKKyAqCisgKi8KK3ZvaWQgZG5zX2NvbW1vbl9sb2dfb3BlcmF0aW9u
KGNvbnN0IGNoYXIgKm9wZXJhdGlvbiwKKwkJCSAgICAgIGNvbnN0IGNoYXIgKnJlc3VsdCwK
KwkJCSAgICAgIGNvbnN0IHN0cnVjdCB0aW1ldmFsICpzdGFydCwKKwkJCSAgICAgIGNvbnN0
IGNoYXIgKnpvbmUsCisJCQkgICAgICBjb25zdCBjaGFyICpuYW1lLAorCQkJICAgICAgY29u
c3QgY2hhciAqZGF0YSkKK3sKKwlpZiAoQ0hFQ0tfREVCVUdMVkxDKERCR0NfRE5TLCBEQkdM
VkxfREVCVUcpKSB7CisJCXN0cnVjdCB0aW1ldmFsIG5vdyA9IHRpbWV2YWxfY3VycmVudCgp
OworCQl1aW50NjRfdCBkdXJhdGlvbiA9IHVzZWNfdGltZV9kaWZmKCZub3csIHN0YXJ0KTsK
KwkJREJHX0RFQlVHKAorCQkJIlslc10gcmVzdWx0OiBbJXNdIGR1cmF0aW9uOiAoJSIgUFJJ
aTY0ICIpICIKKwkJCSJ6b25lOiBbJXNdIG5hbWU6IFslc10gZGF0YTogWyVzXVxuIiwKKwkJ
CW9wZXJhdGlvbiwKKwkJCXJlc3VsdCwKKwkJCWR1cmF0aW9uLAorCQkJem9uZSwKKwkJCW5h
bWUsCisJCQlkYXRhKTsKKwl9Cit9CmRpZmYgLS1naXQgYS9zb3VyY2U0L2Ruc19zZXJ2ZXIv
ZG5zc2VydmVyX2NvbW1vbi5oIGIvc291cmNlNC9kbnNfc2VydmVyL2Ruc3NlcnZlcl9jb21t
b24uaAppbmRleCA2MGVjZGU0ZmE5MS4uMWQ3Y2QxYzAwMmMgMTAwNjQ0Ci0tLSBhL3NvdXJj
ZTQvZG5zX3NlcnZlci9kbnNzZXJ2ZXJfY29tbW9uLmgKKysrIGIvc291cmNlNC9kbnNfc2Vy
dmVyL2Ruc3NlcnZlcl9jb21tb24uaApAQCAtOTAsNCArOTAsMTAgQEAgTlRTVEFUVVMgZG5z
X2NvbW1vbl96b25lcyhzdHJ1Y3QgbGRiX2NvbnRleHQgKnNhbWRiLAogCiBib29sIGRuc196
b25laW5mb19sb2FkX3pvbmVfcHJvcGVydHkoc3RydWN0IGRuc3NlcnZlcl96b25laW5mbyAq
em9uZWluZm8sCiAJCQkJICAgICBzdHJ1Y3QgZG5zcF9EbnNQcm9wZXJ0eSAqcHJvcCk7Cit2
b2lkIGRuc19jb21tb25fbG9nX29wZXJhdGlvbihjb25zdCBjaGFyICpvcGVyYXRpb24sCisJ
CQkgICAgICBjb25zdCBjaGFyICpyZXN1bHQsCisJCQkgICAgICBjb25zdCBzdHJ1Y3QgdGlt
ZXZhbCAqc3RhcnQsCisJCQkgICAgICBjb25zdCBjaGFyICp6b25lLAorCQkJICAgICAgY29u
c3QgY2hhciAqbmFtZSwKKwkJCSAgICAgIGNvbnN0IGNoYXIgKmRhdGEpOwogI2VuZGlmIC8q
IF9fRE5TU0VSVkVSX0NPTU1PTl9IX18gKi8KLS0gCjIuMTguMQoK
--------------14DA0F0A1246DDD1E50C0013--

--VtRtCG7mmJCtIJNUTcQo40d1y7qlfWZIU--

--CgKshLslqwmZ8mna9BATFSygSXvZfq4OE
Content-Type: application/pgp-signature; name="signature.asc"
Content-Description: OpenPGP digital signature
Content-Disposition: attachment; filename="signature.asc"

-----BEGIN PGP SIGNATURE-----

iQEzBAEBCgAdFiEEDO84T/PRptSsMEixei/9ZKIyR1MFAlzPYjcACgkQei/9ZKIy
R1OSYQf/T+KhFR8TRrO9JTqkupSAV6SMH/AnqcIw5AzkPS6kymNGbFMnH6bJQB0D
QJKzBvpuoTcB1qkCiYlMElRzcl1wIGEMttEeW00JO1aYxLbCnPFhf2WeX7yRDY4x
cnqNpQT1QI99DgJ/f4ts0IlnoWKiAxbr29t60EYmb76W91fpfOtVBLfK91eI/DqG
91GPmxHWOZIEf8dKki8LoAcBcdhcZ01i7T4f8eSMbfELyuj637R+62EHEjDabdyf
SYgOZRBk901bK9YkUGAz5eWbrSE6H4VRDNcYed6kjZVrF/CXhLpIm+/rCmui12xk
vkxNw+IVhTzmt4a537Vp+ryM695HYA==
=vRIH
-----END PGP SIGNATURE-----

--CgKshLslqwmZ8mna9BATFSygSXvZfq4OE--

