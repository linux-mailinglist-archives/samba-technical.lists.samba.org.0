Return-Path: <samba-technical-bounces@lists.samba.org>
X-Original-To: lists+samba-technical@lfdr.de
Delivered-To: lists+samba-technical@lfdr.de
Received: from hr1.samba.org (hr1.samba.org [IPv6:2a01:4f8:192:486::1:0])
	by mail.lfdr.de (Postfix) with ESMTPS id C29631A6181
	for <lists+samba-technical@lfdr.de>; Mon, 13 Apr 2020 04:24:52 +0200 (CEST)
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
	d=lists.samba.org; s=2954282; h=Cc:From:List-Id:To:Subject:Date;
	bh=wuZfNn8fJ5MfrbpASmHdYV51l0a/j2mZhF3GNeqjeyQ=; b=4PeGtcskPW7+x5+pXfpIH8xxtg
	dFuXub4MQ6yyWJKcFcDFqI6POfRXMCk9h4QughrlJgAbSpZhRbculNQAJmOOz4oGIvHxYtEe5WCL9
	uJSHqZRhPZ2U6rynSL/cIlHKx9MCRVD0q1+0fXDfe1adK3P3wWCGEPRiti5Z56BZav4L7mrUb4FNV
	MpH8EoLbKO7RzzMsDeXFAPmQI42VJv/i8s9iFX2ChEwaKctl4yFOqbFkhg9wRZa4zF9w6ABxBQbwe
	tU76DhJfS921J4LI5okPBayUjEMv3HMMZX8I2RUI1a7BQ96wFHtBL1jGG+r3NMH1emyxx6+NwXDPA
	KQ0BI4cA==;
Received: from localhost ([::1]:44060 helo=hr1.samba.org) 
	by hr1.samba.org with esmtp (Exim)
	id 1jNolF-000aTY-3M; Mon, 13 Apr 2020 02:23:45 +0000
Received: from mail-qv1-xf2b.google.com ([2607:f8b0:4864:20::f2b]:35827) 
 by hr1.samba.org with esmtps (TLS1.3:ECDHE_RSA_CHACHA20_POLY1305:256)
 (Exim) id 1jNol8-000aTR-LU
 for samba-technical@lists.samba.org; Mon, 13 Apr 2020 02:23:41 +0000
Received: by mail-qv1-xf2b.google.com with SMTP id q73so3789421qvq.2
 for <samba-technical@lists.samba.org>; Sun, 12 Apr 2020 19:23:38 -0700 (PDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=qnap.com; s=google;
 h=mime-version:references:in-reply-to:from:date:message-id:subject:to
 :cc; bh=ifp4C6U5p70UZeVGLKYhFIijC6BDeTbz5O2MpPnEDOU=;
 b=i4qEQCaUVZb78XR17jsKse+J+f+GK+CcPr4/GS5u/yM2ktHuoV4H3mH7jiZkbhlbIj
 PvkPbsGBJCds4Vo56i4QMHvXYnjbqKSYVGgx2oV0onlAqk2c0VavJzhTzSD+uVSoDJv4
 XTNtG2noKUr8mgtI2UymddjAoM2xvvkHq//uY=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=1e100.net; s=20161025;
 h=x-gm-message-state:mime-version:references:in-reply-to:from:date
 :message-id:subject:to:cc;
 bh=ifp4C6U5p70UZeVGLKYhFIijC6BDeTbz5O2MpPnEDOU=;
 b=Tzn2TpP6g3zrKwPDqRL1lGCgTdgZwbN06ac8A0Kkx/1PRR4pwW4aLM7QToTwutbLHQ
 op5McR/I+/66OanjICL0+ZBGRPXHOLIUo4EDtdJdq3RIV48+X4+g+vIxtTHpfmBySokR
 8T3w1DtTXMFqQtNtKH5LG3lXgJI3BvaWfNooUMSobwQsmR9I7pV+0AK03d0bXLMvin9O
 jltdFyRjkDkazvHVPGWA2gYaPkMUkjCYAofm1nPWhGb3MBiDHCJpVA+EpywYzhigtMyQ
 T+SP2EQ36rg3vS7CnG996f08eQRWnUPiZm3d0QhRHfc4aGRavdPRprQ8vEpA/tgRScFB
 VErg==
X-Gm-Message-State: AGi0PuZi8lwTx5xW+YROib6mi2tEvKDBdkocCBOox1y0/l9n1nGmbZCH
 T5ouXsDGvjLvh2esiSwrkKCYZrGjEfeoKXs8D2cHdQ==
X-Google-Smtp-Source: APiQypKalBVLfCWtQM/rDJZOaI+7XFotkSej8kX9ET0uFa9OzcDCutAJp8qeR6q2aqCLWge7qVwQQky2QUGlIbiGuLQ=
X-Received: by 2002:a0c:ba9b:: with SMTP id x27mr15805477qvf.194.1586744616459; 
 Sun, 12 Apr 2020 19:23:36 -0700 (PDT)
MIME-Version: 1.0
References: <CAEUGjKiLPQP9wp0AgLUvHgKBOe9We2a-RQaZ7cd7CvhnarwWiw@mail.gmail.com>
 <CAKywueT0Q9WkANNsg8cEDwGZSMaaE5c4LHuEeMhVDzJAzycroQ@mail.gmail.com>
In-Reply-To: <CAKywueT0Q9WkANNsg8cEDwGZSMaaE5c4LHuEeMhVDzJAzycroQ@mail.gmail.com>
Date: Mon, 13 Apr 2020 10:23:25 +0800
Message-ID: <CAEUGjKhSBNQboKOMFMgos9OQfxcLQZsXp8aBrUSFcaSe1saH2Q@mail.gmail.com>
Subject: Re: [PATCH] cifs: improve read performance for page size 64KB &
 cache=strict & vers=2.1+
To: Pavel Shilovsky <piastryyy@gmail.com>
Content-Type: multipart/mixed; boundary="00000000000036d2a305a322c5dd"
X-Content-Filtered-By: Mailman/MimeDel 2.1.29
X-BeenThere: samba-technical@lists.samba.org
X-Mailman-Version: 2.1.29
Precedence: list
List-Id: "Discussions on Samba internals. For general questions please
 subscribe to the list samba@lists.samba.org"
 <samba-technical.lists.samba.org>
List-Unsubscribe: <https://lists.samba.org/mailman/options/samba-technical>,
 <mailto:samba-technical-request@lists.samba.org?subject=unsubscribe>
List-Archive: <http://lists.samba.org/pipermail/samba-technical/>
List-Post: <mailto:samba-technical@lists.samba.org>
List-Help: <mailto:samba-technical-request@lists.samba.org?subject=help>
List-Subscribe: <https://lists.samba.org/mailman/listinfo/samba-technical>,
 <mailto:samba-technical-request@lists.samba.org?subject=subscribe>
From: Jones Syue via samba-technical <samba-technical@lists.samba.org>
Reply-To: Jones Syue <jonessyue@qnap.com>
Cc: linux-cifs <linux-cifs@vger.kernel.org>,
 Samba Technical <samba-technical@lists.samba.org>,
 Kernel Mailing List <linux-kernel@vger.kernel.org>
Errors-To: samba-technical-bounces@lists.samba.org
Sender: "samba-technical" <samba-technical-bounces@lists.samba.org>

--00000000000036d2a305a322c5dd
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable

Hello Pavel

Thanks for kindly reviewing!
Please find the attached v2.patch.

--
Regards,
Jones Syue | =E8=96=9B=E6=87=B7=E5=AE=97
QNAP Systems, Inc.


On Sat, Apr 11, 2020 at 2:25 AM Pavel Shilovsky <piastryyy@gmail.com> wrote=
:
>
> Hi Jones,
>
> Thanks for the patch!
>
> It will work although it is probably a little bit cleaner to
> initialize server->max_read to server->maxBuf for SMB1 and use the
> server->max_read in the readpages condition check instead.
>
> @Others, thoughts?
>
> --
> Best regards,
> Pavel Shilovsky

--00000000000036d2a305a322c5dd
Content-Type: application/octet-stream; name="v2.patch"
Content-Disposition: attachment; filename="v2.patch"
Content-Transfer-Encoding: base64
Content-ID: <f_k8xup7700>
X-Attachment-Id: f_k8xup7700

RnJvbSBkODc0M2M4NzI2YTQ3MjcxODdmM2I5MTNjNzU5MjQyYzIzMjVhZWNlIE1vbiBTZXAgMTcg
MDA6MDA6MDAgMjAwMQpGcm9tOiBKb25lcyBTeXVlIDxqb25lc3N5dWVAcW5hcC5jb20+CkRhdGU6
IE1vbiwgMTMgQXByIDIwMjAgMDk6Mzc6MjMgKzA4MDAKU3ViamVjdDogW1BBVENIXSBjaWZzOiBp
bXByb3ZlIHJlYWQgcGVyZm9ybWFuY2UgZm9yIHBhZ2Ugc2l6ZSA2NEtCICYKIGNhY2hlPXN0cmlj
dCAmIHZlcnM9Mi4xKwpNSU1FLVZlcnNpb246IDEuMApDb250ZW50LVR5cGU6IHRleHQvcGxhaW47
IGNoYXJzZXQ9VVRGLTgKQ29udGVudC1UcmFuc2Zlci1FbmNvZGluZzogOGJpdAoKRm91bmQgYSBy
ZWFkIHBlcmZvcm1hbmNlIGlzc3VlIHdoZW4gbGludXgga2VybmVsIHBhZ2Ugc2l6ZSBpcyA2NEtC
LgpJZiBsaW51eCBrZXJuZWwgcGFnZSBzaXplIGlzIDY0S0IgYW5kIG1vdW50IG9wdGlvbnMgY2Fj
aGU9c3RyaWN0ICYKdmVycz0yLjErLCBpdCBkb2VzIG5vdCBzdXBwb3J0IGNpZnNfcmVhZHBhZ2Vz
KCkuIEluc3RlYWQsIGl0IGlzIHVzaW5nCmNpZnNfcmVhZHBhZ2UoKSBhbmQgY2lmc19yZWFkKCkg
d2l0aCBtYXhpbXVtIHJlYWQgSU8gc2l6ZSAxNktCLCB3aGljaCBpcwptdWNoIHNsb3dlciB0aGFu
IHJlYWQgSU8gc2l6ZSAxTUIgd2hlbiBuZWdvdGlhdGVkIFNNQiAyLjErLiBTaW5jZSBtb2Rlcm4K
U01CIHNlcnZlciBzdXBwb3J0ZWQgU01CIDIuMSsgYW5kIE1heCBSZWFkIFNpemUgY2FuIHJlYWNo
IG1vcmUgdGhhbiA2NEtCCihmb3IgZXhhbXBsZSAxTUIgfiA4TUIpLCB0aGlzIHBhdGNoIGNoZWNr
IG1heF9yZWFkIGluc3RlYWQgb2YgbWF4QnVmIHRvCmRldGVybWluZSB3aGV0aGVyIHNlcnZlciBz
dXBwb3J0IHJlYWRwYWdlcygpIGFuZCBpbXByb3ZlIHJlYWQgcGVyZm9ybWFuY2UKZm9yIHBhZ2Ug
c2l6ZSA2NEtCICYgY2FjaGU9c3RyaWN0ICYgdmVycz0yLjErLCBhbmQgZm9yIFNNQjEgaXQgaXMg
bW9yZQpjbGVhbmVyIHRvIGluaXRpYWxpemUgc2VydmVyLT5tYXhfcmVhZCB0byBzZXJ2ZXItPm1h
eEJ1Zi4KClRoZSBjbGllbnQgaXMgYSBsaW51eCBib3ggd2l0aCBsaW51eCBrZXJuZWwgNC4yLjgs
CnBhZ2Ugc2l6ZSA2NEtCIChDT05GSUdfQVJNNjRfNjRLX1BBR0VTPXkpLApjcHUgYXJtIDEuN0dI
eiwgYW5kIHVzZSBtb3VudC5jaWZzIGFzIHNtYiBjbGllbnQuClRoZSBzZXJ2ZXIgaXMgYW5vdGhl
ciBsaW51eCBib3ggd2l0aCBsaW51eCBrZXJuZWwgNC4yLjgsCnNoYXJlIGEgZmlsZSAnMTBHLmlt
Zycgd2l0aCBzaXplIDEwR0IsCmFuZCB1c2Ugc2FtYmEtNC43LjEyIGFzIHNtYiBzZXJ2ZXIuCgpU
aGUgY2xpZW50IG1vdW50IGEgc2hhcmUgZnJvbSB0aGUgc2VydmVyIHdpdGggZGlmZmVyZW50CmNh
Y2hlIG9wdGlvbnM6IGNhY2hlPXN0cmljdCBhbmQgY2FjaGU9bm9uZSwKbW91bnQgLXRjaWZzIC8v
PHNlcnZlcl9pcD4vUHVibGljIC9jYWNoZV9zdHJpY3QgLW92ZXJzPTMuMCxjYWNoZT1zdHJpY3Qs
dXNlcm5hbWU9PHh4eD4scGFzc3dvcmQ9PHl5eT4KbW91bnQgLXRjaWZzIC8vPHNlcnZlcl9pcD4v
UHVibGljIC9jYWNoZV9ub25lIC1vdmVycz0zLjAsY2FjaGU9bm9uZSx1c2VybmFtZT08eHh4Pixw
YXNzd29yZD08eXl5PgoKVGhlIGNsaWVudCBkb3dubG9hZCBhIDEwR2JFIGZpbGUgZnJvbSB0aGUg
c2VydmVyIGFjY3Jvc3MgMUdiRSBuZXR3b3JrLApkZCBpZj0vY2FjaGVfc3RyaWN0LzEwRy5pbWcg
b2Y9L2Rldi9udWxsIGJzPTFNIGNvdW50PTEwMjQwCmRkIGlmPS9jYWNoZV9ub25lLzEwRy5pbWcg
b2Y9L2Rldi9udWxsIGJzPTFNIGNvdW50PTEwMjQwCgpGb3VuZCB0aGF0IGNhY2hlPXN0cmljdCAo
d2l0aG91dCBwYXRjaCkgaXMgc2xvd2VyIHJlYWQgdGhyb3VnaHB1dCBhbmQKc21hbGxlciByZWFk
IElPIHNpemUgdGhhbiBjYWNoZT1ub25lLgpjYWNoZT1zdHJpY3QgKHdpdGhvdXQgcGF0Y2gpOiBy
ZWFkIHRocm91Z2hwdXQgNDBNQi9zLCByZWFkIElPIHNpemUgaXMgMTZLQgpjYWNoZT1zdHJpY3Qg
KHdpdGggcGF0Y2gpOiByZWFkIHRocm91Z2hwdXQgMTEzTUIvcywgcmVhZCBJTyBzaXplIGlzIDFN
QgpjYWNoZT1ub25lOiByZWFkIHRocm91Z2hwdXQgMTA5TUIvcywgcmVhZCBJTyBzaXplIGlzIDFN
QgoKTG9va3MgbGlrZSBpZiBwYWdlIHNpemUgaXMgNjRLQiwKY2lmc19zZXRfb3BzKCkgd291bGQg
dXNlIGNpZnNfYWRkcl9vcHNfc21hbGxidWYgaW5zdGVhZCBvZiBjaWZzX2FkZHJfb3BzLAoKCS8q
IGNoZWNrIGlmIHNlcnZlciBjYW4gc3VwcG9ydCByZWFkcGFnZXMgKi8KCWlmIChjaWZzX3NiX21h
c3Rlcl90Y29uKGNpZnNfc2IpLT5zZXMtPnNlcnZlci0+bWF4QnVmIDwKCQkJUEFHRV9TSVpFICsg
TUFYX0NJRlNfSERSX1NJWkUpCgkJaW5vZGUtPmlfZGF0YS5hX29wcyA9ICZjaWZzX2FkZHJfb3Bz
X3NtYWxsYnVmOwoJZWxzZQoJCWlub2RlLT5pX2RhdGEuYV9vcHMgPSAmY2lmc19hZGRyX29wczsK
Cm1heEJ1ZiBpcyBjYW1lIGZyb20gMiBwbGFjZXMsIFNNQjJfbmVnb3RpYXRlKCkgYW5kIENJRlNT
TUJOZWdvdGlhdGUoKSwKKFNNQjJfTUFYX0JVRkZFUl9TSVpFIGlzIDY0S0IpClNNQjJfbmVnb3Rp
YXRlKCk6CgkvKiBzZXQgaXQgdG8gdGhlIG1heGltdW0gYnVmZmVyIHNpemUgdmFsdWUgd2UgY2Fu
IHNlbmQgd2l0aCAxIGNyZWRpdCAqLwoJc2VydmVyLT5tYXhCdWYgPSBtaW5fdCh1bnNpZ25lZCBp
bnQsIGxlMzJfdG9fY3B1KHJzcC0+TWF4VHJhbnNhY3RTaXplKSwKCQkJIMKgIMKgIMKgIFNNQjJf
TUFYX0JVRkZFUl9TSVpFKTsKQ0lGU1NNQk5lZ290aWF0ZSgpOgoJc2VydmVyLT5tYXhCdWYgPSBs
ZTMyX3RvX2NwdShwU01Cci0+TWF4QnVmZmVyU2l6ZSk7CgpQYWdlIHNpemUgNjRLQiBhbmQgY2Fj
aGU9c3RyaWN0IGxlYWQgdG8gcmVhZF9wYWdlcygpIHVzZSBjaWZzX3JlYWRwYWdlKCkKaW5zdGVh
ZCBvZiBjaWZzX3JlYWRwYWdlcygpLCBhbmQgdGhlbiBjaWZzX3JlYWQoKSB1c2luZyBtYXhpbXVt
IHJlYWQgSU8Kc2l6ZSAxNktCLCB3aGljaCBpcyBtdWNoIHNsb3dlciB0aGFuIG1heGltdW0gcmVh
ZCBJTyBzaXplIDFNQi4KKENJRlNNYXhCdWZTaXplIGlzIDE2S0IgYnkgZGVmYXVsdCkKCgkvKiBG
SVhNRTogc2V0IHVwIGhhbmRsZXJzIGZvciBsYXJnZXIgcmVhZHMgYW5kL29yIGNvbnZlcnQgdG8g
YXN5bmMgKi8KCXJzaXplID0gbWluX3QodW5zaWduZWQgaW50LCBjaWZzX3NiLT5yc2l6ZSwgQ0lG
U01heEJ1ZlNpemUpOwoKU2lnbmVkLW9mZi1ieTogSm9uZXMgU3l1ZSA8am9uZXNzeXVlQHFuYXAu
Y29tPgotLS0KIGZzL2NpZnMvY2lmc3NtYi5jIHwgNCArKysrCiBmcy9jaWZzL2lub2RlLmMgICB8
IDIgKy0KIDIgZmlsZXMgY2hhbmdlZCwgNSBpbnNlcnRpb25zKCspLCAxIGRlbGV0aW9uKC0pCgpk
aWZmIC0tZ2l0IGEvZnMvY2lmcy9jaWZzc21iLmMgYi9mcy9jaWZzL2NpZnNzbWIuYwppbmRleCA2
ZjZmYjM2Li5jZmVmMDJiIDEwMDY0NAotLS0gYS9mcy9jaWZzL2NpZnNzbWIuYworKysgYi9mcy9j
aWZzL2NpZnNzbWIuYwpAQCAtNTgzLDYgKzU4Myw4IEBAIGRlY29kZV9sYW5tYW5fbmVncHJvdF9y
c3Aoc3RydWN0IFRDUF9TZXJ2ZXJfSW5mbyAqc2VydmVyLCBORUdPVElBVEVfUlNQICpwU01CcikK
IAkJCSAgICAgICBjaWZzX21heF9wZW5kaW5nKTsKIAlzZXRfY3JlZGl0cyhzZXJ2ZXIsIHNlcnZl
ci0+bWF4UmVxKTsKIAlzZXJ2ZXItPm1heEJ1ZiA9IGxlMTZfdG9fY3B1KHJzcC0+TWF4QnVmU2l6
ZSk7CisJLyogc2V0IHVwIG1heF9yZWFkIGZvciByZWFkcGFnZXMgY2hlY2sgKi8KKwlzZXJ2ZXIt
Pm1heF9yZWFkID0gc2VydmVyLT5tYXhCdWY7CiAJLyogZXZlbiB0aG91Z2ggd2UgZG8gbm90IHVz
ZSByYXcgd2UgbWlnaHQgYXMgd2VsbCBzZXQgdGhpcwogCWFjY3VyYXRlbHksIGluIGNhc2Ugd2Ug
ZXZlciBmaW5kIGEgbmVlZCBmb3IgaXQgKi8KIAlpZiAoKGxlMTZfdG9fY3B1KHJzcC0+UmF3TW9k
ZSkgJiBSQVdfRU5BQkxFKSA9PSBSQVdfRU5BQkxFKSB7CkBAIC03NDQsNiArNzQ2LDggQEAgQ0lG
U1NNQk5lZ290aWF0ZShjb25zdCB1bnNpZ25lZCBpbnQgeGlkLCBzdHJ1Y3QgY2lmc19zZXMgKnNl
cykKIAlzZXRfY3JlZGl0cyhzZXJ2ZXIsIHNlcnZlci0+bWF4UmVxKTsKIAkvKiBwcm9iYWJseSBu
byBuZWVkIHRvIHN0b3JlIGFuZCBjaGVjayBtYXh2Y3MgKi8KIAlzZXJ2ZXItPm1heEJ1ZiA9IGxl
MzJfdG9fY3B1KHBTTUJyLT5NYXhCdWZmZXJTaXplKTsKKwkvKiBzZXQgdXAgbWF4X3JlYWQgZm9y
IHJlYWRwYWdlcyBjaGVjayAqLworCXNlcnZlci0+bWF4X3JlYWQgPSBzZXJ2ZXItPm1heEJ1ZjsK
IAlzZXJ2ZXItPm1heF9ydyA9IGxlMzJfdG9fY3B1KHBTTUJyLT5NYXhSYXdTaXplKTsKIAljaWZz
X2RiZyhOT0lTWSwgIk1heCBidWYgPSAlZFxuIiwgc2VzLT5zZXJ2ZXItPm1heEJ1Zik7CiAJc2Vy
dmVyLT5jYXBhYmlsaXRpZXMgPSBsZTMyX3RvX2NwdShwU01Cci0+Q2FwYWJpbGl0aWVzKTsKZGlm
ZiAtLWdpdCBhL2ZzL2NpZnMvaW5vZGUuYyBiL2ZzL2NpZnMvaW5vZGUuYwppbmRleCBiMTZmOGQy
Li5iMmViYTY3IDEwMDY0NAotLS0gYS9mcy9jaWZzL2lub2RlLmMKKysrIGIvZnMvY2lmcy9pbm9k
ZS5jCkBAIC02MSw3ICs2MSw3IEBAIHN0YXRpYyB2b2lkIGNpZnNfc2V0X29wcyhzdHJ1Y3QgaW5v
ZGUgKmlub2RlKQogCQl9CiAKIAkJLyogY2hlY2sgaWYgc2VydmVyIGNhbiBzdXBwb3J0IHJlYWRw
YWdlcyAqLwotCQlpZiAoY2lmc19zYl9tYXN0ZXJfdGNvbihjaWZzX3NiKS0+c2VzLT5zZXJ2ZXIt
Pm1heEJ1ZiA8CisJCWlmIChjaWZzX3NiX21hc3Rlcl90Y29uKGNpZnNfc2IpLT5zZXMtPnNlcnZl
ci0+bWF4X3JlYWQgPAogCQkJCVBBR0VfU0laRSArIE1BWF9DSUZTX0hEUl9TSVpFKQogCQkJaW5v
ZGUtPmlfZGF0YS5hX29wcyA9ICZjaWZzX2FkZHJfb3BzX3NtYWxsYnVmOwogCQllbHNlCi0tIAoy
LjEuNAoK
--00000000000036d2a305a322c5dd--

